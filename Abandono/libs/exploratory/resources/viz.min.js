var VizUtil=function(){var res={};var Column={};Column.OperationType={NONE:"none",SUM:"sum",GROUPBY:"groupby",GROUPBY_SUM:"gbysum",DISTINCT:"distinct",COUNT:"count",COUNT_DISTINCT:"countd",AVERAGE:"ave",MEDIAN:"median",MIN:"min",MAX:"max",FIRST:"first",FIRST_EXCLUDE_NA:"first_narm",LAST:"last",LAST_EXCLUDE_NA:"last_narm",VAR:"var",SD1:"sd",SD2:"sd2",SD3:"sd3",IQR:"iqr",MAD:"mad",CONSTANT:"constant",NA_COUNT:"nacount",NA_PCT:"napct",NON_NA_COUNT:"nnacount",NON_NA_PCT:"nnapct",ALL:"all",ANY:"any",TRUE_COUNT:"truecount",FALSE_COUNT:"falsecount",TRUE_PCT:"truepct",FALSE_PCT:"falsepct",LM_FIT:"lmfit",LOESS_FIT:"loessfit",GAM_FIT:"gamfit",BUCKET:"bucket",BOXPLOT:"boxplot",AS_CHAR:"aschar",AS_FACTOR:"asfactor",AS_LOGICAL_FACTOR:"aslfactor",NORMALIZE:"normalize",STDERR:"stderr",CONF_INTV_95:"confint",CONF_INTV_99:"confint99",STDERR_PCT:"stderrpct",CONF_INTV_PCT_95:"confintpct",CONF_INTV_PCT_99:"confintpct99",SD1_PCT:"sdpct",ROUND_TO_YEAR:"rtoyear",ROUND_TO_HALF_YEAR:"rtohalfyear",ROUND_TO_QUARTER:"rtoq",ROUND_TO_BI_MONTH:"rtobimon",ROUND_TO_MONTH:"rtomon",ROUND_TO_WEEK:"rtoweek",ROUND_TO_DAY:"rtoday",ROUND_TO_HOUR:"rtohour",ROUND_TO_MINUTE:"rtomin",ROUND_TO_SECOND:"rtosec",YEAR:"year",HALF_YEAR:"halfyear",QUARTER:"quarter",BI_MONTH:"bimon",MONTH:"mon",MONTH_NAME:"monname",WEEK:"week",DAY:"day",DAY_OF_YEAR:"dayofyear",DAY_OF_QUARTER:"dayofquarter",DAY_OF_WEEK:"dayofweek",WEEKDAY:"wday",HOUR:"hour",MINUTE:"minute",SECOND:"second",AS_NUM:"asnum",AS_INTEGER:"asint",AS_INTEGER_BY10:"asintby10",CONVERT_NA:"convertna",COMPLETE:"complete",CONVERT_US_STATE_NAME:"convstate",CONVERT_COUNTRY_NAME:"convcountry",CONVERT_ISO2C:"conviso2c",CONVERT_ISO3N:"conviso3n",UNGROUP:"ungrp",QUANTILE:"qtile",CUT:"cut",CUMSUM:"cumsum",PCT_CUMSUM:"pcumsum",CUMMEAN:"cummean",CUMMIN:"cummin",CUMMAX:"cummax",CUMPROD:"cumprod",DIFF_FROM_PREV:"dfprev",DIFF_FROM_NEXT:"dfnext",DIFF_FROM_FIRST:"dfirst",DIFF_FROM_LAST:"dflast",DIFF_FROM_MIN:"dfmin",DIFF_FROM_MAX:"dfmax",DIFF_FROM_MEAN:"dfmean",DIFF_FROM_MEDIAN:"dfmed",PCT_DIFF_FROM_PREV:"pdfprev",PCT_DIFF_FROM_NEXT:"pdfnext",PCT_DIFF_FROM_FIRST:"pdfirst",PCT_DIFF_FROM_LAST:"pdflast",PCT_DIFF_FROM_MIN:"pdfmin",PCT_DIFF_FROM_MAX:"pdfmax",PCT_DIFF_FROM_MEAN:"pdfmean",PCT_DIFF_FROM_MEDIAN:"pdfmed",PCT_OF_TOTAL:"ptotal",PCT_OF_FIRST:"poffirst",PCT_OF_LAST:"poflast",PCT_OF_MIN:"pofmin",PCT_OF_MAX:"pofmax",PCT_OF_MEAN:"pofmean",PCT_OF_MEDIAN:"pofmedian",MIN_RANK:"mrank",DENSE_RANK:"drank",PCT_RANK:"prank",ROLL_MIN:"rollmin",ROLL_MAX:"rollmax",ROLL_MEAN:"rollmean",ROLL_MEDIAN:"rollmed",ROLL_SD:"rollsd",ROLL_VAR:"rollvar",ROLL_SUM:"rollsum",ROLL_PROD:"rollprod",SORT_ASC:"sortasc",SORT_DESC:"sortdesc",FCT_CREATE:"fctcreate",FCT_REORDER_ASC:"fctreorderasc",FCT_REORDER_DESC:"fctreorderdesc",FCT_REV:"fctrev",FCT_INFREQ:"infreq",FCT_INFREQ_ASC:"sortfreqasc",FCT_INFREQ_DESC:"sortfreqdesc",REF_LINE:"refline",REF_LINE_WITH_CONF_INT:"refline_confint",DIAGONAL:"diagonal"};res.PIXEL_PER_CHAR=7;res.MIN_MARGIN=60;res.MAX_MARGIN=100;res.DEFAULT_MIN_CIRCLE_DIAMETER={scatter:6,bubble:10,map:5};res.DEFAULT_MAX_CIRCLE_DIAMETER={scatter:30,bubble:40,map:15};res.ZERO_LINE_COLOR="#cfcfcf";res.FREQ_COL_LABEL="(Number of Rows)";res.AGGREGATION_FUNCTION_OPTIONS_HASH={};res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.SUM]="Sum";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.AVERAGE]="Avg.";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.MIN]="Min";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.MAX]="Max";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.FIRST]="First";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.LAST]="Last";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.COUNT]="Count";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.COUNT_DISTINCT]="Uniq.";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.MEDIAN]="Med.";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.SD1]="SD";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.SD2]="2SD";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.SD3]="3SD";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.VAR]="Var.";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.IQR]="IQR";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.MAD]="MAD";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.NA_COUNT]="#NA";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.NA_PCT]="%NA";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.NON_NA_COUNT]="#NNA";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.NON_NA_PCT]="%NNA";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.TRUE_COUNT]="#True";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.FALSE_COUNT]="#False";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.TRUE_PCT]="%True";res.AGGREGATION_FUNCTION_OPTIONS_HASH[Column.OperationType.FALSE_PCT]="%False";res.DEFAULT_FACET_SIZE=3;res.MIN_FACET_HEIGHT=300;res.ORIGINAL_ORDER_COL_NAME=".oo";res.TYPE_NUMROWS="numrows";res.NUMROWS_COL_NAME=".dummy.column.name.for.count.column";res.NUMROWS_COL_LABEL="(Number of Rows)";res.NUMROWS_COL_TEMPLATE={name:res.NUMROWS_COL_NAME,validName:res.NUMROWS_COL_NAME,isNumeric:true,isDate:false,type:res.TYPE_NUMROWS,func:Column.OperationType.COUNT,label:null,validLabel:null};res.TYPE_ROWID="rowid";res.ROWID_COL_NAME=".rowid.column";res.ROWID_COL_LABEL="(Row ID)";res.ROWID_COL_TEMPLATE={name:res.ROWID_COL_NAME,validName:res.ROWID_COL_NAME,isNumeric:true,isDate:false,type:res.TYPE_ROWID,func:Column.OperationType.NONE,label:null,validLabel:null};var _createHash=function(definitionArr){var obj={};definitionArr.forEach(function(item){obj[item.value]=item.label});return obj};res.BUCKET_OPTIONS=[{label:"Automatic",value:0},{label:"5",value:5},{label:"10",value:10},{label:"15",value:15},{label:"20",value:20},{label:"25",value:25},{label:"50",value:50},{label:"100",value:100}];res.BUCKET_OPTIONS_HASH=_createHash(res.BUCKET_OPTIONS);res.PCT_TOTAL_DIRECTION_OPTIONS=[{value:"x",label:"X Axis"},{value:"color",label:"Color"}];res.PCT_TOTAL_DIRECTION_OPTIONS_HASH=_createHash(res.PCT_TOTAL_DIRECTION_OPTIONS);res.MARKER_SHAPE_OPTIONS=[{value:"default",label:"(Default)"},{value:"circle",label:"Circle"},{value:"bar",label:"Bar"},{value:"line",label:"Line"}];res.MARKER_SHAPE_OPTIONS_HASH=_createHash(res.MARKER_SHAPE_OPTIONS);res.ERRBAR_MARKER_SHAPE_OPTIONS=[{value:"bar",label:"Bar"},{value:"circle",label:"Marker"}];res.ERRBAR_MARKER_SHAPE_OPTIONS_HASH=_createHash(res.ERRBAR_MARKER_SHAPE_OPTIONS);res.PIVOT_COLOR_OPTIONS=[{label:"(None)",value:"none"},{label:"All (Down then Across)",value:"table_down_across"},{label:"Row (Across)",value:"table_across"},{label:"Column (Down then Across within Group)",value:"pane_down_across"},{label:"Column (Down)",value:"table_down"},{label:"Column (Down within Group)",value:"pane_down"}];res.PIVOT_COLOR_OPTIONS_HASH=_createHash(res.PIVOT_COLOR_OPTIONS);res.PIVOT_COLOR_OPTIONS_HASH.table5="All";res.PIVOT_COLOR_OPTIONS_HASH.row5="Row";res.PIVOT_WINDOW_FUNC_DIRECTIONS=[{label:"All (Down then Across)",value:"table_down_across"},{label:"Row (Across)",value:"table_across"},{label:"Column (Down then Across within Group)",value:"pane_down_across"},{label:"Column (Down)",value:"table_down"},{label:"Column (Down within Group)",value:"pane_down"}];res.PIVOT_WINDOW_FUNC_DIRECTIONS_HASH=_createHash(res.PIVOT_WINDOW_FUNC_DIRECTIONS);res.PIVOT_DIRECTIONS_BACKWARD_COMPATIBILITY_MAP={all:"table_down_across",row:"table_across",row_group:"pane_down_across",column:"table_down"};res.TABLE_MAX_NUMROW_OPTIONS=[{label:"100",value:100},{label:"200",value:200},{label:"500",value:500},{label:"1,000",value:1e3},{label:"2,000",value:2e3},{label:"3,000",value:3e3}];res.TABLE_MAX_NUMROW_OPTIONS_HASH=_createHash(res.TABLE_MAX_NUMROW_OPTIONS);res.MODEL_DATA_TYPE_OPTIONS=[{label:"Coefficients",value:"tidy"},{label:"Model Quality Stats",value:"glance"},{label:"Scored Data",value:"augment"}];res.MODEL_DATA_TYPE_OPTIONS_HASH=_createHash(res.MODEL_DATA_TYPE_OPTIONS);res.ERROR_BAR_TYPE_OPTIONS=[{label:"Standard Error",hint:"Standard Error",value:Column.OperationType.STDERR},{label:"95% Conf. Interval",hint:"95% Confidence Interval",value:Column.OperationType.CONF_INTV_95},{label:"99% Conf. Interval",hint:"99% Confidence Interval",value:Column.OperationType.CONF_INTV_99},{label:"1 Standard Deviation",hint:"1 Standard Deviation",value:Column.OperationType.SD1},{label:"2 Standard Deviation",hint:"2 Standard Deviation",value:Column.OperationType.SD2},{label:"3 Standard Deviation",hint:"3 Standard Deviation",value:Column.OperationType.SD3},{label:"IQR",hint:"Interquartile Range (IQR)",value:Column.OperationType.IQR}];res.ERROR_BAR_TYPE_OPTIONS_HASH=_createHash(res.ERROR_BAR_TYPE_OPTIONS);res.REFERENCE_LINE_RANGE_TYPE_OPTIONS=[{label:"95% Conf. Interval",hint:"95% Confidence Interval",value:Column.OperationType.CONF_INTV_95},{label:"99% Conf. Interval",hint:"99% Confidence Interval",value:Column.OperationType.CONF_INTV_99},{label:"1 Standard Deviation",hint:"1 Standard Deviation",value:Column.OperationType.SD1},{label:"2 Standard Deviation",hint:"2 Standard Deviation",value:Column.OperationType.SD2},{label:"3 Standard Deviation",hint:"3 Standard Deviation",value:Column.OperationType.SD3},{label:"IQR",hint:"Interquartile Range (IQR)",value:Column.OperationType.IQR}];res.REFERENCE_LINE_RANGE_TYPE_OPTIONS_HASH=_createHash(res.REFERENCE_LINE_RANGE_TYPE_OPTIONS);res.ERROR_BAR_GRAPH_OPTIONS=[{label:"Bar",value:"bar"},{label:"Circle",value:"marker"}];res.ERROR_BAR_GRAPH_OPTIONS_HASH=_createHash(res.ERROR_BAR_GRAPH_OPTIONS);res.ERROR_BAR_CALC_TYPE_OPTIONS=[{label:"Mean (Average)",value:"mean"},{label:"Ratio (%)",value:"ratio"}];res.ERROR_BAR_CALC_TYPE_OPTIONS_HASH=_createHash(res.ERROR_BAR_CALC_TYPE_OPTIONS);res.WINDOW_FUNCTION_CALC_TYPES=[{label:"(none)",value:"none",items:[{label:"(none)",hint:"none",value:Column.OperationType.NONE}]},{label:"Cumulative",value:"cum",itemLabel:"Summarize Values Using",items:[{label:"Sum",hint:"Cumulative Sum",value:Column.OperationType.CUMSUM},{label:"Sum Ratio",hint:"Cumulative Sum Ratio",value:Column.OperationType.PCT_CUMSUM},{label:"Mean (Average)",hint:"Cumulative Average",value:Column.OperationType.CUMMEAN},{label:"Min Value",hint:"Cumulative Min",value:Column.OperationType.CUMMIN},{label:"Max Value",hint:"Cumulative Max",value:Column.OperationType.CUMMAX},{label:"Product",hint:"Cumulative Product",value:Column.OperationType.CUMPROD}]},{label:"% of",value:"total",itemLabel:"Summarize Values Using",items:[{label:"Sum (Total)",hint:"Sum (Total)",value:Column.OperationType.PCT_OF_TOTAL},{label:"First Value",hint:"First",value:Column.OperationType.PCT_OF_FIRST},{label:"Last Value",hint:"Last",value:Column.OperationType.PCT_OF_LAST},{label:"Min Value",hint:"Min",value:Column.OperationType.PCT_OF_MIN},{label:"Max Value",hint:"Max",value:Column.OperationType.PCT_OF_MAX},{label:"Mean (Average)",hint:"Mean (Average)",value:Column.OperationType.PCT_OF_MEAN},{label:"Median",hint:"Median",value:Column.OperationType.PCT_OF_MEDIAN}]},{label:"Difference From",value:"diff",itemLabel:"Difference from",items:[{label:"First Value",hint:"Difference from First",value:Column.OperationType.DIFF_FROM_FIRST},{label:"Last Value",hint:"Difference from Last",value:Column.OperationType.DIFF_FROM_LAST},{label:"Previous Value",hint:"Difference from Previous",value:Column.OperationType.DIFF_FROM_PREV},{label:"Next Value",hint:"Difference from Next",value:Column.OperationType.DIFF_FROM_NEXT},{label:"Min Value",hint:"Difference from Min",value:Column.OperationType.DIFF_FROM_MIN},{label:"Max Value",hint:"Difference from Max",value:Column.OperationType.DIFF_FROM_MAX},{label:"Mean (Average)",hint:"Difference from Average",value:Column.OperationType.DIFF_FROM_MEAN},{label:"Median",hint:"Difference from Median",value:Column.OperationType.DIFF_FROM_MEDIAN}]},{label:"% Difference From",value:"pdiff",itemLabel:"% Difference from",items:[{label:"First Value",hint:"% Difference from First",value:Column.OperationType.PCT_DIFF_FROM_FIRST},{label:"Last Value",hint:"% Difference from Last",value:Column.OperationType.PCT_DIFF_FROM_LAST},{label:"Previous Value",hint:"% Difference from Previous",value:Column.OperationType.PCT_DIFF_FROM_PREV},{label:"Next Value",hint:"% Difference from Next",value:Column.OperationType.PCT_DIFF_FROM_NEXT},{label:"Min Value",hint:"% Difference from Min",value:Column.OperationType.PCT_DIFF_FROM_MIN},{label:"Max Value",hint:"% Difference from Max",value:Column.OperationType.PCT_DIFF_FROM_MAX},{label:"Mean (Average)",hint:"% Difference from Average",value:Column.OperationType.PCT_DIFF_FROM_MEAN},{label:"Median",hint:"% Difference from Median",value:Column.OperationType.PCT_DIFF_FROM_MEDIAN}]},{label:"Moving Calculation",value:"roll",itemLabel:"Summarize Values Using",items:[{label:"Mean (Average)",hint:"Moving Average",value:Column.OperationType.ROLL_MEAN},{label:"Min Value",hint:"Moving Min",value:Column.OperationType.ROLL_MIN},{label:"Max Value",hint:"Moving Max",value:Column.OperationType.ROLL_MAX},{label:"Median",hint:"Moving Median",value:Column.OperationType.ROLL_MEDIAN},{label:"Standard Deviation",hint:"Moving Standard Deviation",value:Column.OperationType.ROLL_SD},{label:"Variance",hint:"Moving Variance",value:Column.OperationType.ROLL_VAR},{label:"Sum",hint:"Moving Sum",value:Column.OperationType.ROLL_SUM},{label:"Product",hint:"Moving Product",value:Column.OperationType.ROLL_PROD}]}];res.WINDOW_FUNCTION_CALC_TYPES_ERRBAR=[res.WINDOW_FUNCTION_CALC_TYPES[0],res.WINDOW_FUNCTION_CALC_TYPES[2]];res.WINDOW_FUNCTION_CALC_TYPES_PIVOT=[res.WINDOW_FUNCTION_CALC_TYPES[0],res.WINDOW_FUNCTION_CALC_TYPES[1],res.WINDOW_FUNCTION_CALC_TYPES[2],res.WINDOW_FUNCTION_CALC_TYPES[3],res.WINDOW_FUNCTION_CALC_TYPES[4],res.WINDOW_FUNCTION_CALC_TYPES[5]];var _createCalcTypesHash=function(definitionArr){var obj={};definitionArr.forEach(function(item){obj[item.value]=item});return obj};res.WINDOW_FUNCTION_CALC_TYPES_HASH=_createCalcTypesHash(res.WINDOW_FUNCTION_CALC_TYPES);res.WINDOW_FUNCTION_OPTIONS=[{label:"(none)",value:Column.OperationType.NONE},{label:"Cumulative Sum",value:Column.OperationType.CUMSUM},{label:"Cumulative Sum Ratio",value:Column.OperationType.PCT_CUMSUM},{label:"Cumulative Average",value:Column.OperationType.CUMMEAN},{label:"Cumulative Min",value:Column.OperationType.CUMMIN},{label:"Cumulative Max",value:Column.OperationType.CUMMAX},{label:"Cumulative Prod",value:Column.OperationType.CUMPROD},{label:"% of Total",value:Column.OperationType.PCT_OF_TOTAL},{label:"% of First",value:Column.OperationType.PCT_OF_FIRST},{label:"% of Last",value:Column.OperationType.PCT_OF_LAST},{label:"% of Min",value:Column.OperationType.PCT_OF_MIN},{label:"% of Max",value:Column.OperationType.PCT_OF_MAX},{label:"% of Average",value:Column.OperationType.PCT_OF_MEAN},{label:"% of Median",value:Column.OperationType.PCT_OF_MEDIAN},{label:"Difference from Previous",value:Column.OperationType.DIFF_FROM_PREV},{label:"Difference from Next",value:Column.OperationType.DIFF_FROM_NEXT},{label:"Difference from First",value:Column.OperationType.DIFF_FROM_FIRST},{label:"Difference from Last",value:Column.OperationType.DIFF_FROM_LAST},{label:"Difference from Min",value:Column.OperationType.DIFF_FROM_MIN},{label:"Difference from Max",value:Column.OperationType.DIFF_FROM_MAX},{label:"Difference from Average",value:Column.OperationType.DIFF_FROM_MEAN},{label:"Difference from Median",value:Column.OperationType.DIFF_FROM_MEDIAN},{label:"% Difference from Previous",value:Column.OperationType.PCT_DIFF_FROM_PREV},{label:"% Difference from Next",value:Column.OperationType.PCT_DIFF_FROM_NEXT},{label:"% Difference from First",value:Column.OperationType.PCT_DIFF_FROM_FIRST},{label:"% Difference from Last",value:Column.OperationType.PCT_DIFF_FROM_LAST},{label:"% Difference from Min",value:Column.OperationType.PCT_DIFF_FROM_MIN},{label:"% Difference from Max",value:Column.OperationType.PCT_DIFF_FROM_MAX},{label:"% Difference from Average",value:Column.OperationType.PCT_DIFF_FROM_MEAN},{label:"% Difference from Median",value:Column.OperationType.PCT_DIFF_FROM_MEDIAN},{label:"Moving Average",value:Column.OperationType.ROLL_MEAN},{label:"Moving Min",value:Column.OperationType.ROLL_MIN},{label:"Moving Max",value:Column.OperationType.ROLL_MAX},{label:"Moving Median",value:Column.OperationType.ROLL_MEDIAN},{label:"Moving Standard Deviation",value:Column.OperationType.ROLL_SD},{label:"Moving Variance",value:Column.OperationType.ROLL_VAR},{label:"Moving Sum",value:Column.OperationType.ROLL_SUM},{label:"Moving Prod",value:Column.OperationType.ROLL_PROD},{label:"Min Rank",value:Column.OperationType.MIN_RANK},{label:"Dense Rank",value:Column.OperationType.DENSE_RANK},{label:"Percent Rank",value:Column.OperationType.PCT_RANK}];res.WINDOW_FUNCTION_OPTIONS_HASH=_createHash(res.WINDOW_FUNCTION_OPTIONS);res.REFERENCE_LINE_OPTIONS=[{label:"Sum",value:Column.OperationType.SUM},{label:"Avg.",value:Column.OperationType.AVERAGE},{label:"Min",value:Column.OperationType.MIN},{label:"Max",value:Column.OperationType.MAX},{label:"Med.",value:Column.OperationType.MEDIAN},{label:"First",value:Column.OperationType.FIRST_EXCLUDE_NA},{label:"Last",value:Column.OperationType.LAST_EXCLUDE_NA},{label:"First",value:Column.OperationType.FIRST},{label:"Last",value:Column.OperationType.LAST},{label:"Diagonal",value:Column.OperationType.DIAGONAL},{label:"Const.",value:Column.OperationType.CONSTANT}];res.REFERENCE_LINE_OPTIONS_HASH=_createHash(res.REFERENCE_LINE_OPTIONS);var MAX_NUMBER_OF_CONTROLS={rowh:10,colh:1,meas:7,y:5,tcol:300};res.MAX_NUMBER_OF_CONTROLS=MAX_NUMBER_OF_CONTROLS;res.getOptions=function(vizOptionsJson,option){var i=0,res=[],max=MAX_NUMBER_OF_CONTROLS[option];if(max===undefined){throw new Error("not supported case")}else{for(i=0;i<max;i++){if(i===0&&option==="y"){res.push(vizOptionsJson[option])}else{res.push(vizOptionsJson[option+i])}}while(res.length>0&&!res[res.length-1]){res.pop()}return res}};var _createNameHash=function(arr){var obj={};arr.forEach(function(item){obj[item.value]=item});return obj};res.QUANT_COLOR_PALETTES=[{value:"Blues",label:"Blue",color:["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"],textColor:["","","","#fff","#fff"]},{value:"Greens",label:"Green",color:["#edf8e9","#bae4b3","#74c476","#31a354","#006d2c"],textColor:["","","","#fff","#fff"]},{value:"Oranges",label:"Orange",color:["#feedde","#fdbe85","#fd8d3c","#e6550d","#a63603"],textColor:["","","","#fff","#fff"]},{value:"Purples",label:"Purple",color:["#f2f0f7","#cbc9e2","#9e9ac8","#756bb1","#54278f"],textColor:["","","","#fff","#fff"]},{value:"Reds",label:"Red",color:["#fee5d9","#fcae91","#fb6a4a","#de2d26","#a50f15"],textColor:["","","","#fff","#fff"]},{value:"Viridis",label:"Viridis",color:["#440154","#3B518B","#21908D","#5CC863","#FDE725"],textColor:["#fff","#fff","#fff","",""]},{value:"YlGn",label:"Yellow-Green",color:["#ffffcc","#c2e699","#78c679","#31a354","#006837"],textColor:["","","","#fff","#fff"]},{value:"YlGnBu",label:"Yellow-Green-Blue",color:["#ffffcc","#a1dab4","#41b6c4","#2c7fb8","#253494"],textColor:["","","","#fff","#fff"]},{value:"YlOrBr",label:"Yellow-Orange-Brown",color:["#ffffd4","#fed98e","#fe9929","#d95f0e","#993404"],textColor:["","","","#fff","#fff"]},{value:"YlOrRd",label:"Yellow-Orange-Red",color:["#ffffb2","#fecc5c","#fd8d3c","#f03b20","#bd0026"],textColor:["","","","#fff","#fff"]},{value:"RdBu",label:"Red-Blue",color:["rgb(5,10,172)","rgb(106,137,247)","rgb(190,190,190)","rgb(230,145,90)","rgb(178,10,28)"],textColor:["#fff","","","","#fff"]},{value:"RdLb",label:"Red-Light Blue",color:["#4A90E2","#b3cae4","rgba(170,170,170,0.41)","rgba(222,145,158,1)","rgba(231,66,12,1)"],textColor:["#fff","","","","#fff"]},{value:"RdYlBu",label:"Red-Yellow-Blue Diverging",color:["#d7191c","#fdae61","#ffffbf","#abd9e9","#2c7bb6"],textColor:["#fff","","","","#fff"]},{value:"RdYlGn",label:"Red-Yellow Green Diverging",color:["#d7191c","#fdae61","#ffffbf","#a6d96a","#1a9641"],textColor:["#fff","","","","#fff"]}];res.CATEG_COLOR_PALETTES=[{value:"default",label:"Palette 1",color:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"Paired",label:"Palette 2",color:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"Pastel1",label:"Palette 3",color:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec"],textColor:["#000","#000","#000","#000","#000","#000","#000","#000"]},{value:"Pastel2",label:"Palette 4",color:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],textColor:["#000","#000","#000","#000","#000","#000","#000","#000"]},{value:"Set1",label:"Palette 5",color:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#000","#fff","#fff"]},{value:"Set2",label:"Palette 6",color:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],textColor:["#000","#000","#000","#000","#000","#000","#000","#000","#000"]},{value:"Set3",label:"Palette 7",color:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5"],textColor:["#000","#000","#000","#000","#000","#000","#000","#000","#000"]},{value:"Accent",label:"Palette 8",color:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],textColor:["","","","","#fff","#fff","#fff","#fff"]},{value:"Dark2",label:"Palette 9",color:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"Milano",label:"Palette 10",color:["#F1632C","#FAA234","#AB9A84","#6B6258","#B2B148","#507B52","#91C699","#718BA3","#CEC58B","#3E556E"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"Cat10",label:"Palette 11",color:["#3C6398","#EF7B13","#DA3E44","#63AAA3","#47953A","#E9C12C","#A06291","#FC8795","#8A624B","#ACA09C"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"Cat25",label:"Palette 12",color:["#3C6398","#8EBFE4","#EF7B13","#FEB165","#47953A","#7ACC66","#A88A17","#EEC748","#398882","#73B0A7","#7ACC66","#A88A17","#EEC748","#398882","#73B0A7","#DA3E44","#FD8886","#665D5B","#ACA09C","#C95983","#F9AEC8","#A06291","#CA91BD","#8C634C","#CEA694"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"Cat12",label:"Palette 13",color:["#3E923C","#75CC69","#EB7807","#FCBC53","#2D98AF","#86D1DF","#82970D","#B7C921","#8F7303","#F5CF0A","#1C786B","#7AB497"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"B1",label:"Palette 14 (Color Blind)",color:["#0B5A9C","#FB6708","#929BAB","#454D58","#4C8FC5","#BC3D05","#68707D","#92C0E5","#FDAF61","#BCC5D1"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"Analytics1",label:"Palette 15 (Analytics)",color:["#4A90E2","rgba(231,66,12,1)","rgba(170,170,170,0.41)"],textColor:["#fff","#fff","#fff"]},{value:"Analytics2",label:"Palette 16 (Analytics)",color:["#4A90E2","rgba(231,66,12,1)"],textColor:["#fff","#fff"]},{value:"Analytics3",label:"Palette 17 (Analytics)",color:["rgba(40,110,175,1)","rgba(170,170,170,0.41)"],textColor:["#fff","#fff"]},{value:"Analytics4",label:"Palette 18 (Analytics)",color:["#4A90E2","rgba(98,165,21,1)","rgba(231,66,12,1)"],textColor:["#fff","#fff","#fff"]},{value:"Analytics5",label:"Palette 19 (Analytics)",color:["#4A90E2","#dcdee0","rgba(98,165,21,1)","rgba(231,66,12,1)"],textColor:["#fff","#fff","#fff","#fff"]},{value:"Analytics6",label:"Palette 20 (Analytics)",color:["#dcdee0","#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]},{value:"Analytics7",label:"Palette 21 (Analytics)",color:["#1f77b4","#2ca02c"],textColor:["#fff","#fff"]},{value:"Analytics8",label:"Palette 22 (Analytics)",color:["rgba(170,170,170,0.41)"],textColor:["#fff"]},{value:"Analytics9",label:"Palette 23 (Analytics)",color:["#1f77b4","rgba(170,170,170,0.41)"],textColor:["#fff","#fff"]},{value:"custom",label:"Custom",color:["#cccccc","#cccccc","#cccccc","#cccccc","#cccccc","#cccccc","#cccccc","#cccccc","#cccccc"],textColor:["#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff","#fff"]}];res.QUANT_COLOR_PALETTES_HASH=_createNameHash(res.QUANT_COLOR_PALETTES);res.CATEG_COLOR_PALETTES_HASH=_createNameHash(res.CATEG_COLOR_PALETTES);res.CATEG_COLOR_PALETTES_NO_CUSTOM=res.CATEG_COLOR_PALETTES.slice(0,res.CATEG_COLOR_PALETTES.length-2);var hexToRgb=function(hex){var result,base;if(/^rgb/.test(hex.trim())){result=/([\d]+)[, ]*([\d]+)[, ]*([\d]+)/.exec(hex.trim());base=10}else{result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex.trim());base=16}return result?{r:parseInt(result[1],base),g:parseInt(result[2],base),b:parseInt(result[3],base)}:null};var hexToRgba=function(hex,opacity){var rgb=hexToRgb(hex);if(rgb===null){rgb={r:204,g:204,b:204}}return"rgba("+rgb.r+","+rgb.g+","+rgb.b+","+opacity+")"};res.hexToRgb=hexToRgb;res.hexToRgba=hexToRgba;res.getDefaultOpacity=function(options){switch(options.marker){case"scatter":case"bubble":return.8;case"hist":return!options.color?.9:.6;default:return null}};res.getBucketInfo=function(data,bucketProp){var hash={};data.forEach(function(d){if(!!d[bucketProp]&&!hash[d[bucketProp]]){hash[d[bucketProp]]=1}});var exts=Object.keys(hash).map(function(key){var ext=key.replace(/[\[\(\]]/g,"").split(",");ext=ext.map(function(m){return parseFloat(m)});return{key:key,extent:ext}});exts=exts.sort(function(a,b){return a.extent[0]-b.extent[0]});exts=exts.map(function(m,idx){m.id=idx+1;return m});var h={};exts.forEach(function(m){h[m.key]=m.id});var isNew=true;Object.keys(hash).forEach(function(key){isNew=isNew&&/\]/.test(key)});return{legend:isNew?exts:null,map:h}};res.distinct=function(arr){var u={},a=[];for(var i=0,l=arr.length;i<l;++i){if(u.hasOwnProperty(arr[i])){continue}a.push(arr[i]);u[arr[i]]=1}return a};var _isLeaflet=function(marker){return/^(geojson|map|maphmap)$/.test(marker)};var _isPivot=function(marker){return/^(pivot|table|singlevalue)$/.test(marker)};var _isPlotly=function(marker){return!(_isLeaflet(marker)||_isPivot(marker))};var _isWindowFunctionSupported=function(marker){return/^(bar|line|area|errbar|pivot)$/.test(marker)};var _isMultiYSupported=function(marker){return/^(bar|errbar|line|area|scatter)$/.test(marker)};var _isDualYSupported=function(marker,barstyle){return/^(bar|scatter|line|bubble)$/.test(marker)};var _getValueSuffix=function(winfunc,colfunc){if(colfunc&&/^(truepct|falsepct|napct|nnapct)$/.test(colfunc)){return"%"}if(!winfunc){return""}else{return/(^ptotal$|^pdf|^pof|^pcumsum$)/.test(winfunc)?"%":""}};res.isPlotly=_isPlotly;res.isPivot=_isPivot;res.isLeaflet=_isLeaflet;res.isWindowFunctionSupported=_isWindowFunctionSupported;res.isMultiYSupported=_isMultiYSupported;res.isDualYSupported=_isDualYSupported;res.getValueSuffix=_getValueSuffix;res.returnsNumericValue=function(col){if(!col||!col.name||!col.func){throw new Error("Invalid argument was passed to returnsNumericValue.")}return col.isNumeric&&col.func!=="aschar"||/^(sum|count|countd|ave|median|min|max|var|sd|iqr|mad|nacount|nnacount|napct|nnapct|truecount|falsecount|truepct|falsepct|asint|asintby10)/.test(col.func)||col.isDate&&/^(year|halfyear|quarter|bimon|mon|day|hour|minute|second|week|dayofyear|dayofquarter|dayofweek)$/.test(col.func)};res.returnsDateValue=function(col){if(!col||!col.name||!col.func){throw new Error("Invalid argument was passed to returnsDateValue.")}return col.isDate&&(!col.func||/^(rto|none$)/.test(col.func))};res.returnsCharacterValue=function(col){if(!col||!col.name||!col.func){throw new Error("Invalid argument was passed to returnsCharacterValue.")}return!res.returnsNumericValue(col)&&!res.returnsDateValue(col)};res.isEmpty=function(val){return typeof val==="undefined"||val===null};res.isUndefined=function(val){return typeof val==="undefined"};res.shouldRenderNoData=function(data,marker){return(!data||data.length===0)&&!/^(geojson|singlevalue)$/.test(marker)};res.renderNoData=function(div,msg,borderCss,hintText){div.innerHTML='<div style="width:100%; height:100%; display:table;" class="viz-rendering-error">'+'<div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; '+(borderCss?"border:"+borderCss:"")+'">'+"<div>"+(msg?msg:"There is no data to display")+"</div>"+(hintText?'<div style="width:360px; margin:auto; margin-top:15px">'+hintText+"</div>":"")+"</div>"+"</div>"};res.COLOR_PALETTE_REGEX=/((rgb[a]*\([0-9 \,\.]*\))|\#[0-9a-fA-F]+)/g;res.isInColumnarFormat=function(data){return Object.prototype.toString.call(data)!=="[object Array]"};res.convertColumnarData=function(data){if(!data||!res.isInColumnarFormat(data)){return data}var cols=Object.keys(data),rows=[],idx=0,row=null;if(cols.length===0){return rows}while(idx<data[cols[0]].length){row={};cols.forEach(function(col){row[col]=data[col][idx]});rows.push(row);idx++}return rows};var decimalAdjust=function(type,value,exp){if(typeof exp==="undefined"||+exp===0){return Math[type](value)}value=+value;exp=+exp;if(value===null||isNaN(value)||!(typeof exp==="number"&&exp%1===0)){return NaN}if(value<0){return-decimalAdjust(type,-value,exp)}value=value.toString().split("e");value=Math[type](+(value[0]+"e"+(value[1]?+value[1]-exp:-exp)));value=value.toString().split("e");return+(value[0]+"e"+(value[1]?+value[1]+exp:exp))};res.round10=function(value,exp){return decimalAdjust("round",value,-exp)};res.floor10=function(value,exp){return decimalAdjust("floor",value,-exp)};res.ceil10=function(value,exp){return decimalAdjust("ceil",value,-exp)};res.valueFormatterGenerator=function(numDecimalDigits,useThousandSeparator){numDecimalDigits=parseInt(numDecimalDigits);var groupFormatter=d3.format(useThousandSeparator===false?"":",");return function(v){if(v===undefined||v===null)return"";var s=groupFormatter(res.round10(v,numDecimalDigits));if(s!=="NaN"){s=s.replace(/\.0+$/,"");return s}else{s=v.toString();return s.length>60?s.substr(0,60)+"...":s}}};return res}();if(typeof module==="object"&&module.exports)module.exports=VizUtil;var PivotTableGenerator=function(){};var _sortIdx=0;var _SORT_NONE=0;var _SORT_DESC=1;var SCROLL_BAR_WIDTH=25;var SHOW_BALLOON_THRESHOLD=15;var _getNextSortDir=function(current){return(current+1)%3};var _sortDir=_SORT_NONE;var isNumberCol=function(col){if(!col){return false}return col.isNumeric||/(difftime|Period|duration|hms|interval)/i.test(col.type)};PivotTableGenerator.render=function(viz,data,elTarget,prevState,headerSyncDelay,onLoadCallback,onErrorCallback){try{PivotTableGenerator._render(viz,data,elTarget,prevState,headerSyncDelay)}catch(e){if(onErrorCallback&&typeof onErrorCallback==="function"){onErrorCallback(e)}VizUtil.renderNoData(elTarget,"Graph rendering failed.");console.error(e)}finally{if(onLoadCallback&&typeof onLoadCallback==="function"){onLoadCallback()}}};PivotTableGenerator._render=function(viz,data,elTarget,prevState,headerSyncDelay){while(elTarget.childNodes.length>0){elTarget.removeChild(elTarget.firstChild)}if(viz.marker==="singlevalue"){PivotTableGenerator.renderSingleValue(viz,data,elTarget);return}var _syncHeader=function(elTarget){var i,l;var headerCells=elTarget.querySelectorAll(".pivot-view .pivot-col-header-view .pivot-cell.header");var bodyCells=elTarget.querySelectorAll(".pivot-view .pivot-body-view .pivot-cell.header");for(i=0,l=bodyCells.length;i<l;i++){headerCells.item(i).style.minWidth=bodyCells.item(i).offsetWidth+"px"
;headerCells.item(i).style.maxWidth=bodyCells.item(i).offsetWidth+"px"}var colTitle=elTarget.querySelector(".pivot-col-title");if(colTitle){var rowHeaders=elTarget.querySelectorAll(".pivot-view .pivot-body-view .pivot-cell.header.row-header");if(rowHeaders.length>0){var p=0;for(i=0,l=rowHeaders.length;i<l;i++){if(bodyCells[i]){p+=bodyCells[i].clientWidth}}colTitle.style.paddingLeft=p+"px"}else{colTitle.style.paddingLeft="10px"}}};var _syncTitle=function(elTarget){var pivotTitle=elTarget.querySelector(".pivot-title");var pivotTable=elTarget.querySelector(".pivot-view .pivot-body-view .pivot-table-frame");var pivotTitleWidth=$(pivotTitle).width();var pivotTableWidth=$(pivotTable).width();if(pivotTitleWidth>pivotTableWidth){$(pivotTitle).width(pivotTableWidth)}};var PIXEL_STEP=10;var LINE_HEIGHT=40;var PAGE_HEIGHT=800;var normalizeWheel=function(event){var sX=0,sY=0,pX=0,pY=0;if("detail"in event){sY=event.detail}if("wheelDelta"in event){sY=-event.wheelDelta/120}if("wheelDeltaY"in event){sY=-event.wheelDeltaY/120}if("wheelDeltaX"in event){sX=-event.wheelDeltaX/120}if("axis"in event&&event.axis===event.HORIZONTAL_AXIS){sX=sY;sY=0}pX=sX*PIXEL_STEP;pY=sY*PIXEL_STEP;if("deltaY"in event){pY=event.deltaY}if("deltaX"in event){pX=event.deltaX}if((pX||pY)&&event.deltaMode){if(event.deltaMode==1){pX*=LINE_HEIGHT;pY*=LINE_HEIGHT}else{pX*=PAGE_HEIGHT;pY*=PAGE_HEIGHT}}if(pX&&!sX){sX=pX<1?-1:1}if(pY&&!sY){sY=pY<1?-1:1}return{spinX:sX,spinY:sY,pixelX:pX,pixelY:pY}};var _scroll;var _onScrollHandler=function(ev){var left=ev.target.scrollLeft;_scroll.left=left;_scroll.headerElem.parentNode.scrollLeft=_scroll.left};var _onWheelHandler=function(ev){ev.preventDefault();var normEv=normalizeWheel(ev);if(Math.abs(normEv.pixelX)>Math.abs(normEv.pixelY)){if(_scroll.bodyElem.clientWidth>_scroll.bodyElem.parentNode.clientWidth){_scroll.left=Math.max(_scroll.left+normEv.pixelX,0);_scroll.left=Math.min(_scroll.left,_scroll.bodyElem.clientWidth-_scroll.bodyElem.parentNode.clientWidth);_scroll.headerElem.parentNode.scrollLeft=_scroll.left;_scroll.bodyElem.parentNode.scrollLeft=_scroll.left}}else{if(_scroll.bodyElem.clientHeight>_scroll.bodyElem.parentNode.clientHeight){_scroll.top=Math.max(_scroll.top+normEv.pixelY,0);_scroll.top=Math.min(_scroll.top,_scroll.bodyElem.clientHeight-_scroll.bodyElem.parentNode.clientHeight-5);_scroll.bodyElem.parentNode.scrollTop=_scroll.top}}};var _initScrollHandler=function(elTarget,prevState){var tableElem=elTarget.querySelector(".pivot-view");var bodyElem=tableElem.querySelector(".pivot-table-body-frame");var headerElem=tableElem.querySelector(".pivot-table-col-header-frame");var scroll={left:0,top:0,tableElem:tableElem,headerElem:headerElem,bodyElem:bodyElem};_scroll=scroll;if(prevState){_scroll.left=prevState.left;_scroll.headerElem.parentNode.scrollLeft=_scroll.left;_scroll.bodyElem.parentNode.scrollLeft=_scroll.left}tableElem.addEventListener("wheel",_onWheelHandler);bodyElem.parentNode.addEventListener("scroll",_onScrollHandler)};$(".pivot-balloon-style").css("display","none");if(!prevState){_sortIdx=0;_sortDir=_SORT_NONE}if(!data||data.length===0||data[0].length===0){VizUtil.renderNoData(elTarget);return}var isPivot=viz.marker==="pivot";SHOW_BALLOON_THRESHOLD=isPivot?15:25;var textWrap=viz.pivotTextWrap||"none";var hideDataCells=viz.pivotHideDataCells==="on";var colh0FontSize=viz.colh0FontSize;var meas0FontSize=viz.meas0FontSize;var rowh0TotalFontSize=viz.rowh0TotalFontSize;var meas0TotalFontSize=viz.meas0TotalFontSize;var colh0ShowFuncName=viz.colh0ShowFuncName!=="off";var measOps=VizUtil.getOptions(viz,"meas");measOps=measOps.filter(function(m){return!!m});var colAligns=[];if(!isPivot){data[1].forEach(function(col,idx){colAligns.push(isNumberCol(viz["tcol"+idx])?"num-col":"text-col")})}$.balloon.defaults.classname="pivot-balloon-style";$.balloon.defaults.css=null;$.balloon.defaults.minLifetime=0;$.balloon.defaults.showDuration=0;$.balloon.defaults.hideDuration=0;$.balloon.defaults.tipSize=5;var colorPaletteOp=viz.quantColorPalette||viz.colorPallete||"Blues";if(!VizUtil.QUANT_COLOR_PALETTES_HASH[colorPaletteOp]){colorPaletteOp="Blues"}var reverseColorPaletteOrderOp=viz.reverseColorPaletteOrder||viz.reverseColorPalleteOrder||"off";var bgcolorPalette=VizUtil.QUANT_COLOR_PALETTES_HASH[colorPaletteOp].color.slice();var fgcolorPalette=VizUtil.QUANT_COLOR_PALETTES_HASH[colorPaletteOp].textColor.slice();if(reverseColorPaletteOrderOp==="on"){bgcolorPalette.reverse();fgcolorPalette.reverse()}bgcolorPalette.unshift("#ffffff");fgcolorPalette.unshift("#4d4d4d");var elMetainfo=document.createElement("div");elMetainfo.classList.add("pivot-metainfo");if(viz.title&&viz.marker==="table"){elMetainfo.classList.add("with-title")}elTarget.appendChild(elMetainfo);var elTitle=document.createElement("div");elTitle.classList.add("pivot-title");elTarget.appendChild(elTitle);var elColTitle=document.createElement("div");elColTitle.classList.add("pivot-col-title");elColTitle.textContent="Column Title";elTarget.appendChild(elColTitle);var elPivotView=document.createElement("div");elPivotView.classList.add("pivot-view");elPivotView.classList.add(isPivot?"type-pivot":"type-table");elTarget.appendChild(elPivotView);var elPivotColHeaderView=document.createElement("div");elPivotColHeaderView.classList.add("pivot-col-header-view");var elPivotColHeader=document.createElement("div");elPivotColHeader.classList.add("pivot-table-frame");elPivotColHeader.classList.add("pivot-table-col-header-frame");elPivotColHeaderView.appendChild(elPivotColHeader);var elPivotBodyView=document.createElement("div");elPivotBodyView.classList.add("pivot-body-view");var elPivot=document.createElement("div");elPivot.classList.add("pivot-table-frame");elPivot.classList.add("pivot-table-body-frame");elPivotBodyView.appendChild(elPivot);elPivotView.appendChild(elPivotBodyView);elPivotView.appendChild(elPivotColHeaderView);var pdata=PivotTableGenerator.constructPivotData(viz,data,_sortIdx,_sortDir);var infoMsgArr=[];var tFmtr=d3.format(",");if(pdata.data.length<pdata.originalRowSize){infoMsgArr.push(tFmtr(pdata.data.length)+" of "+tFmtr(pdata.originalRowSize)+" rows")}else{infoMsgArr.push(tFmtr(pdata.data.length)+" rows")}if(pdata.colh.length<pdata.originalColSize){infoMsgArr.push(tFmtr(pdata.colh.length)+" of "+tFmtr(pdata.originalColSize)+" columns")}else{infoMsgArr.push(tFmtr(pdata.colh.length)+" columns")}if(!isPivot&&pdata.data.length>=pdata.originalRowSize&&pdata.colh.length>=pdata.originalColSize){infoMsgArr=[]}if(infoMsgArr.length>0){elMetainfo.textContent="Showing "+infoMsgArr.join(", ")}var voffset=0;if(viz.title){elTitle.textContent=viz.title;if(viz.titleFontSize){elTitle.style.fontSize=viz.titleFontSize+"px"}elTitle.classList.remove("hidden");voffset+=45}else{elTitle.textContent="";elTitle.classList.add("hidden")}if(viz.colh0&&!hideDataCells){elColTitle.textContent=viz.colh0Title||viz.colh0.name;if(viz.colh0TitleFontSize){elColTitle.style.fontSize=viz.colh0TitleFontSize+"px"}elColTitle.classList.remove("hidden");voffset+=20}else{elColTitle.textContent="";elColTitle.classList.add("hidden")}if(voffset>0){elPivotView.style.height=" calc( 100% - "+voffset+"px )"}var elRow,elCell,elCellText;var getMeasureStr=function(coldef){if(coldef.title){return coldef.title}else{var s=!coldef.column?VizUtil.NUMROWS_COL_LABEL:coldef.column.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:coldef.column.name;if(colh0ShowFuncName&&s!==VizUtil.NUMROWS_COL_LABEL){s+=" ("+(VizUtil.AGGREGATION_FUNCTION_OPTIONS_HASH[coldef.column.func]||coldef.column.func)+")"}return s}};var onColumnHeaderClickHandler=function(idx){if(_sortIdx===idx){_sortDir=_getNextSortDir(_sortDir)}else{_sortIdx=idx;_sortDir=_SORT_DESC}PivotTableGenerator.render(viz,data,elTarget,{top:_scroll.top,left:_scroll.left})};var renderColHeader=function(targetElem,addRightPaddingForScollbar){elRow=document.createElement("div");elRow.classList.add("pivot-row");targetElem.appendChild(elRow);pdata.rowhCols.forEach(function(c,cidx){elCell=document.createElement("div");elCell.classList.add("pivot-cell","header","row-header");if(colh0FontSize){elCell.style.fontSize=colh0FontSize+"px"}elCellText=document.createElement("div");elCellText.classList.add("pivot-cell-text");elCell.appendChild(elCellText);elCellText.textContent=pdata.rowhColDefs[cidx].title||c;elRow.appendChild(elCell);if(elCell.textContent.length>SHOW_BALLOON_THRESHOLD){$(elCell).balloon({contents:elCell.textContent})}});if(!hideDataCells){pdata.colh.forEach(function(c,idx){elCell=document.createElement("div");elCell.classList.add("pivot-cell","header","col-header");if(!isPivot){elCell.classList.add(colAligns[idx])}var w=viz.meas0CellWidth;if(w){elCell.style.maxWidth=w+"px";elCell.style.minWidth=w+"px";elCell.style.width=w+"px"}if(colh0FontSize){elCell.style.fontSize=colh0FontSize+"px"}elCellText=document.createElement("div");elCell.appendChild(elCellText);elCellText.classList.add("pivot-cell-text");if(isPivot){elCellText.textContent=viz.colh0?VizUtil.isEmpty(c)?" ":c:getMeasureStr(pdata.measColDefs[idx])}else{elCellText.textContent=VizUtil.isEmpty(c)?" ":c}if(_sortDir!==_SORT_NONE&&idx===_sortIdx){elCellText.innerHTML=elCellText.innerHTML+(_sortDir===_SORT_DESC?' <i class="fa fa-caret-down"></i>':' <i class="fa fa-caret-up"></i>')}elRow.appendChild(elCell);if(elCell.textContent.length>SHOW_BALLOON_THRESHOLD){$(elCell).balloon({contents:elCell.textContent})}$(elCell).click(onColumnHeaderClickHandler.bind(this,idx))});if(isPivot&&pdata.rowTotals&&pdata.rowTotals.length>0){var rowTotalIdx=pdata.colh.length;elCell=document.createElement("div");elCell.classList.add("pivot-cell","header","col-header");var w=viz.meas0CellWidth;if(w){elCell.style.maxWidth=w+"px";elCell.style.minWidth=w+"px";elCell.style.width=w+"px"}if(colh0FontSize){elCell.style.fontSize=colh0FontSize+"px"}elCellText=document.createElement("div");elCell.appendChild(elCellText);elCellText.classList.add("pivot-cell-text");elCellText.textContent="Total";if(_sortDir!==_SORT_NONE&&rowTotalIdx===_sortIdx){elCellText.innerHTML=elCellText.innerHTML+(_sortDir===_SORT_DESC?' <i class="fa fa-caret-down"></i>':' <i class="fa fa-caret-up"></i>')}elRow.appendChild(elCell);if(elCell.textContent.length>SHOW_BALLOON_THRESHOLD){$(elCell).balloon({contents:elCell.textContent})}$(elCell).click(onColumnHeaderClickHandler.bind(this,rowTotalIdx))}}if(addRightPaddingForScollbar){elCell=document.createElement("div");elCell.classList.add("pivot-cell","header","col-header");elCell.style.minWidth=SCROLL_BAR_WIDTH+"px";elCell.style.width=SCROLL_BAR_WIDTH+"px";elCell.style.padding="0px";elCell.style.border="0px";elRow.appendChild(elCell)}};renderColHeader(elPivot);renderColHeader(elPivotColHeader,true);var numDecimalDigits=isPivot?2:null;if(!isNaN(viz.numDecimalDigits)&&viz.numDecimalDigits!==""){numDecimalDigits=parseInt(viz.numDecimalDigits)}var useThousandSeparator=viz.useThousandSeparator!=="off";var showPercentEnabled=isPivot&&viz.showPercent!=="off";var groupFormatter=d3.format(useThousandSeparator?",":"");var numFormatter=null;if(numDecimalDigits!==null){numFormatter=function(v){return groupFormatter(VizUtil.round10(v,numDecimalDigits))}}var formatValue=function(v,showPct){if(!numFormatter){return v}if(v==="Inf"||v==="-Inf"){return v}var s=numFormatter(v);s=s.replace(/\.0+$/,"");return s+(showPct?"%":"")};var canOmitLabel=function(rowhdata,ridx,rhcidx){var v=true;for(var i=0;i<=rhcidx;i++){v=v&&rowhdata[ridx-1][i]===rowhdata[ridx][i]}return v};pdata.data.forEach(function(row,ridx){elRow=document.createElement("div");elRow.classList.add("pivot-row");elPivot.appendChild(elRow);var rowclass="";if(pdata.rowh[ridx]){pdata.rowh[ridx].forEach(function(rhc,rhcidx){elCell=document.createElement("div");elCell.classList.add("pivot-cell","row-header");switch(textWrap){case"auto":elCell.classList.add("wrap-responsive-width");break;case"fixed":elCell.classList.add("wrap");break;default:break}var w=pdata.rowhColDefs[rhcidx].cellWidth;if(w&&textWrap!=="auto"){elCell.style.maxWidth=w+"px";elCell.style.minWidth=w+"px";elCell.style.width=w+"px"}var rowhFontSize=pdata.rowhColDefs[rhcidx].fontSize;if(rowhFontSize){elCell.style.fontSize=rowhFontSize+"px"}if(rhcidx<pdata.numRowh-1){elCell.classList.add("grouped","thick")}if(pdata.numRowh===1){elCell.classList.add("thick")}if(ridx<pdata.rowh.length-1&&rhcidx<pdata.numRowh-1){if(pdata.rowh[ridx+1][rhcidx]!==rhc){rowclass="bottom-border"}}if(rowclass){elCell.classList.add(rowclass)}var elCellText;if(ridx>0&&rhcidx<pdata.numRowh-1&&canOmitLabel(pdata.rowh,ridx,rhcidx)){elCellText=document.createElement("span");elCellText.textContent=" "}else{if(!VizUtil.isEmpty(rhc)&&rhc.length>0&&typeof rhc==="string"&&/^(http:\/\/|https:\/\/)/.test(rhc)){elCellText=document.createElement("a");elCellText.setAttribute("href",rhc);elCellText.setAttribute("target","_blank");elCellText.textContent=rhc;elCellText.onclick=PivotTableGenerator.onLinkClick}else{elCellText=document.createElement("span");elCellText.textContent=VizUtil.isEmpty(rhc)?" ":rhc}if(rhc&&rhc.length>10){elCellText.setAttribute("title",rhc)}}elCell.appendChild(elCellText);elRow.appendChild(elCell);if(elCell.textContent.length>SHOW_BALLOON_THRESHOLD){$(elCell).balloon({contents:elCell.textContent})}})}if(!hideDataCells){row.forEach(function(c,cidx){elCell=document.createElement("div");elCell.classList.add("pivot-cell");if(rowclass){elCell.classList.add(rowclass)}if(!isPivot){elCell.classList.add(colAligns[cidx])}var w=viz.meas0CellWidth;if(w){elCell.style.maxWidth=w+"px";elCell.style.minWidth=w+"px";elCell.style.width=w+"px"}if(meas0FontSize){elCell.style.fontSize=meas0FontSize+"px"}if(c.length>1&&c[1]){elCell.style.backgroundColor=bgcolorPalette[c[1]];elCell.style.color=fgcolorPalette[c[1]]}if(!isPivot&&!VizUtil.isEmpty(c)&&c.length>0&&typeof c[0]==="string"&&/^(http:\/\/|https:\/\/)/.test(c[0])){elCellText=document.createElement("a");elCellText.setAttribute("href",c[0]);elCellText.setAttribute("target","_blank");elCellText.textContent=c[0];elCellText.onclick=PivotTableGenerator.onLinkClick}else{elCellText=document.createElement("span");var showPct=showPercentEnabled;if(measOps.length>1){showPct=showPct&&viz["meas"+cidx]&&VizUtil.getValueSuffix(viz["meas"+cidx+"WindowFunc"],viz["meas"+cidx].func)}else{showPct=showPct&&viz.meas0&&VizUtil.getValueSuffix(viz.meas0WindowFunc,viz.meas0.func)}if(VizUtil.isEmpty(c)||c.length===0||c[0]==="NA"){elCellText.textContent=" "}else{elCellText.textContent=isPivot||colAligns[cidx]==="num-col"?formatValue(c[0],showPct):c[0]}}if(pdata.extents&&pdata.extents[cidx]&&pdata.data.length>1&&_sortDir!==_SORT_NONE&&_sortIdx===cidx){elCellText.style.position="relative";var extent=pdata.extents[cidx];var scaleFunc=d3.scale.linear().domain(extent).range([10,90]);var zeroPoint=scaleFunc(0);var dataPoint=scaleFunc(c[0]);var left=c[0]<0?dataPoint+"%":zeroPoint+"%";var width=Math.abs(zeroPoint-dataPoint)+"%";var color=c[0]<0?"#f7a099":"#99e4f5";elCell.style.position="relative";var elCellBg=document.createElement("div");elCellBg.style.position="absolute";elCellBg.style.width=width;elCellBg.style.height="80%";elCellBg.style.top="10%";elCellBg.style.left=left;elCellBg.style.backgroundColor=color;elCellBg.style.padding="0";elCell.appendChild(elCellBg)}elCell.appendChild(elCellText);elRow.appendChild(elCell);if(isPivot){if(elCell.textContent!==" "){var htmlarr=[];htmlarr.push('<div class="pivot-table-frame pivot-data-popover">');pdata.rowhCols.forEach(function(_row,_ridx){htmlarr.push('<div class="pivot-row">');htmlarr.push('<div class="pivot-cell">');htmlarr.push(_row);htmlarr.push(":  </div>");htmlarr.push('<div class="pivot-cell value-cell">');htmlarr.push(pdata.rowh[ridx][_ridx]);htmlarr.push("</div>");htmlarr.push("</div>")});pdata.colhCols.forEach(function(_col){htmlarr.push('<div class="pivot-row">');htmlarr.push('<div class="pivot-cell">');htmlarr.push(_col);htmlarr.push(":  </div>");htmlarr.push('<div class="pivot-cell value-cell">');htmlarr.push(pdata.colh[cidx]);htmlarr.push("</div>");htmlarr.push("</div>")});htmlarr.push('<div class="pivot-row">');htmlarr.push('<div class="pivot-cell">');htmlarr.push(pdata.numMeas===0?"(count)":pdata.measCols[0]);htmlarr.push(":  </div>");htmlarr.push('<div class="pivot-cell value-cell">');htmlarr.push(elCell.textContent);htmlarr.push("</div>");htmlarr.push("</div>");htmlarr.push("</div>");$(elCell).balloon({contents:htmlarr.join(""),html:true})}}else{if(elCell.textContent.length>SHOW_BALLOON_THRESHOLD){var htmlarr=[];htmlarr.push('<div class="pivot-table-frame pivot-data-popover" style="max-width:600px">');htmlarr.push(elCell.textContent);htmlarr.push("</div>");$(elCell).balloon({contents:htmlarr.join(""),html:true})}}});if(isPivot&&pdata.rowTotals){elCell=document.createElement("div");elCell.classList.add("pivot-cell","row-total");if(rowclass){elCell.classList.add(rowclass)}var w=viz.meas0CellWidth;if(w){elCell.style.maxWidth=w+"px";elCell.style.minWidth=w+"px";elCell.style.width=w+"px"}if(meas0FontSize){elCell.style.fontSize=meas0FontSize+"px"}elCellText=document.createElement("span");var showPct=showPercentEnabled;showPct=showPct&&viz.meas0&&VizUtil.getValueSuffix(viz.meas0WindowFunc,viz.meas0.func);var c=pdata.rowTotals[ridx];elCellText.textContent=VizUtil.isEmpty(c)||c.length===0||c[0]==="NA"?" ":formatValue(c[0],showPct);elCell.appendChild(elCellText);elRow.appendChild(elCell)}}});if(viz.pivotShowTotals==="on"&&pdata.colTotals&&pdata.data.length>0&&!hideDataCells&&isPivot){var i,v;if(pdata.data.length<pdata.originalRowSize){elRow=document.createElement("div");elRow.classList.add("pivot-row");elPivot.appendChild(elRow);for(i=0;i<pdata.numRowh;i++){elCell=document.createElement("div");elCell.classList.add("pivot-cell");elRow.appendChild(elCell)}if(pdata.numMeas>1){for(i=0;i<pdata.numMeas;i++){elCell=document.createElement("div");elCell.classList.add("pivot-cell");elCell.textContent="⋮";elRow.appendChild(elCell)}}else{for(i=0;i<pdata.colh.length;i++){elCell=document.createElement("div");elCell.classList.add("pivot-cell");elCell.textContent="⋮";elRow.appendChild(elCell)}}}elRow=document.createElement("div");elRow.classList.add("pivot-row");elPivot.appendChild(elRow);var totals=pdata.colTotals.slice();for(i=0;i<pdata.numRowh;i++){elCell=document.createElement("div");elCell.classList.add("pivot-cell","total","text-col");if(rowh0TotalFontSize){elCell.style.fontSize=rowh0TotalFontSize+"px"}elCell.textContent=i===0?"Total":"";elRow.appendChild(elCell)}totals.forEach(function(total,totalidx){var showPct;if(pdata.numMeas>1){v=total;for(i=0;i<pdata.numMeas;i++){showPct=showPercentEnabled&&viz["meas"+i]&&VizUtil.getValueSuffix(viz["meas"+i+"WindowFunc"],viz["meas"+i].func);elCell=document.createElement("div");elCell.classList.add("pivot-cell","total");if(meas0TotalFontSize){elCell.style.fontSize=meas0TotalFontSize+"px"}if(pdata.numMeas===v.length){elCell.textContent=formatValue(v.length>=i?v[i]:"",showPct)}else{elCell.textContent=formatValue(v.length>=i*2?v[i*2]:"",showPct)}elRow.appendChild(elCell)}}else{if(totalidx<pdata.colh.length){showPct=showPercentEnabled&&viz.meas0&&VizUtil.getValueSuffix(viz.meas0WindowFunc,viz.meas0.func);v=total.shift();elCell=document.createElement("div");elCell.classList.add("pivot-cell","total");if(meas0TotalFontSize){elCell.style.fontSize=meas0TotalFontSize+"px"}elCell.textContent=formatValue(v,showPct);elRow.appendChild(elCell)}}});if(isPivot&&pdata.grandTotal){elCell=document.createElement("div");elCell.classList.add("pivot-cell","total");var w=viz.meas0CellWidth;if(w){elCell.style.maxWidth=w+"px";elCell.style.minWidth=w+"px";elCell.style.width=w+"px"}if(meas0FontSize){elCell.style.fontSize=meas0FontSize+"px"}elCellText=document.createElement("span");var showPct=showPercentEnabled;showPct=showPct&&viz.meas0&&VizUtil.getValueSuffix(viz.meas0WindowFunc,viz.meas0.func);var c=pdata.grandTotal;elCellText.textContent=VizUtil.isEmpty(c)||c.length===0||c[0]==="NA"?" ":formatValue(c[0],showPct);elCell.appendChild(elCellText);elRow.appendChild(elCell)}}if(headerSyncDelay){setTimeout(function(){_syncHeader(elTarget);_syncTitle(elTarget);_initScrollHandler(elTarget,prevState)},headerSyncDelay)}else{_syncHeader(elTarget);_syncTitle(elTarget);_initScrollHandler(elTarget,prevState)}};PivotTableGenerator.renderSingleValue=function(viz,data,elTarget){var numDecimalDigits=2;if(!isNaN(viz.numDecimalDigits)&&viz.numDecimalDigits!==""){numDecimalDigits=parseInt(viz.numDecimalDigits)}var useThousandSeparator=viz.useThousandSeparator!=="off";var suffix=viz.singlevalueShowPercent==="on"?"%":/^(napct|nnapct)$/.test(viz.meas0.func)?"%":"";var prefix=viz.currencySymbol||"";var formatValue=VizUtil.valueFormatterGenerator(numDecimalDigits,useThousandSeparator);var value=viz.dataDefaultValue||"<NA>";var pdata=null;if(data&&data.length>0){pdata=PivotTableGenerator.constructPivotData(viz,data);if(pdata.data.length>0&&pdata.data[0].length>0&&pdata.data[0][0].length>0){value=prefix+formatValue(!isNaN(pdata.data[0][0][0])?parseFloat(pdata.data[0][0][0]):pdata.data[0][0][0])+suffix}}var iconClass=viz.singlevalueIconClass||"";var fgColor=viz.singlevalueColor||"#4d4d4d";var bgColor=viz.singlevalueBgColor||"#ffffff";var border=viz.singlevalueBorder||"1px solid #d7d7d7";var padding=viz.singlevaluePadding||"0px 9px 0px 0px";var innerPadding=viz.singlevalueInnerPadding||"22px";var caption=viz.title||(viz.meas0.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.meas0.name);var $elBox=$(document.createElement("div"));$elBox.css({padding:padding}).attr("data-viz-type","singlevalue").addClass("single-value-box");var $elBoxInner=$(document.createElement("div"));$elBoxInner.css({padding:innerPadding,"background-color":bgColor,color:fgColor,border:border}).addClass("single-value-innerbox");var $elValue=$(document.createElement("div"));$elValue.text(value).addClass("single-value-text");var $elCaption=$(document.createElement("div"));$elCaption.text(caption).addClass("single-value-caption");var $elIconDiv=$(document.createElement("div"));if(iconClass){var $elIcon=$(document.createElement("i"));$elIcon.addClass("fa "+iconClass+" single-value-icon").appendTo($elIconDiv)}$elBox.append($elBoxInner.append($elValue).append($elCaption));$elBox.append($elIconDiv);$elBox.appendTo(elTarget)};PivotTableGenerator.onLinkClick=function(event){if(typeof module==="object"&&module.exports){if(event){event.preventDefault();event.stopPropagation()}global._guiShell.openExternal(this.getAttribute("href"));return false}else{return true}};PivotTableGenerator.constructPivotData=function(viz,data,sortIdx,sortDir){var isPivot=viz.marker==="pivot";var _t=new Date;var rowh=[];var colh=data[1].slice();var cells=[];var rowhCols=[];var rowhColDefs=[];var colhCols=[];var colhColDefs=[];var measCols=[];var measColDefs=[];var rowhIdx=0,colhIdx=0,measIdx=0,c,i,l;var colTotals=isPivot&&data.length>4&&!(data[4].length===1&&data[4][0]===null)?data[4]:null;var rowTotals=isPivot&&data.length>5&&!(data[5].length===1&&data[5][0]===null)?data[5]:null;var grandTotal=null;var sortAcrossGroup=viz.pivotSortWithinGroup==="off";if(colTotals){colTotals=colTotals.map(function(d){return typeof d==="string"&&isPivot?d.split(","):[d]})}if(rowTotals){rowTotals=rowTotals.map(function(d){return typeof d==="string"&&isPivot?d.split(","):[d]});grandTotal=rowTotals.pop()}data[0].forEach(function(dataRow){cells.push(dataRow.slice())});for(i=0,l=VizUtil.MAX_NUMBER_OF_CONTROLS.rowh;i<l;i++){c=viz["rowh"+i];if(c){rowhCols.push(c.name);rowhColDefs.push({option:"rowh"+i,column:c,title:viz["rowh"+i+"Title"],cellWidth:viz["rowh"+i+"CellWidth"],fontSize:viz["rowh"+i+"FontSize"]});rowhIdx++}}var numRowh=rowhCols.length;colh.splice(0,numRowh);if(numRowh>0){var rh;cells.forEach(function(r){rh=r.splice(0,numRowh);rowh.push(rh)})}for(i=0,l=VizUtil.MAX_NUMBER_OF_CONTROLS.colh;i<l;i++){c=viz["colh"+i];if(c){colhCols.push(c.name);colhColDefs.push({option:"colh"+i,column:c,title:viz["colh"+i+"Title"]});colhIdx++}}for(i=0,l=VizUtil.MAX_NUMBER_OF_CONTROLS.tcol;i<l;i++){c=viz["tcol"+i];if(c){colhCols.push(c.name);colhIdx++}}for(i=0,l=VizUtil.MAX_NUMBER_OF_CONTROLS.meas;i<l;i++){c=viz["meas"+i];if(c){measCols.push(c.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:c.name);measColDefs.push({option:"meas"+i,column:c,title:viz["meas"+i+"Title"]});measIdx++}}var numMeas=measCols.length;cells.forEach(function(dataRow){dataRow.forEach(function(d,didx){if(d===null||d===undefined){dataRow[didx]=[]}else{dataRow[didx]=typeof d==="string"&&isPivot?d.split(","):[d]}})});if(isPivot&&measIdx>1){colh=[];for(i=0;i<measIdx;i++){colh.push("measure"+i)}cells.forEach(function(dataRow){var measArr=dataRow.pop();if(measArr.length===measIdx){for(i=0,l=measArr.length;i<l;i++){dataRow.push([measArr[i]])}}else{for(i=0,l=measArr.length;i<l;i+=2){dataRow.push([measArr[i],measArr[i+1]])}}})}var sorted=PivotTableGenerator.sortPivotData(rowh,cells,rowTotals,sortIdx,sortDir,sortAcrossGroup);rowh=sorted.rowh;cells=sorted.cells;rowTotals=sorted.rowTotals;var extents=null;if(!isPivot){extents=colhCols.map(function(colname,idx){if(viz["tcol"+idx].isNumeric){var arr=[];cells.forEach(function(row){if(!isNaN(row[idx][0])){arr.push(row[idx][0])}});arr.push(0);var ext=d3.extent(arr);return ext}else{return false}})}console.log("Time Elapsed for pivoting data (ms): "+((new Date).getTime()-_t.getTime()));return{colh:colh,colhCols:colhCols,colhColDefs:colhColDefs,rowh:rowh,rowhCols:rowhCols,numRowh:numRowh,rowhColDefs:rowhColDefs,measCols:measCols,measColDefs:measColDefs,numMeas:numMeas,data:cells,colTotals:colTotals,rowTotals:rowTotals,grandTotal:grandTotal,originalRowSize:data[2][0],originalColSize:data[3][0]-numRowh,extents:extents}};PivotTableGenerator._sortDescending=function(a,b){a=a==="Inf"?Number.MAX_SAFE_INTEGER:a==="-Inf"?Number.MIN_SAFE_INTEGER+1:a;b=b==="Inf"?Number.MAX_SAFE_INTEGER:b==="-Inf"?Number.MIN_SAFE_INTEGER+1:b;return d3.descending(a,b)};PivotTableGenerator._sortAscending=function(a,b){a=a==="Inf"?Number.MAX_SAFE_INTEGER:a==="-Inf"?Number.MIN_SAFE_INTEGER+1:a;b=b==="Inf"?Number.MAX_SAFE_INTEGER:b==="-Inf"?Number.MIN_SAFE_INTEGER+1:b;return d3.ascending(a,b)};PivotTableGenerator.sortPivotData=function(rowh,cells,rowTotals,sortIdx,sortDir,sortAcrossGroup){if(sortDir===_SORT_NONE){return{rowh:rowh,cells:cells,rowTotals:rowTotals}}var newrowh=[];var newrowTotals=null;if(rowTotals){newrowTotals=[];cells.forEach(function(cellrow,idx){cellrow.push(rowTotals[idx])})}cells.forEach(function(cellrow,idx){cellrow.push(rowh[idx])});var sortfunc=sortDir===_SORT_DESC?PivotTableGenerator._sortDescending:PivotTableGenerator._sortAscending;var nestedData=null,v;if(rowh.length>0&&rowh[0].length>1&&!sortAcrossGroup){nestedData=d3.nest().key(function(d){v=d[d.length-1].slice();v.pop();return v.join("::")}).entries(cells)}else{nestedData=[{key:rowh[0],values:cells}]}nestedData.forEach(function(group){group.values.sort(function(a,b){return sortfunc(VizUtil.isEmpty(a[sortIdx][0])?Number.MIN_SAFE_INTEGER:isNaN(a[sortIdx][0])||typeof a[sortIdx][0]==="boolean"||a[sortIdx][0]===""?a[sortIdx][0]:parseFloat(a[sortIdx][0]),VizUtil.isEmpty(b[sortIdx][0])?Number.MIN_SAFE_INTEGER:isNaN(b[sortIdx][0])||typeof b[sortIdx][0]==="boolean"||b[sortIdx][0]===""?b[sortIdx][0]:parseFloat(b[sortIdx][0]))})});var newcells=[];nestedData.forEach(function(group){newcells=newcells.concat(group.values)});newcells.forEach(function(cellrow){newrowh.push(cellrow.pop());if(rowTotals){newrowTotals.push(cellrow.pop())}});return{rowh:newrowh,cells:newcells,rowTotals:newrowTotals}};PivotTableGenerator.getRenderFunction=function(viz,data,headerSyncDelay,onLoadCallback,onErrorCallback){var func=function(props){viz.width=props.width;viz.height=props.height;var elTarget=props.elem;PivotTableGenerator.render(viz,data,elTarget,false,headerSyncDelay,onLoadCallback,onErrorCallback)};return func};if(typeof module==="object"&&module.exports)module.exports=PivotTableGenerator;"use strict";var PlotlyGraphGenerator=function(){};var _adjustColor=function(str,ratio){var p=typeof ratio==="string"?parseFloat(ratio):ratio;var code=_getRGBACode(str);var r=Math.max(0,Math.min(255,code.r*p));var g=Math.max(0,Math.min(255,code.g*p));var b=Math.max(0,Math.min(255,code.b*p));var a=code.a;return"rgba("+r+","+g+","+b+","+a+")"};var _setOpacity=function(str,opacity){var p=typeof ratio==="string"?parseFloat(opacity):opacity;var code=_getRGBACode(str);return"rgba("+code.r+","+code.g+","+code.b+","+p+")"};var _getRGBACode=function(str){var s,r,g,b,a;if(/rgb/.test(str)){s=str.replace(/(rgb\(|rgba\(|\))/g,"");s=s.split(",");r=parseInt(s[0]);g=parseInt(s[1]);b=parseInt(s[2]);a=s.length>3?s[3]:1}else{s=str.replace("#","");r=parseInt(s.substring(0,2),16);g=parseInt(s.substring(2,4),16);b=parseInt(s.substring(4,6),16);a=1}return{r:r,g:g,b:b,a:a}};function calculateStackedYValue(traces){var i;for(i=0;i<traces.length;i++){traces[i]["stacky"]=traces[i]["y"].slice()}for(i=1;i<traces.length;i++){for(var j=0;j<Math.min(traces[i]["stacky"].length,traces[i-1]["stacky"].length);j++){traces[i]["stacky"][j]+=traces[i-1]["stacky"][j]}}return traces}function convertToStackedYValue(traces){calculateStackedYValue(traces);traces.forEach(function(trace){trace.origy=trace.y;trace.y=trace.stacky});return traces}var isAllUnique=function(arr){var i=0,l=0,v=arr[0];for(i=0,l=arr.length;i<l;i++){if(v!==arr[i]){return false}}return true};var makeArrayUnique=function(arr){var h={},res=[];arr.forEach(function(i){if(!h[i]){res.push(i);h[i]=true}});return res};var isAllNull=function(arr){var i=0,l=0,isAllNull=true;for(i=0,l=arr.length;i<l;i++){if(arr[i]!==null){isAllNull=false;break}}return isAllNull};var isArray=function(o){return Object.prototype.toString.call(o)==="[object Array]"};var consolidateRefLines=function(gReflineLayerData){var hash={},id=null,d=null;gReflineLayerData.forEach(function(g){id=g.yaxis||"y";d=hash[id];if(!d){hash[id]=g}else{if(g.x&&isArray(g.x)){d.x=d.x.concat(g.x)}if(g.y&&isArray(g.y)){d.y=d.y.concat(g.y)}if(g.z&&isArray(g.z)){d.z=d.z.concat(g.z)}if(g.text&&isArray(g.text)){d.text=d.text.concat(g.text)}}});var gData=Object.values(hash).map(function(g){if(!g.text){return g}var text="";g.text.forEach(function(t){if(t&&t.length>text.length){text=t}});g.text=text;return g});return gData};var recalculateRefLineData=function(viz,gRefLineLayerData,layout){if(!viz.x){return}if(!VizUtil.returnsNumericValue(viz.x)){gRefLineLayerData.forEach(function(g){if(!g||!g.x||g.x.length===0){return}var hash={},newx=[],newy=[];g.x.forEach(function(xval,idx){if(!VizUtil.isEmpty(xval)){if(!hash[xval]){newx.push(xval);hash[xval]=[]}hash[xval].push(g.y[idx])}});var yvals;g.x=newx;g.y=newx.map(function(xval){yvals=hash[xval].filter(function(v){return!!v});if(yvals.length>0){return yvals[0]}else{return null}});var reflineGroup=viz[(g.customdata?g.customdata.yOp||"y":"y")+"ReflineGroup"];if(viz.facet&&viz.facetSyncXAxis==="off"||/^(xaxis|xaxis\+facet)$/.test(reflineGroup)){newx=[],newy=[];g.x.forEach(function(v,idx){if(!VizUtil.isEmpty(g.y[idx])){newx.push(v);newy.push(g.y[idx])}});g.x=newx;g.y=newy}if(!/xaxis/.test(reflineGroup)){yvals=g.y.filter(function(v){return!!v});if(yvals.length>0){g.y=g.y.map(function(){return yvals[0]})}}})}else{gRefLineLayerData.forEach(function(g){if(!g||!g.x||g.x.length===0){return}if(/xaxis/.test(viz[(g.customdata?g.customdata.yOp||"y":"y")+"ReflineGroup"])){return}var isDiagonal=g.customdata&&g.customdata.type==="diagonal";var range;if(g.xaxis&&layout[g.xaxis.replace(/^x/,"xaxis")].range){range=layout[g.xaxis.replace(/^x/,"xaxis")].range}else{range=d3.extent(g.x);range[0]=range[0]-Math.abs(range[1]-range[0])*.1;range[1]=range[1]+Math.abs(range[1]-range[0])*.1}var step=Math.abs(range[1]-range[0])/100;var x=[],y=[],yval=null,i;for(i=0;i<g.x.length;i++){if(g.x[i]!==null&&g.y[i]!==null){yval=g.y[i];break}}for(i=0;i<100;i++){x.push(range[0]+step*i);y.push(isDiagonal?range[0]+step*i:yval)}g.x=x;g.y=y})}gRefLineLayerData.forEach(function(g){g.text=g.y.map(function(v){return(g.name?g.name+": ":"")+formatValue(v)})})}
;var recalculateVRefLineData=function(viz,gVRefLineLayerData,layout){if(!viz.y){return}if(!VizUtil.returnsNumericValue(viz.y)){gVRefLineLayerData.forEach(function(g){if(!g||!g.y||g.y.length===0){return}var hash={},newx=[],newy=[];g.y.forEach(function(yval,idx){if(!VizUtil.isEmpty(yval)){if(!hash[yval]){newy.push(yval);hash[yval]=[]}hash[yval].push(g.x[idx])}});var xvals;g.y=newy;g.x=newy.map(function(yval){xvals=hash[yval].filter(function(v){return!!v});if(xvals.length>0){return xvals[0]}else{return null}});if(viz.facet&&viz.facetSyncYAxis==="off"){newx=[],newy=[];g.y.forEach(function(v,idx){if(!VizUtil.isEmpty(g.x[idx])){newx.push(g.x[idx]);newy.push(v)}});g.x=newx;g.y=newy}if(!/yaxis/.test(viz.xReflineGroup)){xvals=g.x.filter(function(v){return!!v});if(xvals.length>0){g.x=g.x.map(function(){return xvals[0]})}}})}else{gVRefLineLayerData.forEach(function(g){if(!g||!g.y||g.y.length===0){return}if(/yaxis/.test(viz.xReflineGroup)){return}var range;if(g.yaxis&&layout[g.yaxis.replace(/^y/,"yaxis")].range){range=layout[g.yaxis.replace(/^y/,"yaxis")].range}else{range=d3.extent(g.y);range[0]=range[0]-Math.abs(range[1]-range[0])*.1;range[1]=range[1]+Math.abs(range[1]-range[0])*.1}if(viz.marker==="hist"){range[0]=0}var step=Math.abs(range[1]-range[0])/100;var x=[],y=[],xval=null,i;for(i=0;i<g.y.length;i++){if(g.x[i]!==null&&g.y[i]!==null){xval=g.x[i];break}}for(i=0;i<100;i++){x.push(xval);y.push(range[0]+step*i)}g.x=x;g.y=y})}gVRefLineLayerData.forEach(function(g){g.text=g.x.map(function(v){return(g.name?g.name+": ":"")+formatValue(v)})})};var recalculateDiagonalRefLineData=function(reflineGroup){if(!reflineGroup||reflineGroup.customdata.type!=="diagonal"){return reflineGroup}var xrange=d3.extent(reflineGroup.x);var yrange=d3.extent(reflineGroup.y);xrange[0]=xrange[0]-Math.abs(xrange[1]-xrange[0])*.1;xrange[1]=xrange[1]+Math.abs(xrange[1]-xrange[0])*.1;var step=Math.abs(xrange[1]-xrange[0])/100;var x=[],y=[],v;for(var i=0;i<100;i++){v=xrange[0]+step*i;x.push(v);y.push(v)}reflineGroup.x=x;reflineGroup.y=y};PlotlyGraphGenerator._convertGraphDataForScatterLineGroupedByLabel=function(gData){gData.forEach(function(d){if(!d._label||!d.text||!/^lines/.test(d.mode)){return}var hash={},i=0,label;for(i=0;i<d._label.length;i++){label=d._label[i];if(!hash[label]){hash[label]={x:[null],y:[null],z:[null],text:[null]}}hash[label].text.push(d.text[i]);if(d.x){hash[label].x.push(d.x[i])}if(d.y){hash[label].y.push(d.y[i])}if(d.z){hash[label].z.push(d.z[i])}}var x=[],y=[],z=[],text=[];Object.keys(hash).forEach(function(key){x=x.concat(hash[key].x);y=y.concat(hash[key].y);z=z.concat(hash[key].z);text=text.concat(hash[key].text.map(function(d,idx,arr){return idx===arr.length-1?d:d===null?null:""}))});d.text=text;if(d.x){d.x=x}if(d.y){d.y=y}if(d.z){d.z=z}})};var calculateRange=function(gData,targetProp,showZero,isDate,marker,valueOnPlotProp,isFacet,barstyle,color,isMultiY,rangeTarget,topMarginRatio,bottomMarginRatio){if(targetProp==="x"&&/^(line|area|bar)$/.test(marker)){return null}rangeTarget=rangeTarget||"all";var dataArr=[];gData.forEach(function(d){if(rangeTarget==="y1"&&d.use2ndAxis){return}else if(rangeTarget==="y2"&&!d.use2ndAxis){return}if(d[targetProp]){dataArr=dataArr.concat(d[targetProp])}if(targetProp==="y"&&d.error_y&&d.error_y.array&&d.error_y.array.length===d[targetProp].length){d[targetProp].forEach(function(v,idx){dataArr.push(v+d.error_y.array[idx]);if(d.error_y.arrayminus){dataArr.push(v-d.error_y.arrayminus[idx])}else{dataArr.push(v-d.error_y.array[idx])}})}});if(isDate){dataArr=dataArr.map(function(d){return Date.parse(d)})}if(showZero&&!isDate){dataArr.push(0)}var ext=d3.extent(dataArr);if(!ext||ext.length!==2||typeof ext[0]!=="number"||typeof ext[1]!=="number"){return null}var _topMarginRatio=.17;var _bottomMarginRatio=.17;if(targetProp!=="x"&&/^(bar)$/.test(marker)){_bottomMarginRatio=.04}if(valueOnPlotProp==="bottom"){_bottomMarginRatio=.2}if(topMarginRatio){_topMarginRatio=topMarginRatio}if(bottomMarginRatio){_bottomMarginRatio=bottomMarginRatio}ext[0]=ext[0]-Math.abs(ext[1]-ext[0])*_bottomMarginRatio;ext[1]=ext[1]+Math.abs(ext[1]-ext[0])*_topMarginRatio;return ext};var flattenDataByFacet=function(viz,nestData){var newData=[];if(viz.facet){nestData.forEach(function(g){var n=d3.nest().key(function(d){return d[viz.facet.label]}).entries(g.values);n.forEach(function(t){t.facet=t.key;t.key=g.key;if(g.ycolname){t.ycolname=g.ycolname}if(g.winfunc){t.winfunc=g.winfunc}if(g.yOp){t.yOp=g.yOp}if(g.use2ndAxis){t.use2ndAxis=g.use2ndAxis}});newData=newData.concat(n)});return newData}else{return nestData}};PlotlyGraphGenerator._flattenDataByFacet=flattenDataByFacet;var convertToStackedAreas=function(gData){var facets={};gData.forEach(function(g){if(!facets[g.facet]){facets[g.facet]=[];g.fill="tozeroy"}else{g.fill="tonexty"}facets[g.facet].push(g)});Object.keys(facets).forEach(function(key){convertToStackedYValue(facets[key])})};var formatValue=VizUtil.valueFormatterGenerator(2,true);var constructFacetData=function(viz,gData,layout,defaultColor,gRangeLayerData,gTrendLineLayerData,gTrendLineRangeLayerData,colsOn2ndAxis,gRefLineLayerData,gRefLineUpperRangeLayerData,gRefLineLowerRangeLayerData,gVRefLineLayerData,gVRefLineConfIntLayerData){if(viz.facet){var marker=viz.marker;var ys=VizUtil.getOptions(viz,"y");var isMultiY=ys.length>1;var numY=0;ys.forEach(function(_y){if(_y){numY++}});var xAxisShowTitle=viz.xAxisShowTitle!=="off";var yAxisShowTitle=viz.yAxisShowTitle!=="off";var y2AxisShowTitle=viz.y2AxisShowTitle!=="off";var userXAxisRange=PlotlyGraphGenerator.getAxisRange(viz.xAxisRange);var userYAxisRange=PlotlyGraphGenerator.getAxisRange(viz.yAxisRange);var userY2AxisRange=PlotlyGraphGenerator.getAxisRange(viz.y2AxisRange);var y1ValueSuffix="",y2ValueSuffix="";if(viz.y){y1ValueSuffix=VizUtil.getValueSuffix(viz.yWindowFunc,viz.y.func)}if(colsOn2ndAxis&&colsOn2ndAxis.length>0){ys.forEach(function(y,idx){if(y2ValueSuffix){return}if(viz["y"+idx+"Use2ndAxis"]){y2ValueSuffix=y&&VizUtil.getValueSuffix(viz["y"+idx+"WindowFunc"],y.func)}})}var fvalues0=gData.map(function(g){return g.facet});var fvalues=[];fvalues0.forEach(function(v,idx){if(fvalues0.indexOf(v)===idx){fvalues.push(v)}});var ncols=viz.numFacetColumns||"auto";if(ncols==="auto"){ncols=Math.min(VizUtil.DEFAULT_FACET_SIZE,fvalues.length)}var nrows=Math.ceil(fvalues.length/ncols);var X_AXIS_AREA_HEIGHT=80;var X_AXIS_AREA_HEIGHT_PLUS_MARGIN=X_AXIS_AREA_HEIGHT+10;var Y_AXIS_AREA_WIDTH=40;if(viz.facetSyncYAxis==="off"&&gData.filter(function(g){return g.use2ndAxis}).length>0){Y_AXIS_AREA_WIDTH*=2}var facetW=(layout.width-layout.margin.l)/ncols;if(viz.facetSqueezePlots!=="on"){if(marker==="scatter"){layout.height=(facetW+X_AXIS_AREA_HEIGHT)*nrows+layout.margin.t}else{if(nrows>2){layout.height=Math.max(layout.height,(facetW+X_AXIS_AREA_HEIGHT)*nrows+layout.margin.t)}}}var facetY=(layout.height-layout.margin.t)/nrows;var xdomain=[],ydomain=[],i;for(i=0;i<ncols;i++){xdomain.push(i)}for(i=0;i<nrows;i++){ydomain.push(i)}var paddingRatio=Y_AXIS_AREA_WIDTH/facetW;var xscale=d3.scale.ordinal().domain(xdomain).rangeBands([0,100],paddingRatio,0);var xrange=xscale.range();var xrangeBand=xscale.rangeBand();xrangeBand=Math.max(xrangeBand,1);paddingRatio=X_AXIS_AREA_HEIGHT_PLUS_MARGIN/facetY;var yscale=d3.scale.ordinal().domain(ydomain).rangeBands([0,100],paddingRatio,0);var yrange=yscale.range().reverse();var yrangeBand=yscale.rangeBand();yrangeBand=Math.max(yrangeBand,1);delete layout.xaxis;delete layout.yaxis;delete layout.yaxis2;delete layout.zaxis;if(marker==="area"){convertToStackedAreas(gData)}var syncXAxis=viz.facetSyncXAxis!=="off";if(!viz.facetSyncXAxis&&viz.facetEnableDataCompletion==="off"){syncXAxis=false}var syncYAxis=viz.facetSyncYAxis!=="off";if(!viz.facetSyncYAxis&&viz.facetEnableDataCompletion==="off"){syncYAxis=false}var gd=gData;if(gRangeLayerData){gd=gd.concat(gRangeLayerData)}if(gTrendLineLayerData){gd=gd.concat(gTrendLineLayerData)}if(gTrendLineRangeLayerData){gd=gd.concat(gTrendLineRangeLayerData)}if(gRefLineUpperRangeLayerData){gd=gd.concat(gRefLineUpperRangeLayerData)}if(gRefLineLowerRangeLayerData){gd=gd.concat(gRefLineLowerRangeLayerData)}if(gRefLineLayerData){gd=gd.concat(gRefLineLayerData)}if(gVRefLineConfIntLayerData){gd=gd.concat(gVRefLineConfIntLayerData)}if(gVRefLineLayerData){gd=gd.concat(gVRefLineLayerData)}var includeZeroOnXAxis=/^(scatter|bubble)$/.test(marker)&&viz.xAxisIncludeZero==="on";var xAxisRange=syncXAxis?calculateRange(gData,"x",includeZeroOnXAxis,viz.x&&VizUtil.returnsDateValue(viz.x),marker,viz.yValueOnPlot,true,viz.barstyle,viz.color,isMultiY):null;var includeZeroOnYAxis=/^(scatter|bubble)$/.test(marker)&&viz.yAxisIncludeZero==="on"||/^(bar|line)$/.test(marker)&&viz.yAxisIncludeZero!=="off";var yAxisRange=syncYAxis?calculateRange(gd,"y",includeZeroOnYAxis,false,marker,viz.yValueOnPlot,null,null,null,null,"y1"):null;var includeZeroOnY2Axis=/^(scatter|bubble)$/.test(marker)&&viz.y2AxisIncludeZero==="on"||/^(bar|line)$/.test(marker)&&viz.y2AxisIncludeZero!=="off";var y2AxisRange=syncYAxis?calculateRange(gd,"y",includeZeroOnY2Axis,false,marker,viz.yValueOnPlot,null,null,null,null,"y2"):null;var xAxisTitleFontSize=viz.facetTitleFontSize||viz.xAxisTitleFontSize||(marker!=="pie"&&ncols>6||marker==="pie"&&ncols>2?12:14);var yAxisTitleFontSize=viz.yAxisTitleFontSize||14;var y2AxisTitleFontSize=viz.y2AxisTitleFontSize||14;var yAxisTitle=viz.yAxisTitle;if(!yAxisTitle){if(marker==="hist"){yAxisTitle=VizUtil.FREQ_COL_LABEL}else if(viz.y){yAxisTitle=viz.y.name===VizUtil.NUMROWS_COL_NAME?VizUtil.NUMROWS_COL_LABEL:viz.y.name}else{yAxisTitle=""}}var y2AxisTitle=viz.y2AxisTitle;if(!y2AxisTitle){if(marker==="hist"){y2AxisTitle=VizUtil.FREQ_COL_LABEL}else if(colsOn2ndAxis&&colsOn2ndAxis.length>0){y2AxisTitle=colsOn2ndAxis[0].name===VizUtil.NUMROWS_COL_NAME?VizUtil.NUMROWS_COL_LABEL:colsOn2ndAxis[0].name}else{y2AxisTitle=""}}var xAxisTickFontSize=viz.xAxisTickFontSize||10;var yAxisTickFontSize=viz.yAxisTickFontSize||10;var y2AxisTickFontSize=viz.y2AxisTickFontSize||10;var facetShowZeroLine=viz.facetShowZeroLine!=="off";var arr=[],reflineHash={},vreflineHash={};gData.forEach(function(g,gidx){var idx=fvalues.indexOf(g.facet);var xidx=idx%ncols;var yidx=Math.floor(idx/ncols);var x=xrange[xidx];var y=yrange[yidx];var axisIdx=idx*2+1;var xaxisIdx=axisIdx;var yaxisIdx=axisIdx+(g.use2ndAxis?1:0);var legendgroup=g.name+(g.yOp||"");g.legendgroup=legendgroup;if(arr.indexOf(legendgroup)===-1){arr.push(legendgroup)}else{g.showlegend=false}layout["xaxis"+xaxisIdx]={domain:[x/100,(x+xrangeBand)/100],anchor:"y"+yaxisIdx,title:xAxisShowTitle?g.facet:"",titlefont:{size:xAxisTitleFontSize},tickfont:{size:xAxisTickFontSize},zeroline:facetShowZeroLine,showticklabels:true,zerolinecolor:VizUtil.ZERO_LINE_COLOR};if(xAxisRange){layout["xaxis"+xaxisIdx].range=xAxisRange;if(userXAxisRange){layout["xaxis"+xaxisIdx].range=userXAxisRange}if(viz.xAxisTickStep&&viz.x&&viz.x.isNumeric){layout["xaxis"+xaxisIdx].dtick=viz.xAxisTickStep}}if(viz.showXGridLines&&viz.showXGridLines!=="default"){layout["xaxis"+xaxisIdx].showgrid=viz.showXGridLines==="on"}if(!viz.x){layout["xaxis"+xaxisIdx].zeroline=false}if(viz.showXZeroLine&&viz.showXZeroLine!=="default"){layout["xaxis"+xaxisIdx].zeroline=viz.showXZeroLine==="on"}if(!viz.x){layout["xaxis"+xaxisIdx].showticklabels=false}else{if(viz.x.func==="aschar"||!viz.x.isNumeric&&!viz.x.isDate){layout["xaxis"+xaxisIdx].type="category"}}if(g.use2ndAxis){layout["yaxis"+yaxisIdx]={domain:[y/100,(y+yrangeBand)/100],anchor:"x"+xaxisIdx,title:xidx===ncols-1&&yidx===0&&y2AxisShowTitle?y2AxisTitle:null,titlefont:{size:y2AxisTitleFontSize},tickfont:{size:y2AxisTickFontSize},showticklabels:xidx===ncols-1||!syncYAxis,zeroline:facetShowZeroLine,zerolinecolor:VizUtil.ZERO_LINE_COLOR,ticksuffix:y2ValueSuffix,side:"right",overlaying:"y"+(yaxisIdx-1)};if(y2AxisRange){layout["yaxis"+yaxisIdx].range=y2AxisRange}if(userY2AxisRange){layout["yaxis"+yaxisIdx].range=userY2AxisRange}if(viz.y2AxisTickStep&&viz.y&&viz.y.isNumeric){layout["yaxis"+yaxisIdx].dtick=viz.y2AxisTickStep}layout["yaxis"+yaxisIdx].showgrid=viz.showY2GridLines==="on";layout["yaxis"+yaxisIdx].zeroline=viz.showY2ZeroLine==="on"}else{layout["yaxis"+yaxisIdx]={domain:[y/100,(y+yrangeBand)/100],anchor:"x"+xaxisIdx,title:xidx===0&&yidx===0&&yAxisShowTitle?yAxisTitle:null,titlefont:{size:yAxisTitleFontSize},tickfont:{size:yAxisTickFontSize},showticklabels:xidx===0||!syncYAxis,zeroline:facetShowZeroLine,zerolinecolor:VizUtil.ZERO_LINE_COLOR,ticksuffix:y1ValueSuffix};if(yAxisRange){layout["yaxis"+yaxisIdx].range=yAxisRange}if(userYAxisRange){layout["yaxis"+yaxisIdx].range=userYAxisRange}if(viz.yAxisTickStep&&viz.y&&viz.y.isNumeric){layout["yaxis"+yaxisIdx].dtick=viz.yAxisTickStep}if(viz.showYGridLines&&viz.showYGridLines!=="default"){layout["yaxis"+yaxisIdx].showgrid=viz.showYGridLines==="on"}if(viz.showYZeroLine&&viz.showYZeroLine!=="default"){layout["yaxis"+yaxisIdx].zeroline=viz.showYZeroLine==="on"}}g.xaxis="x"+xaxisIdx;g.yaxis="y"+yaxisIdx;if(!viz.color&&!isMultiY){if(!g.marker){g.marker={}}g.marker.color=defaultColor||"rgb(31, 119, 180)"}if(gRangeLayerData&&gRangeLayerData.length>0){gRangeLayerData[gidx].xaxis="x"+xaxisIdx;gRangeLayerData[gidx].yaxis="y"+yaxisIdx;gRangeLayerData[gidx].legendgroup="lg"+g.name;g.legendgroup="lg"+g.name;if(!g.x||g.x.length===0){gRangeLayerData[gidx].x=[];gRangeLayerData[gidx].y=[]}}if(gTrendLineLayerData&&gTrendLineLayerData.length>0){gTrendLineLayerData[gidx].xaxis="x"+xaxisIdx;gTrendLineLayerData[gidx].yaxis="y"+yaxisIdx;gTrendLineLayerData[gidx].legendgroup="lg"+g.name;g.legendgroup="lg"+g.name;if(!g.x||g.x.length===0){gTrendLineLayerData[gidx].x=[];gTrendLineLayerData[gidx].y=[]}}if(gTrendLineRangeLayerData&&gTrendLineRangeLayerData.length>0){gTrendLineRangeLayerData[gidx].xaxis="x"+xaxisIdx;gTrendLineRangeLayerData[gidx].yaxis="y"+yaxisIdx;gTrendLineRangeLayerData[gidx].legendgroup="lg"+g.name;g.legendgroup="lg"+g.name;if(!g.x||g.x.length===0){gTrendLineRangeLayerData[gidx].x=[];gTrendLineRangeLayerData[gidx].y=[]}}if(gRefLineUpperRangeLayerData&&gRefLineUpperRangeLayerData.length>0&&gRefLineUpperRangeLayerData[gidx]){gRefLineUpperRangeLayerData[gidx].xaxis="x"+xaxisIdx;gRefLineUpperRangeLayerData[gidx].yaxis="y"+yaxisIdx;gRefLineUpperRangeLayerData[gidx].legendgroup="refline"+g.name;gRefLineUpperRangeLayerData[gidx].visible=!reflineHash["x"+xaxisIdx+"y"+yaxisIdx+(gRefLineUpperRangeLayerData[gidx].customdata.yOp||"")];if(!g.x||g.x.length===0){gRefLineUpperRangeLayerData[gidx].x=[];gRefLineUpperRangeLayerData[gidx].y=[]}}if(gRefLineLowerRangeLayerData&&gRefLineLowerRangeLayerData.length>0&&gRefLineLowerRangeLayerData[gidx]){gRefLineLowerRangeLayerData[gidx].xaxis="x"+xaxisIdx;gRefLineLowerRangeLayerData[gidx].yaxis="y"+yaxisIdx;gRefLineLowerRangeLayerData[gidx].legendgroup="refline"+g.name;gRefLineLowerRangeLayerData[gidx].visible=!reflineHash["x"+xaxisIdx+"y"+yaxisIdx+(gRefLineLowerRangeLayerData[gidx].customdata.yOp||"")];if(!g.x||g.x.length===0){gRefLineLowerRangeLayerData[gidx].x=[];gRefLineLowerRangeLayerData[gidx].y=[]}}if(gRefLineLayerData&&gRefLineLayerData.length>0&&gRefLineLayerData[gidx]){gRefLineLayerData[gidx].xaxis="x"+xaxisIdx;gRefLineLayerData[gidx].yaxis="y"+yaxisIdx;gRefLineLayerData[gidx].legendgroup="refline"+g.name;if(!g.x||g.x.length===0){gRefLineLayerData[gidx].x=[];gRefLineLayerData[gidx].y=[]}if(isAllNull(gRefLineLayerData[gidx].y)){gRefLineLayerData[gidx].visible=false}else{gRefLineLayerData[gidx].visible=!reflineHash["x"+xaxisIdx+"y"+yaxisIdx+(gRefLineLayerData[gidx].customdata.yOp||"")];reflineHash["x"+xaxisIdx+"y"+yaxisIdx+(gRefLineLayerData[gidx].customdata.yOp||"")]=true}}if(gVRefLineLayerData&&gVRefLineLayerData.length>0){gVRefLineLayerData[gidx].xaxis="x"+xaxisIdx;gVRefLineLayerData[gidx].yaxis="y"+yaxisIdx;if(!g.x||g.x.length===0){gVRefLineLayerData[gidx].x=[];gVRefLineLayerData[gidx].y=[]}if(isAllNull(gVRefLineLayerData[gidx].x)){gVRefLineLayerData[gidx].visible=false}else{gVRefLineLayerData[gidx].visible=!vreflineHash["x"+xaxisIdx+"y"+yaxisIdx];vreflineHash["x"+xaxisIdx+"y"+yaxisIdx]=true}}if(gVRefLineConfIntLayerData&&gVRefLineConfIntLayerData.length>0){gVRefLineConfIntLayerData[gidx].xaxis="x"+xaxisIdx;gVRefLineConfIntLayerData[gidx].yaxis="y"+yaxisIdx;if(!g.x||g.x.length===0){gVRefLineConfIntLayerData[gidx].x=[];gVRefLineConfIntLayerData[gidx].y=[]}}});if(/^(bar|line|area|scatter)$/.test(viz.marker)&&viz.facet&&!syncXAxis){var h={};gData.forEach(function(g){if(!h[g.facet]){h[g.facet]=[]}h[g.facet].push(g)});Object.keys(h).forEach(function(key){var i=0,group=h[key];while(i<group[0].y.length){var allzero=true,allnull=true;group.forEach(function(d){allzero=d.y[i]===0&&allzero;allnull=d.y[i]===null&&allnull});if(allzero||allnull){group.forEach(function(d){d.y.splice(i,1);if(d.x&&isArray(d.x)&&i<d.x.length){d.x.splice(i,1)}if(d.text&&isArray(d.text)&&i<d.text.length){d.text.splice(i,1)}if(d.customdata&&isArray(d.customdata)&&i<d.customdata.length){d.customdata.splice(i,1)}if(d.error_y&&d.error_y.array&&isArray(d.error_y.array)&&i<d.error_y.array.length){d.error_y.array.splice(i,1)}if(d.error_y&&d.error_y.arrayminus&&isArray(d.error_y.arrayminus)&&i<d.error_y.arrayminus.length){d.error_y.arrayminus.splice(i,1)}})}else{i++}}})}if(layout.showlegend!==false){layout.showlegend=numY>1||!!viz.color}}return{layout:layout,gData:gData}};PlotlyGraphGenerator._constructFacetData=constructFacetData;PlotlyGraphGenerator.reverseColorOrder=function(gData){var len=gData.length,i;var colors=gData.map(function(g){return g.fillcolor?g.fillcolor:g.marker.color});var colorBuckets=[];var lastc=null;for(i=0;i<len;i++){if(lastc!==colors[i]){colorBuckets.push(colors[i]);lastc=colors[i]}}lastc=null;var newc=null;for(i=0;i<len;i++){if(lastc!==colors[i]){newc=colorBuckets.pop();lastc=colors[i]}if(gData[i].fillcolor){gData[i].fillcolor=newc}else{gData[i].marker.color=newc}}return gData};PlotlyGraphGenerator._switchOrientation=function(gData,layout){var x;gData.forEach(function(data){x=data.x;data.x=data.y;data.y=x;x=data.xaxis;data.xaxis=data.yaxis?data.yaxis.replace("y","x"):null;data.yaxis=x?x.replace("y","x"):null;if(data.xaxis===null){delete data.xaxis}if(data.yaxis===null){delete data.yaxis}if(data.orientation&&data.orientation==="h"){delete data.orientation}else{data.orientation="h"}});x=layout.xaxis;layout.xaxis=layout.yaxis;layout.yaxis=x;layout.yaxis.autorange="reversed";layout.yaxis.ticksuffix=" ";if(layout.yaxis2){layout.xaxis2=layout.yaxis2;layout.xaxis2.overlaying="x";layout.xaxis2.side="top";delete layout.yaxis2}if(layout.annotations){layout.annotations.forEach(function(data){x=data.x;data.x=data.y;data.y=x;data.xanchor="left";data.yanchor="middle"})}};PlotlyGraphGenerator._addCustomBalloon=function(elem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback){if(!onShowDetailCallback&&!onKeepThisCallback&&!onExcludeCallback){return}var traces={};var handler=function(data){var $balloon=$("#viz-balloon");if($balloon.length===0){$balloon=$('<div id="viz-balloon"/>');$(elem).append($balloon)}else{$balloon.empty()}var isMultiSelect=data.event.ctrlKey||data.event.metaKey;var cdata;var $row;var $head=$('<div class="balloon-header"></div>');$balloon.append($head);var $htable=$('<div class="balloon-header-table"></div>');$head.append($htable);var $hrow=$('<div class="balloon-header-table-row"></div>');$htable.append($hrow);var $body=$('<div class="balloon-body"></div>');var $table=$('<div class="balloon-body-table"></div>');$body.append($table);$balloon.append($body);if(data.points&&data.points.length>0){var isPie=false,isBoxplot=false,isLine=false,isArea=false,isHeatmap=false,v;cdata=data.points[0].customdata;if(data.points.trace&&data.points.trace.type&&data.points.trace.type==="pie"){var idx=data.points.trace.labels.indexOf(data.points[0].label);cdata=data.points.trace.customdata[idx];isPie=true}if(cdata){isBoxplot=data.points[0].data&&data.points[0].data.type==="box";isHeatmap=data.points[0].data&&/^(heatmap|contour)$/.test(data.points[0].data.type);isLine=data.points[0].data&&/^lines/.test(data.points[0].data.mode);isArea=data.points[0].data&&/^(tonexty|tozeroy)$/.test(data.points[0].data.fill);isLine=isArea?false:isLine;var t,tIndex,tColor,tSize,tData,dIndex,isSelectedItemClicked=false;dIndex=isHeatmap?data.points[0].pointNumber.toString():data.points[0].pointNumber;tIndex=isPie?data.points.trace.index:data.points[0].fullData.index;if(!isMultiSelect){Object.keys(traces).forEach(function(key){t=traces[key];isSelectedItemClicked=!!t.data[dIndex];if(t.isLine){Plotly.restyle(elem,{mode:"lines",marker:{color:t.color,size:0}},t.traceIndex)}else if(t.isArea){Plotly.restyle(elem,{mode:"none",marker:{size:0}},t.traceIndex)}else{Plotly.restyle(elem,{marker:{color:t.color,line:{width:0},size:t.size}},t.traceIndex)}});traces={}}t=traces[tIndex];if(t){t.data[dIndex]=!t.data[dIndex]?cdata:false}else{tColor=isPie?data.points[0].color:isLine?data.points[0].fullData.line.color:isArea?data.points[0].data.fillcolor:data.points[0].data.marker?data.points[0].data.marker.color:null;tSize=data&&data.points&&data.points[0].data&&data.points[0].data.marker?data.points[0].data.marker.size:null;tData=isPie?data.points.trace.values:data.points[0].data.y;tData=tData.map(function(d,idx){return idx===dIndex&&!isSelectedItemClicked?cdata:false});if(isHeatmap){tData[dIndex]=!isSelectedItemClicked?cdata:false}t={traceIndex:tIndex,data:tData,color:tColor,isLine:isLine,isArea:isArea,isBoxplot:isBoxplot,isHeatmap:isHeatmap,size:tSize};traces[t.traceIndex]=t}var cdatalist=[];Object.keys(traces).forEach(function(key){t=traces[key];if(isHeatmap){cdatalist=cdatalist.concat(Object.keys(t.data).map(function(k){return t.data[k]}).filter(function(d){return!!d}))}else{cdatalist=cdatalist.concat(t.data.filter(function(d){return!!d}))}if(isBoxplot){}else if(isLine){Plotly.restyle(elem,{mode:"lines+markers",marker:{color:t.color,size:t.data.map(function(d){return d?10:0})}},t.traceIndex)}else if(isArea){Plotly.restyle(elem,{mode:"lines+markers",marker:{color:t.color,size:t.data.map(function(d){return d?10:0})}},t.traceIndex)}else if(isHeatmap){}else{v={marker:{line:{color:"#000000",width:t.data.map(function(d){return d?3:0})}}};if(t.color){v.marker.color=t.color}if(t.size){v.marker.size=t.size}Plotly.restyle(elem,v,t.traceIndex)}});var _hash={};cdata.forEach(function(d){if(!_hash[d.name+d.value]){$row=$('<div class="balloon-body-table-row"></div>');$row.append('<div class="balloon-body-table-cell label-cell">'+d.name+"</div>");$row.append('<div class="balloon-body-table-cell value-cell">'+d.value+"</div>");$table.append($row);_hash[d.name+d.value]=true}});$balloon.css({position:"absolute",left:data.event.offsetX+"px",top:data.event.offsetY-Object.keys(_hash).length*20+"px"});$balloon.on("click",function(){$balloon.hide()});if(isSelectedItemClicked){$balloon.hide()}else{$balloon.show()}if(onKeepThisCallback){var $keepOnly=$('<div class="balloon-header-item"><i class="fa fa-check"/> Keep Only</div>');$keepOnly.on("click",function(){onKeepThisCallback(cdatalist)});$hrow.append($keepOnly)}if(onExcludeCallback){var $exclude=$('<div class="balloon-header-item"><i class="fa fa-times"/> Exclude</div>');$exclude.on("click",function(){onExcludeCallback(cdatalist)});$hrow.append($exclude)}if(onShowDetailCallback){var $showDetail=$('<div class="balloon-header-item"><i class="fa fa-table" style="padding-right:3px"/>Show Detail</div>');$showDetail.on("click",function(){onShowDetailCallback(cdatalist)});$hrow.append($showDetail)}$hrow.append($('<div class="balloon-header-close-btn"><i class="fa fa-close"/></div>'));if(cdatalist.length>1){$head.append($('<div style="padding:0px 10px 3px"><b>'+cdatalist.length+"</b> items selected.</div>"))}}else{$balloon.hide()}}};var cancelHandler=function(){var $balloon=$("#viz-balloon");$balloon.hide();var t;Object.keys(traces).forEach(function(key){t=traces[key];if(t.isLine){Plotly.restyle(elem,{mode:"lines",marker:{color:t.color,size:0}},t.traceIndex)}else if(t.isArea){Plotly.restyle(elem,{mode:"none",marker:{size:0}},t.traceIndex)}else{Plotly.restyle(elem,{marker:{color:t.color,line:{width:0},size:t.size}},t.traceIndex)}});traces={}};elem.on("plotly_click",handler);elem.on("plotly_doubleclick",cancelHandler)};PlotlyGraphGenerator.getAxisRange=function(rangeString){if(!rangeString){return null}var arr=rangeString.split(",");if(arr.length!==2){return null}arr[0]=parseFloat(arr[0]);arr[1]=parseFloat(arr[1]);if(isNaN(arr[0]||isNaN(arr[1]))){return null}return arr};PlotlyGraphGenerator.render=function(viz,data,targetElem,renderType,onLoadCallback,onErrorCallback,onShowDetailCallback,onKeepThisCallback,onExcludeCallback){try{PlotlyGraphGenerator._render(viz,data,targetElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback)}catch(e){if(onErrorCallback&&typeof onErrorCallback==="function"){onErrorCallback(e)}VizUtil.renderNoData(targetElem,"Graph rendering failed.");console.error(e)}finally{if(onLoadCallback&&typeof onLoadCallback==="function"){onLoadCallback()}}};PlotlyGraphGenerator._render=function(viz,data,targetElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback){data=VizUtil.convertColumnarData(data);if(targetElem.childNodes.length>0){d3.select(targetElem.querySelector("svg")).remove();$(targetElem).empty()}if(!data||data.length===0){VizUtil.renderNoData(targetElem);return}var marker=viz.marker?viz.marker:null;var isHistogram=marker==="hist",isBoxplot=marker==="boxplot",isHeatmap=/^(heatmap|contour)$/.test(marker);var x=viz.x?viz.x.label:null,y=viz.y?viz.y.label:null,z=viz.z?viz.z.label:null,size=viz.size?viz.size.label:null,color=viz.color?viz.color.label:null,groupby=viz.groupby?viz.groupby.label:null,label=viz.label?viz.label.label:null,label2=viz.label2?viz.label2.label:null,facet=viz.facet?viz.facet.label:null,orientation=viz.orientation?viz.orientation:"vertical",barstyle=viz.barstyle?viz.barstyle:"stack",pieHole=!isNaN(viz.pieHole)?parseInt(viz.pieHole)/100:0,barPadding=viz.barPadding||(marker==="hist"?"0":null),opacity=viz.fillOpacity||VizUtil.getDefaultOpacity(viz)||null,sortTarget=viz.sortTarget?viz.sortTarget:"",sortOrder=viz.sortOrder?viz.sortOrder:"desc",labelOnPlot=viz.labelOnPlot?viz.labelOnPlot:"off",labelOnPlotHAlign=viz.labelOnPlotHAlign||"right",labelOnPlotVAlign=viz.labelOnPlotVAlign||"middle",errbarGraph=viz.errbarGraph||"bar",mapmode=viz.mapmode?viz.mapmode:"USA-states",marginLeft=viz.marginLeft,marginRight=viz.marginRight,marginTop=viz.marginTop,marginBottom=viz.marginBottom,title=viz.title,xAxisTitle=viz.xAxisTitle,xAxisPosition=viz.xAxisPosition||(marker==="heatmap"?"top":"bottom"),yAxisTitle=viz.yAxisTitle,y2AxisTitle=viz.y2AxisTitle,zAxisTitle=viz.zAxisTitle,xAxisShowTitle=viz.xAxisShowTitle!=="off",yAxisShowTitle=viz.yAxisShowTitle!=="off",y2AxisShowTitle=viz.y2AxisShowTitle!=="off",zAxisShowTitle=viz.zAxisShowTitle!=="off",circleMaxSize=viz.circleMaxSize||VizUtil.DEFAULT_MAX_CIRCLE_DIAMETER[marker],circleMinSize=viz.circleMinSize||VizUtil.DEFAULT_MIN_CIRCLE_DIAMETER[marker],legendShowFuncName=viz.legendShowFuncName!=="off",yValueOnPlot=viz.yValueOnPlot||"none",numDecimalDigits=viz.numDecimalDigits||2,useThousandSeparator=viz.useThousandSeparator!=="off",userXAxisRange=PlotlyGraphGenerator.getAxisRange(viz.xAxisRange),userYAxisRange=PlotlyGraphGenerator.getAxisRange(viz.yAxisRange),userY2AxisRange=PlotlyGraphGenerator.getAxisRange(viz.y2AxisRange),i,l;if(isNaN(pieHole)){pieHole=0}var ys=VizUtil.getOptions(viz,"y");var isMultiY=ys.length>1;var numY=0;ys.forEach(function(_y){if(_y){numY++}});var colsOn2ndAxis=[];var allowMultiYAndColor=viz.allowMultiYAndColor==="on";if(isHistogram){y=VizUtil.FREQ_COL_LABEL;if(!color){opacity=viz.fillOpacity||null}}formatValue=VizUtil.valueFormatterGenerator(numDecimalDigits,useThousandSeparator);if(isHeatmap){if(viz.x&&viz.y&&!viz.color){color='"count(*)"'}}else if(marker==="choropleth"&&!viz.color){color='"count(*)"'}else if(/^(bar|line|area)$/.test(marker)){if(viz.x&&!viz.y||viz.color&&!viz.y){y='"count(*)"'}}var nestData;var gData=[];var gRangeLayerData=[];var gTrendLineLayerData=[];var gTrendLineRangeLayerData=[];var gRefLineLayerData=[];var gRefLineUpperRangeLayerData=[];var gRefLineLowerRangeLayerData=[];var gVRefLineLayerData=[];var gVRefLineConfIntLayerData=[];var sortTargetCol=viz[sortTarget]?viz[sortTarget].label:"";var sortTargetGbysumCol=sortTargetCol?sortTargetCol+".gbysum":"";var direction=sortOrder==="desc"?1:-1;var valueSortFunc=function(a,b){if(a[sortTargetGbysumCol]!==undefined&&b[sortTargetGbysumCol]!==undefined){return(b[sortTargetGbysumCol]-a[sortTargetGbysumCol])*direction}else{return(b[sortTargetCol]-a[sortTargetCol])*direction}};var bucketInfo=viz.color&&/^(scatter|bubble)$/.test(marker)&&viz.colorbucket?VizUtil.getBucketInfo(data,viz.colorbucket.label):null;if(bucketInfo){bucketInfo.keyLabelMap={};bucketInfo.legend.forEach(function(b){if(b.extent[0]===b.extent[1]){b.label=formatValue(b.extent[0])}else{b.label=formatValue(b.extent[0])+" - "+formatValue(b.extent[1])}bucketInfo.keyLabelMap[b.key]=b.label});var v=null;data.forEach(function(d){v=d[viz.colorbucket.label];d[viz.colorbucket.label+"-label"]=!!v?bucketInfo.keyLabelMap[v]:null})}var xDataRange=null;if(/^(scatter|line|bubble)$/.test(marker)&&viz.x.isNumeric){var _xval=[];var _ycol=null;ys.forEach(function(d){if(!!d&&!_ycol){_ycol=d}});data.forEach(function(d){if(!VizUtil.isEmpty(d[viz.x.label])&&!VizUtil.isEmpty(d[_ycol.label])){_xval.push(d[viz.x.label])}});xDataRange=d3.extent(_xval);var _rangeMargin=Math.abs(xDataRange[1]-xDataRange[0])*.1;xDataRange[0]-=_rangeMargin;xDataRange[1]+=_rangeMargin}if(/^(heatmap)$/.test(marker)){nestData=d3.nest().key(function(d){return d[y]+"\n"}).key(function(d){return d[x]+"\n"}).entries(data)}else if(/^(contour)$/.test(marker)){nestData=d3.nest().key(function(d){return d[y]}).key(function(d){return d[x]}).entries(data)}else if(viz.color){var colorcol=color;if(viz.colorbucket){colorcol=viz.colorbucket.label+"-label"}nestData=d3.nest().key(function(d){return d[colorcol]}).entries(data);var colorData=VizUtil.distinct(data.map(function(d){return d[colorcol]}));var nestDataHash={};nestData.forEach(function(d){nestDataHash[d.key]=d});var sortedNestData=[];colorData.forEach(function(d){if(nestDataHash[d]){sortedNestData.push(nestDataHash[d])}});nestData=sortedNestData;if(viz.y){nestData.forEach(function(d){d.winfunc=viz.yWindowFunc})}if(isMultiY&&allowMultiYAndColor){ys.forEach(function(_y,_idx){if(_y&&_idx>0){var winfunc=viz["y"+(_idx===0?"":_idx)+"WindowFunc"];var funcLabel=!winfunc||winfunc==="none"?null:VizUtil.WINDOW_FUNCTION_OPTIONS_HASH[winfunc];if(!funcLabel){funcLabel=VizUtil.AGGREGATION_FUNCTION_OPTIONS_HASH[_y.func]}var yOp="y"+(_idx===0?"":_idx);nestData.unshift({key:_y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:_y.name+(funcLabel&&legendShowFuncName?" ("+funcLabel+")":""),ycolname:_y.label,winfunc:winfunc,yOp:yOp,values:data.filter(function(d){return!(d[".resp"]&&d[".resp"]!==_y.label)})})}})}}else{if(isMultiY){nestData=[];ys.forEach(function(_y,_idx){if(_y){var yOp="y"+(_idx===0?"":_idx);var winfunc=viz[yOp+"WindowFunc"];var funcLabel=!winfunc||winfunc==="none"?null:VizUtil.WINDOW_FUNCTION_OPTIONS_HASH[winfunc];if(!funcLabel){funcLabel=VizUtil.AGGREGATION_FUNCTION_OPTIONS_HASH[_y.func]}var use2ndAxis=viz[yOp+"Use2ndAxis"]==="on"&&VizUtil.isDualYSupported(marker,viz.barstyle);if(use2ndAxis){colsOn2ndAxis.push(_y)}nestData.push({key:_y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:_y.name+(funcLabel&&legendShowFuncName?" ("+funcLabel+")":""),ycolname:_y.label,winfunc:winfunc,use2ndAxis:use2ndAxis,yOp:yOp,values:data.filter(function(d){return!(d[".resp"]&&d[".resp"]!==_y.label)})})}});if(allowMultiYAndColor){nestData.reverse()}if(legendShowFuncName&&colsOn2ndAxis&&colsOn2ndAxis.length>0){nestData.forEach(function(d){d.key+=" ("+(d.use2ndAxis?"y2":"y1")+")"})}}else{nestData=[{key:y,winfunc:viz.yWindowFunc,values:data}]}}var colorScale=nestData.length<10?d3.scale.category10():d3.scale.category20();nestData=flattenDataByFacet(viz,nestData)
;var y1ValueSuffix="",y2ValueSuffix="";if(viz.y){y1ValueSuffix=VizUtil.getValueSuffix(viz.yWindowFunc,viz.y.func)}if(colsOn2ndAxis&&colsOn2ndAxis.length>0){ys.forEach(function(y,idx){if(y2ValueSuffix){return}if(viz["y"+idx+"Use2ndAxis"]){y2ValueSuffix=y&&VizUtil.getValueSuffix(viz["y"+idx+"WindowFunc"],y.func)}})}var colorarr,categColorPalette=viz.categColorPalette||viz.colorPallete10,customCategColorPaletteOp=viz.customCategColorPalette||viz.customColorPallete10;if(customCategColorPaletteOp&&customCategColorPaletteOp.length>0&&categColorPalette==="custom"){colorarr=customCategColorPaletteOp.match(VizUtil.COLOR_PALETTE_REGEX);for(i=0;i<colorarr.length;i++){if(VizUtil.hexToRgb(colorarr[i])===null){colorarr[i]="#CCCCCC"}}colorScale=d3.scale.ordinal().range(colorarr)}else if(categColorPalette&&categColorPalette!=="default"&&VizUtil.CATEG_COLOR_PALETTES_HASH[categColorPalette]){colorarr=VizUtil.CATEG_COLOR_PALETTES_HASH[categColorPalette].color;colorScale=d3.scale.ordinal().range(colorarr)}var quantColorPaletteOp=viz.quantColorPalette||viz.colorPallete||(/^(heatmap|contour)$/.test(marker)?"RdBu":"Blues");if(!VizUtil.QUANT_COLOR_PALETTES_HASH[quantColorPaletteOp]){quantColorPaletteOp=/^(heatmap|contour)$/.test(marker)?"RdBu":"Blues"}var reverseColorPaletteOrderOp=viz.reverseColorPaletteOrder||viz.reverseColorPalleteOrder||"off";var quantColorPalette=VizUtil.QUANT_COLOR_PALETTES_HASH[quantColorPaletteOp].color.slice();if(reverseColorPaletteOrderOp==="on"){quantColorPalette.reverse()}quantColorPalette.unshift("#ffffff");var _text;var _data;if(isBoxplot){nestData.forEach(function(d){var datum={x:[],y:[],text:[],customdata:[],marker:{}};if(opacity){datum.opacity=opacity}if(facet){datum.facet=d.facet}d.values.forEach(function(v){_data=[];datum.y=datum.y.concat([v[1],v[2],v[2],v[3],v[4],v[4],v[5]]);_data.push({type:"y",name:viz.y.name,validName:viz.y.validName,rawValue:[v[1],v[2],v[3],v[4],v[5]],value:["Min: "+v[1],"1Q: "+v[2],"Median: "+v[3],"3Q: "+v[4],"Max: "+v[5]].join(", "),func:viz.y.func,datatype:viz.y.type,filter:false});var xval=x?v[x]:d.key;datum.x=datum.x.concat(xval,xval,xval,xval,xval,xval,xval);if(x){_data.push({type:"x",name:viz.x.name,validName:viz.x.validName,rawValue:xval,value:xval,func:viz.x.func,datatype:viz.x.type,filter:true})}if(color){datum.name=v[color];datum.marker.color=colorScale(v[color]);_data.push({type:"color",name:viz.color.name,validName:viz.color.validName,rawValue:v[color],value:v[color],func:viz.color.func,datatype:viz.color.type,filter:true})}if(facet){_data.push({type:"facet",name:viz.facet.name,validName:viz.facet.validName,rawValue:v[facet],value:v[facet],func:viz.facet.func,datatype:viz.facet.type,filter:true})}datum.customdata.push(_data)});if(!datum.marker.color){datum.marker.color=colorScale("a")}gData.push(datum)})}else if(/^(heatmap|contour)$/.test(marker)){var datum={x:[],y:[],z:[],text:[],customdata:[],marker:{}};if(opacity){datum.opacity=opacity}datum.x=nestData[0].values.map(function(d){return d.key});datum.y=nestData.map(function(d){return d.key});datum.z=nestData.map(function(d){return d.values.map(function(d2){return d2.values[0][color]})});datum.text=nestData.map(function(datax){return datax.values.map(function(datay){_text=[];_text.push(viz.x.name+": "+formatValue(datay.values[0][x]));if(viz.y){_text.push(viz.y.name+": "+formatValue(datay.values[0][y]))}_text.push((viz.color&&viz.color.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.color.name)+": "+formatValue(datay.values[0][color]));return _text.join("<br>")})});datum.customdata=nestData.map(function(datax){return datax.values.map(function(datay){_data=[];_data.push({type:"x",name:viz.x.name,validName:viz.x.validName,rawValue:datay.values[0][x],value:formatValue(datay.values[0][x]),func:viz.x.func,datatype:viz.x.type,filter:true});if(viz.y){_data.push({type:"y",name:viz.y.name,validName:viz.y.validName,rawValue:datay.values[0][y],value:formatValue(datay.values[0][y]),func:viz.y.func,datatype:viz.y.type,filter:true})}_data.push({type:"color",name:viz.color&&viz.color.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.color.name,validName:viz.color&&viz.color.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_NAME:viz.color.validName,rawValue:datay.values[0][color],value:formatValue(datay.values[0][color]),func:viz.color.func,datatype:viz.color.type,filter:false});return _data})});if(!datum.y||datum.y[0]==="undefined"){datum.y=[" "]}datum.colorscale=[[0,quantColorPalette[1]],[.25,quantColorPalette[2]],[.5,quantColorPalette[3]],[.75,quantColorPalette[4]],[1,quantColorPalette[5]]];gData.push(datum)}else{var _appendText=function(text,arr){if(arr.indexOf(text)===-1){arr.push(text)}};var FITTED_COLUMN="predicted_value";var CONF_HIGH_COLUMN="conf_high";var CONF_LOW_COLUMN="conf_low";var REFLINE_COLUMN="refline";var REFLINE_RANGE_COLUMN="refrange";var _color=color;var rangeLegendgroup=1;var trendLineLegendgroup=1;var trendLineRangeLegendgroup=1;var reflineHash={};var vreflineHash={};nestData.forEach(function(d){var group={name:d.key,marker:{line:{width:0}},line:{},customdata:[]};if(d.yOp){group.yOp=d.yOp}var range={x:[],hi:[],low:[]};var trendLineRange={x:[],hi:[],low:[]};var trendLineGroup={x:[],y:[],text:[],hoverinfo:"text",mode:"lines",showlegend:false};if(!color&&y&&!isMultiY){if(marker==="bubble"){group.name=viz.groupby?viz.groupby.type===VizUtil.TYPE_ROWID?VizUtil.ROWID_COL_LABEL:viz.groupby.name:viz.y?viz.y.name:""}else if(marker==="hist"){group.name=viz.x.name}else{group.name=viz.y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.y.name}}if(facet){group.facet=d.facet}if(/^(bar|errbar)$/.test(marker)&&viz.x&&!VizUtil.returnsNumericValue(viz.x)&&!VizUtil.returnsDateValue(viz.x)&&sortTarget&&sortTargetCol){d.values.sort(valueSortFunc)}var yop=d.yOp||"y",xop="x";var reflineEnabled=!!viz[yop+"ReflineType"]&&viz[yop+"ReflineType"]!=="none"&&/^(bar|line|scatter|bubble)$/.test(marker);var reflineRangeEnabled=!!viz[yop+"ReflineRangeType"]&&viz[yop+"ReflineRangeType"]!=="none"&&/^(bar|line|scatter|bubble)$/.test(marker);var vReflineEnabled=!!viz[xop+"ReflineType"]&&viz[xop+"ReflineType"]!=="none"&&/^(scatter|bubble|hist)$/.test(marker);trendLineGroup.line={width:viz[yop+"TrendLineWidth"]||1,dash:viz[yop+"TrendLineType"]||"dot"};if(/^(scatter|line|bar)$/.test(marker)&&viz[yop+"MarkerShape"]){var markerSize=viz[yop+"MarkerSize"];switch(viz[yop+"MarkerShape"]){case"circle":group.type="scatter";group.mode="markers";if(/^(bar|line)$/.test(marker)&&markerSize){group.marker.size=markerSize}if(allowMultiYAndColor&&viz.multiYAndColorOpacity){group.marker.opacity=parseFloat(viz.multiYAndColorOpacity)}break;case"bar":group.type="bar";group.mode=null;break;case"line":group.type="scatter";group.mode="lines";if(markerSize){group.line.width=markerSize}break;case"default":if(marker==="line"&&markerSize){group.line.width=markerSize}break}}if(marker==="line"&&!viz[yop+"MarkerShape"]&&viz[yop+"MarkerSize"]){group.line.width=viz[yop+"MarkerSize"]}if(marker==="bubble"){group.type="scatter";group.mode="markers"}if(d.use2ndAxis){group.use2ndAxis=d.use2ndAxis;group.yaxis="y2"}var histRange=null;if(marker==="hist"&&d.values.length>1){histRange=Math.abs(d.values[1][x]-d.values[0][x])/2}var _y=isMultiY?d.ycolname:y;var _xDateParser=null,_xDateFormatter=null,xHoverFormatter=null;if(viz.x&&VizUtil.returnsDateValue(viz.x)&&viz.xHoverFormat){_xDateParser=d3.time.format("%Y-%m-%d").parse;_xDateFormatter=d3.time.format(viz.xHoverFormat);xHoverFormatter=function(datestr){if(!datestr){return null}return _xDateFormatter(_xDateParser(datestr))}}d.values.forEach(function(v){_text=[];_data=[];if(marker==="scatter"&&allowMultiYAndColor){if(VizUtil.isUndefined(v[_y])&&!VizUtil.isUndefined(v[y])){_y=y}}if(marker!=="scatter"||!VizUtil.isUndefined(v[x])&&!VizUtil.isUndefined(v[_y])){if(groupby){_appendText((viz.groupby.type===VizUtil.TYPE_ROWID?VizUtil.ROWID_COL_LABEL:viz.groupby.name)+": "+formatValue(v[groupby]),_text);_data.push({type:"groupby",name:viz.groupby.type===VizUtil.TYPE_ROWID?VizUtil.ROWID_COL_LABEL:viz.groupby.name,validName:viz.groupby.type===VizUtil.TYPE_ROWID?VizUtil.ROWID_COL_NAME:viz.groupby.validName,rawValue:v[groupby],value:formatValue(v[groupby]),func:viz.groupby.func,datatype:viz.groupby.type,filter:viz.groupby.type!==VizUtil.TYPE_ROWID})}if(x){if(!group.x)group.x=[];group.x.push(v[x]);if(histRange){_appendText(viz.x.name+": "+formatValue(v[x]-histRange)+" - "+formatValue(v[x]+histRange),_text);_data.push({type:"x",name:viz.x.name,validName:viz.x.validName,rawValue:v[x],value:formatValue(v[x]-histRange)+" - "+formatValue(v[x]+histRange),func:null,datatype:viz.x.type,filter:true,histRange:histRange})}else{var _val=!xHoverFormatter?formatValue(v[x]):xHoverFormatter(v[x]);_appendText((viz.x&&viz.x.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.x.name)+": "+_val,_text);_data.push({type:"x",name:viz.x&&viz.x.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.x.name,validName:viz.x&&viz.x.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_NAME:viz.x.validName,rawValue:v[x],value:_val,func:marker==="scatter"&&viz.x.isNumeric?"round":viz.x.func,datatype:viz.x.type,filter:marker!=="bubble",numDecimalDigits:numDecimalDigits})}}if(_y){if(!group.y)group.y=[];if(!group.ygbysum)group.ygbysum=[];var ycol="y";var errLow=viz.yErrLow||viz.errLow;var errHigh=viz.yErrHigh||viz.errHigh;var errHighLowEnabled=viz.yErrHighLowEnabled||viz.errHighLowEnabled;var errBarWidth=viz.yErrBarWidth||viz.errBarWidth;if(isMultiY){if(!viz.color)_color=d.ycolname;ycol=d.yOp;errLow=viz[d.yOp+"ErrLow"];errHigh=viz[d.yOp+"ErrHigh"];errHighLowEnabled=viz[d.yOp+"ErrHighLowEnabled"];errBarWidth=viz[d.yOp+"ErrBarWidth"]}group.y.push(v[_y]);if(!VizUtil.isUndefined(v[_y+".gbysum"])){group.ygbysum.push(v[_y+".gbysum"])}if(!VizUtil.isUndefined(v[_y])){var winfunc=/(^ptotal$|^pof)/.test(d.winfunc)?" ("+VizUtil.WINDOW_FUNCTION_OPTIONS_HASH[d.winfunc]+")":"";var suffix=d.use2ndAxis?y2ValueSuffix:y1ValueSuffix;if(isMultiY){_appendText(group.name+winfunc+": "+formatValue(v[_y])+suffix,_text);_data.push({type:"y",name:group.name+winfunc,validName:viz[ycol||"y"].validName,rawValue:v[_y],value:formatValue(v[_y])+suffix,func:marker==="scatter"&&viz[ycol||"y"].isNumeric?"round":viz[ycol||"y"].func,datatype:null,filter:marker==="scatter",numDecimalDigits:numDecimalDigits})}else{if(viz.y){if(!VizUtil.isUndefined(v[y+"eb"])){_appendText((viz.y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.y.name)+winfunc+": "+formatValue(v[y])+" ±"+formatValue(v[y+"eb"])+suffix,_text);_data.push({type:"y",name:(viz.y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.y.name)+winfunc,validName:viz.y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_NAME:viz.y.validName,rawValue:v[y],value:+formatValue(v[y])+" ±"+formatValue(v[y+"eb"])+suffix,func:marker==="scatter"&&viz.y.isNumeric?"round":viz[ycol].func,datatype:null,filter:marker==="scatter",numDecimalDigits:numDecimalDigits})}else{_appendText((viz.y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.y.name)+winfunc+": "+formatValue(v[y])+suffix,_text);_data.push({type:"y",name:(viz.y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.y.name)+winfunc,validName:viz.y.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_NAME:viz.y.validName,rawValue:v[y],value:formatValue(v[y])+suffix,func:marker==="scatter"&&viz.y.isNumeric?"round":viz[ycol].func,datatype:null,filter:marker==="scatter",numDecimalDigits:numDecimalDigits})}}else{_appendText(y+winfunc+": "+formatValue(v[y])+suffix,_text);_data.push({type:"y",name:y+winfunc,validName:VizUtil.NUMROWS_COL_NAME,rawValue:v[y],value:formatValue(v[y])+suffix,func:"sum",datatype:null,filter:marker==="scatter",numDecimalDigits:numDecimalDigits})}}}if(reflineEnabled){if(!group.refline)group.refline={x:[],y:[]};group.refline.x.push(VizUtil.isEmpty(v[x])?null:v[x]);group.refline.y.push(VizUtil.isEmpty(v[_y+REFLINE_COLUMN])?null:v[_y+REFLINE_COLUMN]);if(reflineRangeEnabled){if(!group.refrange)group.refrange={x:[],y:[]};group.refrange.x.push(VizUtil.isEmpty(v[x])?null:v[x]);group.refrange.y.push(VizUtil.isEmpty(v[_y+REFLINE_RANGE_COLUMN])?null:v[_y+REFLINE_RANGE_COLUMN])}}if(vReflineEnabled){if(!group.vrefline)group.vrefline={x:[],y:[]};group.vrefline.x.push(VizUtil.isEmpty(v[x+REFLINE_COLUMN])?null:v[x+REFLINE_COLUMN]);group.vrefline.y.push(VizUtil.isEmpty(v[_y])?null:v[_y]);if(!group.vrefrange)group.vrefrange={x:[],y:[]};group.vrefrange.x.push(VizUtil.isEmpty(v[x+REFLINE_RANGE_COLUMN])?null:v[x+REFLINE_RANGE_COLUMN]);group.vrefrange.y.push(VizUtil.isEmpty(v[_y])?null:v[_y])}if(!VizUtil.isUndefined(v[y+"eb"])){if(!group.error_y){group.error_y={type:"data",array:[],visible:true,width:errBarWidth?errBarWidth:4}}group.error_y.array.push(v[y+"eb"])}else if(errHigh&&errLow&&viz[ycol].isNumeric&&errHighLowEnabled==="on"&&marker==="scatter"){if(!group.error_y){group.error_y={type:"data",symmetric:false,array:[],arrayminus:[],visible:true,width:errBarWidth?errBarWidth:4}}if(!VizUtil.isUndefined(v[errHigh.label])&&!VizUtil.isUndefined(v[errLow.label])){group.error_y.array.push(v[errHigh.label]===null?0:Math.abs(v[viz[ycol].label]-v[errHigh.label]));group.error_y.arrayminus.push(v[errLow.label]===null?0:Math.abs(v[viz[ycol].label]-v[errLow.label]));_appendText(errHigh.name+": "+formatValue(v[errHigh.label]),_text);_data.push({type:"errh",name:errHigh.name,validName:errHigh.validName,rawValue:v[errHigh.label],value:formatValue(v[errHigh.label]),func:null,datatype:null,filter:false});_appendText(errLow.name+": "+formatValue(v[errLow.label]),_text);_data.push({type:"errl",name:errLow.name,validName:errLow.validName,rawValue:v[errLow.label],value:formatValue(v[errLow.label]),func:null,datatype:null,filter:false})}}else if(y&&errHigh&&errLow&&errHighLowEnabled==="on"&&viz[ycol].isNumeric&&marker==="line"){if(!VizUtil.isUndefined(v[errHigh.label])&&!VizUtil.isUndefined(v[errLow.label])){if(v[_y]===null){}else{range.x.push(v[x]);range.hi.push(v[errHigh.label]===null?v[_y]:v[errHigh.label]);range.low.push(v[errLow.label]===null?v[_y]:v[errLow.label]);_appendText(errHigh.name+": "+formatValue(v[errHigh.label]),_text);_data.push({type:"errh",name:errHigh.name,validName:errHigh.validName,rawValue:v[errHigh.label],value:formatValue(v[errHigh.label]),func:null,datatype:null,filter:false});_appendText(errLow.name+": "+formatValue(v[errLow.label]),_text);_data.push({type:"errl",name:errLow.name,validName:errLow.validName,rawValue:v[errLow.label],value:formatValue(v[errLow.label]),func:null,datatype:null,filter:false})}}}}if(z){if(!group.z)group.z=[];group.z.push(v[z]);_appendText(viz.z.name+": "+formatValue(v[z]),_text);_data.push({type:"z",name:viz.z.name,validName:viz.z.validName,rawValue:v[z],value:formatValue(v[z]),func:viz.z.func,datatype:viz.z.type,filter:false,numDecimalDigits:numDecimalDigits})}if(facet){_data.push({type:"facet",name:viz.facet.name,validName:viz.facet.validName,rawValue:v[facet],value:formatValue(v[facet]),func:viz.facet.func,datatype:viz.facet.type,filter:true})}if(size){if(!group.marker.size)group.marker.size=[];group.marker.size.push(v[size]);_appendText((viz.size&&viz.size.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.size.name)+": "+formatValue(v[size]),_text);_data.push({type:"size",name:viz.size&&viz.size.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.size.name,validName:viz.size&&viz.size.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_NAME:viz.size.validName,rawValue:v[size],value:formatValue(v[size]),func:viz.size.func,datatype:viz.size.type,filter:false})}if(color){_appendText((viz.color&&viz.color.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.color.name)+": "+formatValue(v[color]),_text);_data.push({type:"color",name:viz.color&&viz.color.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.color.name,validName:viz.color&&viz.color.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_NAME:viz.color.validName,rawValue:v[color],value:formatValue(v[color]),func:viz.color.func,datatype:viz.color.type,filter:!VizUtil.returnsNumericValue(viz.color)})}if(label){if(!group._label)group._label=[];group._label.push(v[label]);if(viz.hideLabel!=="on"&&!allowMultiYAndColor){_appendText(viz.label.name+": "+formatValue(v[label]),_text);_data.push({type:"x",name:viz.label.name,validName:viz.label.validName,rawValue:v[label],value:formatValue(v[label]),func:viz.label.func,datatype:viz.label.type,filter:false})}}if(label2&&allowMultiYAndColor){if(viz.hideLabel!=="on"){_appendText(viz.label2.name+": "+formatValue(v[label2]),_text);_data.push({type:"x",name:viz.label2.name,validName:viz.label2.validName,rawValue:v[label2],value:formatValue(v[label2]),func:viz.label2.func,datatype:viz.label2.type,filter:false})}}if(marker==="errbar"){_appendText("Range: "+VizUtil.ERROR_BAR_TYPE_OPTIONS_HASH[viz.errbarType||"stderr"],_text)}if(allowMultiYAndColor&&marker==="scatter"&&group.mode==="markers"){if(!group.text)group.text=[];if(viz.label2OnPlot==="on"&&!!label2&&group.type==="scatter"){group.text.push(v[label2])}else{group.text.push(_text.join("<br>"))}}else if(labelOnPlot==="on"&&label){if(!group.text)group.text=[];group.text.push(v[label])}else if(_text.length>0){if(!group.text)group.text=[];group.text.push(_text.join("<br>"))}group.customdata.push(_data);if(marker==="scatter"){if(!group.marker.opacity){group.marker.opacity=opacity}else if(viz.fillOpacity){group.marker.opacity=viz.fillOpacity}}else if(marker==="bubble"){group.marker.opacity=opacity}else{group.opacity=opacity}if(_color){if(!group.marker.color){group.marker.color=[]}if(isMultiY&&!viz.color){group.marker.color=colorScale(_color)}else{if(viz.color&&/^(scatter|bubble)$/.test(marker)&&viz.colorbucket){group.marker.color.push(quantColorPalette[bucketInfo.map[v[viz.colorbucket.label]]])}else{if(isMultiY&&allowMultiYAndColor&&viz.color&&d.ycolname){group.marker.color=colorScale(_color)}else{group.marker.color=colorScale(v[_color])}}}}}var trendLineOp=d.yOp?viz[d.yOp+"TrendLine"]:viz.yTrendLine||viz.trendLine;if(x&&trendLineOp&&trendLineOp!=="none"&&(viz.x.isNumeric||viz.x.isDate)&&/^(scatter|line|bubble)$/.test(marker)){if(!VizUtil.isEmpty(v[FITTED_COLUMN])&&(!xDataRange||v[x]>=xDataRange[0]&&v[x]<=xDataRange[1])){trendLineGroup.x.push(v[x]);trendLineGroup.y.push(v[FITTED_COLUMN]);switch(trendLineOp){case"lmfit":var t="P-Value: "+formatValue(v.p_value)+"<br>R Squared: "+formatValue(v.r_squared);if(v["coef"]){t+="<br>Coefficient: "+formatValue(v["coef"])}if(v["cor.value"]){t+="<br>Correlation: "+formatValue(v["cor.value"])}trendLineGroup.text.push(t);break;case"gamfit":trendLineGroup.text.push("R Squared: "+formatValue(v.r_squared)+"<br>Deviance Explained: "+formatValue(v.deviance_explained)+"<br>GCV: "+formatValue(v.gcv)+"<br>Scale Est.: "+formatValue(v.scale_est));break;case"loessfit":trendLineGroup.text.push("Equivalent Number of Parameters: "+formatValue(v.enp)+"<br>Residual Standard Error: "+formatValue(v.residual_std_error)+"<br>Trace of Smoother Matrix: "+formatValue(v.trace_of_smoother_matrix));break}}var withRange=d.yOp?viz[d.yOp+"TrendLineWithRange"]:viz.yTrendLineWithRange||viz.trendLineWithRange;if(withRange!=="off"){if(!VizUtil.isEmpty(v[CONF_HIGH_COLUMN])&&!VizUtil.isEmpty(v[CONF_LOW_COLUMN])&&(!xDataRange||v[x]>=xDataRange[0]&&v[x]<=xDataRange[1])){trendLineRange.x.push(v[x]);trendLineRange.hi.push(v[CONF_HIGH_COLUMN]);trendLineRange.low.push(v[CONF_LOW_COLUMN])}}}});if(group.marker.color&&Array.isArray(group.marker.color)&&marker==="choropleth"){group.marker.colorscale=[[0,quantColorPalette[1]],[.25,quantColorPalette[2]],[.5,quantColorPalette[3]],[.75,quantColorPalette[4]],[1,quantColorPalette[5]]]}if(!group.marker.color){group.marker.color=colorScale("a")}if(marker==="errbar"){if(errbarGraph==="bar"){group.error_y.color="#4d4d4d"}else if(errbarGraph==="marker"){group.error_y.color=group.marker.color}}else if(marker==="scatter"&&group.error_y){if(!viz[yop+"MarkerShape"]||/^(circle|default)$/.test(viz[yop+"MarkerShape"])){group.error_y.color=group.marker.color}else{group.error_y.color="#4d4d4d"}}if(viz.hideNullFromLegend==="on"&&group.name==="null"){group.showlegend=false}gData.push(group);if(reflineEnabled&&group.x&&!VizUtil.isUndefined(group.refline)){var reflineLabel=(viz[yop]?viz[yop].type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz[yop].name:"")+" ("+(VizUtil.REFERENCE_LINE_OPTIONS_HASH[viz[yop+"ReflineType"]]||VizUtil.REFERENCE_LINE_OPTIONS[0].label)+")";if(viz[yop+"ReflineLabel"]){reflineLabel=viz[yop+"ReflineLabel"]}var reflineGroup=viz[yop+"ReflineGroup"]||"all";var reflineColor=viz[yop+"ReflineColor"]&&viz[yop+"ReflineColor"]!=="default"?viz[yop+"ReflineColor"]:isMultiY?group.marker.color:"#53585F";var reflineWidth=viz[yop+"ReflineWidth"]||2;var reflineLength=viz[yop+"ReflineLength"]||12;var reflineStyle=viz[yop+"ReflineStyle"]||"dot";var errorbarRange=group.refline.x.map(function(){return 0});var reflineOnEachXDataPoint=/^(xaxis|xaxis\+facet)$/.test(reflineGroup)&&marker==="scatter"&&!VizUtil.returnsNumericValue(viz.x);if(reflineRangeEnabled){var reflineRangeType=viz[yop+"ReflineRangeType"];var reflineRangeLabel=VizUtil.REFERENCE_LINE_RANGE_TYPE_OPTIONS_HASH[reflineRangeType];var upperYValues=group.refline.y.map(function(v,idx){return v+group.refrange.y[idx]});var upperYLabels=upperYValues.map(function(v){return reflineRangeLabel+": "+v});var lowerYValues=group.refline.y.map(function(v,idx){return v-group.refrange.y[idx]});var lowerYLabels=lowerYValues.map(function(v){return reflineRangeLabel+": "+v});var lowerRangeLayer=null,upperRangeLayer=null;if(reflineOnEachXDataPoint){upperRangeLayer={name:reflineRangeLabel,x:group.refline.x,y:group.refline.y.map(function(v,idx){return v+group.refrange.y[idx]}),error_y:{type:"data",array:errorbarRange,visible:true,width:reflineLength,thickness:reflineWidth,color:_setOpacity(reflineColor,.4)},type:"scatter",mode:"markers",showlegend:false,marker:{size:1,color:_setOpacity(reflineColor,.4),symbol:"line-ew-open"},hoverinfo:"text",text:upperYLabels,customdata:{type:viz[yop+"ReflineType"],yOp:yop}};lowerRangeLayer={name:reflineRangeLabel,x:group.refline.x,y:group.refline.y.map(function(v,idx){return v-group.refrange.y[idx]}),error_y:{type:"data",array:errorbarRange,visible:true,width:reflineLength,thickness:reflineWidth,color:_setOpacity(reflineColor,.4)},type:"scatter",mode:"markers",showlegend:false,marker:{size:1,color:_setOpacity(reflineColor,.4),symbol:"line-ew-open"},hoverinfo:"text",text:lowerYLabels,customdata:{type:viz[yop+"ReflineType"],yOp:yop}}}else{upperRangeLayer={x:group.refline.x,y:upperYValues,line:{color:_setOpacity(reflineColor,.4),width:reflineWidth,dash:reflineStyle},name:reflineRangeLabel,legendgroup:"refline"+yop,showlegend:false,visible:!reflineHash[yop],mode:"lines",text:upperYLabels,hoverinfo:"text",customdata:{type:viz[yop+"ReflineType"],yOp:yop}};lowerRangeLayer={x:group.refline.x,y:lowerYValues,line:{color:_setOpacity(reflineColor,.4),width:reflineWidth,dash:reflineStyle},name:reflineRangeLabel,legendgroup:"refline"+yop,showlegend:false,visible:!reflineHash[yop],mode:"lines",text:lowerYLabels,hoverinfo:"text",customdata:{type:viz[yop+"ReflineType"],yOp:yop}}}gRefLineUpperRangeLayerData.push(upperRangeLayer);gRefLineLowerRangeLayerData.push(lowerRangeLayer)}else{gRefLineUpperRangeLayerData.push({x:[],y:[],customdata:{}});gRefLineLowerRangeLayerData.push({x:[],y:[],customdata:{}})}var reflineLineGroup=null;if(reflineOnEachXDataPoint){reflineLineGroup={name:reflineLabel,x:group.refline.x,y:group.refline.y,error_y:{type:"data",array:errorbarRange,visible:true,width:reflineLength,thickness:reflineWidth,color:reflineColor},type:"scatter",mode:"markers",legendgroup:"refline"+yop,showlegend:!reflineHash[yop],visible:!reflineHash[yop],marker:{size:12,color:reflineColor,symbol:"line-ew-open"},hoverinfo:"text",text:group.refline.y.map(function(v){return(reflineLabel?reflineLabel+": ":"")+formatValue(v)}),customdata:{type:viz[yop+"ReflineType"],yOp:yop}}}else{reflineLineGroup={x:group.refline.x,y:group.refline.y,line:{color:reflineColor,width:reflineWidth,dash:reflineStyle},name:reflineLabel,legendgroup:"refline"+yop,showlegend:!reflineHash[yop],visible:!reflineHash[yop],mode:"lines",hoverinfo:"text",text:group.refline.y.map(function(v){return(reflineLabel?reflineLabel+": ":"")+formatValue(v)}),customdata:{type:viz[yop+"ReflineType"],yOp:yop}}}if(group.yaxis){reflineLineGroup.yaxis=group.yaxis}if(viz[yop+"ReflineType"]==="diagonal"){recalculateDiagonalRefLineData(reflineLineGroup)}reflineHash[yop]=true;gRefLineLayerData.push(reflineLineGroup)}else{gRefLineLayerData.push({x:[],y:[],customdata:{}});gRefLineUpperRangeLayerData.push({x:[],y:[],customdata:{}});gRefLineLowerRangeLayerData.push({x:[],y:[],customdata:{}})}if(vReflineEnabled&&group.x&&!VizUtil.isUndefined(group.vrefline)){var vReflineLabel=(viz.x?viz.x.type===VizUtil.TYPE_NUMROWS?VizUtil.NUMROWS_COL_LABEL:viz.x.name:"")+" ("+(VizUtil.REFERENCE_LINE_OPTIONS_HASH[viz[xop+"ReflineType"]]||VizUtil.REFERENCE_LINE_OPTIONS[0].label)+")";if(viz[xop+"ReflineLabel"]){vReflineLabel=viz[xop+"ReflineLabel"]}var vReflineColor=viz[xop+"ReflineColor"]||"#53585F";var vReflineWidth=viz[xop+"ReflineWidth"]||1;var vReflineStyle=viz[xop+"ReflineStyle"]||"dot";var vReflineGroup={x:group.vrefline.x,y:group.vrefline.y,line:{color:vReflineColor,width:vReflineWidth,dash:vReflineStyle},name:vReflineLabel,legendgroup:"vrefline",showlegend:!vreflineHash[xop],visible:!vreflineHash[xop],mode:"lines",hoverinfo:"text",text:group.vrefline.x.map(function(v){return(vReflineLabel?vReflineLabel+": ":"")+formatValue(v)})};vreflineHash[xop]=true;gVRefLineLayerData.push(vReflineGroup)}if(/^(line|scatter)$/.test(marker)&&!z&&range){var rangeGroup={x:[],y:[],fill:"tozerox",fillcolor:VizUtil.hexToRgba(isArray(group.marker.color)?quantColorPalette[quantColorPalette.length-1]:group.marker.color,.2),line:{color:"transparent"},name:group.name,showlegend:false,type:"scatter",hoverinfo:"none"};if(d.use2ndAxis){rangeGroup.use2ndAxis=d.use2ndAxis;rangeGroup.yaxis="y2"}var copyx=range.x?range.x.slice():group.x.slice();var copyx2=range.x?range.x.slice():group.x.slice();rangeGroup.x=copyx.concat(copyx2.reverse());rangeGroup.y=range.hi.concat(range.low.reverse());rangeGroup.x.push(copyx[0]);rangeGroup.y.push(range.hi[0]);gRangeLayerData.push(rangeGroup);rangeGroup.legendgroup="lg"+rangeLegendgroup;group.legendgroup="lg"+rangeLegendgroup;rangeLegendgroup++}if(/^(line|scatter|bubble)$/.test(marker)&&!z&&trendLineGroup){trendLineGroup.marker={color:isArray(group.marker.color)?quantColorPalette[quantColorPalette.length-1]:group.marker.color};if(d.use2ndAxis){trendLineGroup.use2ndAxis=d.use2ndAxis;trendLineGroup.yaxis="y2"}gTrendLineLayerData.push(trendLineGroup);trendLineGroup.legendgroup="lg"+trendLineLegendgroup;group.legendgroup="lg"+trendLineLegendgroup;trendLineLegendgroup++}if(/^(line|scatter|bubble)$/.test(marker)&&!z&&trendLineRange){var trendLineRangeGroup={x:[],y:[],fill:"tozerox",fillcolor:VizUtil.hexToRgba(isArray(group.marker.color)?quantColorPalette[quantColorPalette.length-1]:group.marker.color,.2),line:{color:"transparent"},name:group.name,showlegend:false,type:"scatter",hoverinfo:"none"};if(d.use2ndAxis){trendLineRangeGroup.use2ndAxis=d.use2ndAxis;trendLineRangeGroup.yaxis="y2"}var copyx=trendLineRange.x?trendLineRange.x.slice():group.x.slice();var copyx2=trendLineRange.x?trendLineRange.x.slice():group.x.slice();trendLineRangeGroup.x=copyx.concat(copyx2.reverse());trendLineRangeGroup.y=trendLineRange.hi.concat(trendLineRange.low.reverse());trendLineRangeGroup.x.push(copyx[0]);trendLineRangeGroup.y.push(trendLineRange.hi[0]);gTrendLineRangeLayerData.push(trendLineRangeGroup);trendLineRangeGroup.legendgroup="lg"+trendLineRangeLegendgroup;trendLineRangeLegendgroup++}})}var divElem=document.createElement("div");divElem.style.width="100%";divElem.style.height="100%";targetElem.appendChild(divElem);var _bottom=VizUtil.MIN_MARGIN,_left=VizUtil.MIN_MARGIN,_top=title?40:10,_right=colsOn2ndAxis.length>0?VizUtil.MIN_MARGIN+10:15,_v;if(marker==="bar"&&orientation==="horizontal"){_left=150;if(colsOn2ndAxis.length>0){_top=VizUtil.MIN_MARGIN}}if(gData.length>0&&gData[0].x&&gData[0].x.length>0){var _x=gData[0].x;if(typeof _x[0]==="string"){var _xlen=_x.map(function(x){return x?x.length:0});var _xmax=parseInt(d3.max(_xlen));_bottom=Math.max(_bottom,_xmax*VizUtil.PIXEL_PER_CHAR);_bottom=Math.min(VizUtil.MAX_MARGIN,_bottom)}}if(gData.length>0&&gData[0].y&&gData[0].y.length>0){var _y=gData[0].y;if(typeof _y[0]==="string"){var _ylen=_y.map(function(x){return x?x.length:0});var _ymax=parseInt(d3.max(_ylen));_left=Math.max(_left,_ymax*VizUtil.PIXEL_PER_CHAR);_left=Math.min(VizUtil.MAX_MARGIN,_left)}}_v=parseInt(marginLeft);if(!isNaN(_v)){_left=_v}_v=parseInt(marginBottom);if(!isNaN(_v)){_bottom=_v}_v=parseInt(marginTop);if(!isNaN(_v)){if(marker==="heatmap"&&xAxisPosition==="top"){_bottom=_v}else{_top=_v}}_v=parseInt(marginRight);if(!isNaN(_v)){_right=_v}if(/^(scatter|bubble)$/.test(marker)&&gData.length>0&&gData[0].marker.size&&gData[0].marker.size.length>0){var _exts=gData.map(function(d){return d3.extent(d.marker.size)});var _ext=d3.extent(d3.merge(_exts));var _scale=d3.scale.linear().domain(_ext).range([circleMinSize,circleMaxSize]);gData.forEach(function(d){d.marker.size_org=d.marker.size;d.marker.size=d.marker.size_org.map(function(sz){return _scale(sz)})})}var layout={margin:{t:_top,b:_bottom,l:_left,r:_right},legend:{traceorder:"normal",font:{}},titlefont:{},hovermode:"closest",xaxis:{zerolinecolor:VizUtil.ZERO_LINE_COLOR,titlefont:{},tickfont:{}},yaxis:{zerolinecolor:VizUtil.ZERO_LINE_COLOR,titlefont:{},tickfont:{}},zaxis:{zerolinecolor:VizUtil.ZERO_LINE_COLOR,titlefont:{},tickfont:{}},paper_bgcolor:"rgba(255,255,255,0)",plot_bgcolor:"rgba(255,255,255,0)",scene:{xaxis:{titlefont:{},tickfont:{}},yaxis:{titlefont:{},tickfont:{}},yaxis2:{titlefont:{},tickfont:{}},zaxis:{titlefont:{},tickfont:{}}}};if(viz.xAxisTickFormat){layout.xaxis.tickformat=viz.xAxisTickFormat}if(viz.yAxisTickFormat){layout.yaxis.tickformat=viz.yAxisTickFormat}if(viz.y2AxisTickFormat){if(!layout.y2axis){layout.y2axis={}}layout.y2axis.tickformat=viz.y2AxisTickFormat}if(marker==="heatmap"){layout.yaxis.autorange="reversed";if(xAxisPosition==="top"){layout.xaxis.side="top";layout.margin.t=(title?80:4)+_bottom;layout.margin.b=10}}if(viz.xAxisDirection==="reversed"){layout.xaxis.autorange="reversed"}if(viz.yAxisDirection==="reversed"){layout.yaxis.autorange="reversed"}if(viz.x){layout.xaxis.title=layout.scene.xaxis.title=viz.x.name}if(viz.y){layout.yaxis.title=layout.scene.yaxis.title=viz.y.name}if(viz.z){layout.zaxis.title=layout.scene.zaxis.title=viz.z.name}if(y===VizUtil.FREQ_COL_LABEL){layout.yaxis.title=y}if(viz.x&&viz.x.type===VizUtil.TYPE_NUMROWS){layout.xaxis.title=VizUtil.NUMROWS_COL_LABEL}if(viz.y&&viz.y.type===VizUtil.TYPE_NUMROWS){layout.yaxis.title=VizUtil.NUMROWS_COL_LABEL}if(!isMultiY&&viz.yWindowFunc&&/^(bar|line|area)$/.test(marker)){var _funclabel=VizUtil.WINDOW_FUNCTION_OPTIONS_HASH[viz.yWindowFunc];if(_funclabel&&viz.yWindowFunc!=="none"&&legendShowFuncName){layout.yaxis.title+=" ("+_funclabel+")"}}layout.yaxis.ticksuffix=y1ValueSuffix;if(/^(scatter)$/.test(marker)&&viz.xAxisScale){layout.xaxis.type=layout.scene.xaxis.type=viz.xAxisScale}if(/^(scatter|bar|errbar|hist)$/.test(marker)&&viz.yAxisScale){layout.yaxis.type=layout.scene.yaxis.type=viz.yAxisScale}if(/^(scatter)$/.test(marker)&&viz.zAxisScale){layout.zaxis.type=layout.scene.zaxis.type=viz.zAxisScale}if(xAxisTitle){layout.xaxis.title=layout.scene.xaxis.title=xAxisTitle}if(yAxisTitle){layout.yaxis.title=layout.scene.yaxis.title=yAxisTitle}if(zAxisTitle){layout.zaxis.title=layout.scene.zaxis.title=zAxisTitle}if(!xAxisShowTitle){layout.xaxis.title=layout.scene.xaxis.title=""}if(!yAxisShowTitle){layout.yaxis.title=layout.scene.yaxis.title=""}if(!zAxisShowTitle){layout.zaxis.title=layout.scene.zaxis.title=""}if(viz.xAxisTitleFontSize){layout.xaxis.titlefont.size=layout.scene.xaxis.titlefont.size=viz.xAxisTitleFontSize}if(viz.yAxisTitleFontSize){
layout.yaxis.titlefont.size=layout.scene.yaxis.titlefont.size=viz.yAxisTitleFontSize}if(viz.zAxisTitleFontSize){layout.zaxis.titlefont.size=layout.scene.zaxis.titlefont.size=viz.zAxisTitleFontSize}if(viz.xAxisTickFontSize){layout.xaxis.tickfont.size=layout.scene.xaxis.tickfont.size=viz.xAxisTickFontSize}if(viz.yAxisTickFontSize){layout.yaxis.tickfont.size=layout.scene.yaxis.tickfont.size=viz.yAxisTickFontSize}if(viz.zAxisTickFontSize){layout.zaxis.tickfont.size=layout.scene.zaxis.tickfont.size=viz.zAxisTickFontSize}if(viz.showXGridLines&&viz.showXGridLines!=="default"){layout.xaxis.showgrid=layout.scene.xaxis.showgrid=viz.showXGridLines==="on"}if(viz.showYGridLines&&viz.showYGridLines!=="default"){layout.yaxis.showgrid=layout.scene.yaxis.showgrid=viz.showYGridLines==="on"}if(viz.showZGridLines&&viz.showZGridLines!=="default"){layout.zaxis.showgrid=layout.scene.zaxis.showgrid=viz.showZGridLines==="on"}if(!viz.x){layout.xaxis.zeroline=layout.scene.xaxis.zeroline=false}if(viz.showXZeroLine&&viz.showXZeroLine!=="default"){layout.xaxis.zeroline=layout.scene.xaxis.zeroline=viz.showXZeroLine==="on"}if(viz.showYZeroLine&&viz.showYZeroLine!=="default"){layout.yaxis.zeroline=layout.scene.yaxis.zeroline=viz.showYZeroLine==="on"}if(viz.showZZeroLine&&viz.showZZeroLine!=="default"){layout.zaxis.zeroline=layout.scene.zaxis.zeroline=viz.showZZeroLine==="on"}if(viz.xAxisTickStep&&viz.x&&viz.x.isNumeric){layout.xaxis.dtick=viz.xAxisTickStep}if(userXAxisRange){layout.xaxis.range=userXAxisRange}if(viz.yAxisTickStep&&viz.y&&viz.y.isNumeric){layout.yaxis.dtick=viz.yAxisTickStep}if(userYAxisRange){layout.yaxis.range=userYAxisRange}if(colsOn2ndAxis.length>0){layout.yaxis2={zerolinecolor:VizUtil.ZERO_LINE_COLOR,titlefont:{},tickfont:{},side:"right"};layout.yaxis2.overlaying="y";var _col=colsOn2ndAxis[0];if(y2AxisTitle){layout.yaxis2.title=layout.scene.yaxis2.title=y2AxisTitle}else{layout.yaxis2.title=_col.name;if(_col.label===VizUtil.FREQ_COL_LABEL){layout.yaxis2.title=_col.label}if(_col.type===VizUtil.TYPE_NUMROWS){layout.yaxis2.title=VizUtil.NUMROWS_COL_LABEL}}if(!y2AxisShowTitle){layout.yaxis2.title=""}if(/^(scatter|bar|errbar|hist)$/.test(marker)&&viz.y2AxisScale){layout.yaxis2.type=layout.scene.yaxis2.type=viz.y2AxisScale}layout.yaxis2.ticksuffix=y2ValueSuffix;if(viz.y2AxisTitleFontSize){layout.yaxis2.titlefont.size=viz.y2AxisTitleFontSize}if(viz.y2AxisTickFontSize){layout.yaxis2.tickfont.size=viz.y2AxisTickFontSize}layout.yaxis2.showgrid=viz.showY2GridLines==="on";layout.yaxis2.zeroline=viz.showY2ZeroLine==="on";if(viz.y2AxisTickStep&&viz.y&&viz.y.isNumeric){layout.yaxis2.dtick=viz.y2AxisTickStep}if(userY2AxisRange){layout.yaxis2.range=userY2AxisRange}}if(viz.legendFontSize){layout.legend.font.size=viz.legendFontSize}if(title){layout.title=title}if(viz.titleFontSize){layout.titlefont.size=viz.titleFontSize}if(viz.width){layout.width=viz.width}if(viz.height){layout.height=viz.height}var config={displayModeBar:false};switch(viz.legendLocation){case"top":layout.legend={orientation:"h",y:viz.plotlyLegendPosY||.99,x:viz.plotlyLegendPosX||.5,xanchor:"center",yanchor:"bottom"};if(isMultiY||color){layout.margin.t+=18}break;case"bottom":layout.legend={orientation:"h",y:viz.plotlyLegendPosY||-.12,x:viz.plotlyLegendPosX||.5,xanchor:"center"};break;case"left":layout.legend={orientation:"v",y:viz.plotlyLegendPosY||1.04,x:viz.plotlyLegendPosX||-.2};break;case"none":layout.showlegend=false;break;default:if(viz.plotlyLegendPosX||viz.plotlyLegendPosY){layout.legend={};if(viz.plotlyLegendPosX){layout.legend.x=viz.plotlyLegendPosX}if(viz.plotlyLegendPosY){layout.legend.y=viz.plotlyLegendPosY}}break}if(viz.hoverLabelBgColorBrightnessRatio){gData.forEach(function(g){if(!g.hoverlabel){g.hoverlabel={}}if(g.marker.color){g.hoverlabel.bgcolor=_adjustColor(g.marker.color,viz.hoverLabelBgColorBrightnessRatio)}})}var annotationContext=null,gDataFiltered;switch(marker){case"scatter":layout.barmode="group";gData=gData.map(function(datum){datum.mode=datum.mode||"markers";datum.hoverinfo="text";if(allowMultiYAndColor&&datum.mode==="markers"&&datum.type==="scatter"){if(viz.label2OnPlot==="on"&&label2){datum.mode+="+text";datum.textposition=labelOnPlotVAlign+" "+labelOnPlotHAlign;datum.hoverinfo="x+y+z"}}else{if(labelOnPlot==="on"&&label){datum.mode+="+text";datum.textposition=labelOnPlotVAlign+" "+labelOnPlotHAlign;datum.hoverinfo="x+y+z"}}if(datum.marker){datum.marker.sizemode="diameter";datum.marker.sizemin=circleMinSize/2;if(!datum.marker.size){datum.marker.size=circleMinSize}}if(datum.z){datum.type="scatter3d"}if(datum.name==="null"){datum.visible=false;datum.showlegend=false}return datum});if(facet){constructFacetData(viz,gData,layout,colorarr&&colorarr.length>0?colorarr[0]:null,gRangeLayerData,gTrendLineLayerData,gTrendLineRangeLayerData,colsOn2ndAxis,gRefLineLayerData,gRefLineUpperRangeLayerData,gRefLineLowerRangeLayerData,gVRefLineLayerData,gVRefLineConfIntLayerData)}else{if(viz.xAxisIncludeZero==="on"){layout.xaxis.range=calculateRange(gData.concat(gRangeLayerData).concat(gTrendLineLayerData).concat(gTrendLineRangeLayerData).concat(gRefLineLayerData).concat(gRefLineUpperRangeLayerData).concat(gRefLineLowerRangeLayerData),"x",true,false,marker,yValueOnPlot,false,barstyle,color,isMultiY,"x")}if(viz.yAxisIncludeZero==="on"){layout.yaxis.range=calculateRange(gData.concat(gRangeLayerData).concat(gTrendLineLayerData).concat(gTrendLineRangeLayerData).concat(gRefLineLayerData).concat(gRefLineUpperRangeLayerData).concat(gRefLineLowerRangeLayerData),"y",true,false,marker,yValueOnPlot,false,barstyle,color,isMultiY,"y1")}if(viz.y2AxisIncludeZero==="on"&&colsOn2ndAxis.length>0){if(!layout.y2axis){layout.y2axis={}}layout.y2axis.range=calculateRange(gData.concat(gRangeLayerData).concat(gTrendLineLayerData).concat(gTrendLineRangeLayerData).concat(gRefLineLayerData).concat(gRefLineUpperRangeLayerData).concat(gRefLineLowerRangeLayerData),"y",true,false,marker,yValueOnPlot,false,barstyle,color,isMultiY,"y2")}}if(viz.xAxisDataTypeDetection==="on"){gData.forEach(function(datum){if(datum._label&&datum._label.length>0&&datum._label.indexOf("line")!==-1){datum.mode="lines";if(datum.xaxis){delete layout[datum.xaxis.replace("x","xaxis")].type}else{delete layout.xaxis.type}var xandys=datum.x.map(function(x,idx){return{x:x,y:datum.y[idx]}}).sort(function(a,b){return a.x-b.x});datum.x=xandys.map(function(d){return d.x});datum.y=xandys.map(function(d){return d.y})}})}if(viz.clusterCircles&&/^(line|fill)$/.test(viz.clusterCircles)){layout.shapes=[];gData.forEach(function(datum){var cx=[],cy=[];if(datum&&datum.y){datum.y.forEach(function(yval,index){if(!VizUtil.isEmpty(yval)){cy.push(yval);cx.push(datum.x[index])}})}if(cx.length>0){var xext=d3.extent(cx);var yext=d3.extent(cy);var shape={type:"circle",xref:datum.xaxis?datum.xaxis:"x",yref:datum.yaxis?datum.yaxis:"y",x0:xext[0],y0:yext[0],x1:xext[1],y1:yext[1]};if(viz.clusterCircles==="line"){shape.line={color:VizUtil.hexToRgba(datum.marker.color||"#0000FF",.8),width:1}}else if(viz.clusterCircles==="fill"){shape.fillcolor=VizUtil.hexToRgba(datum.marker.color||"#0000FF",.2);shape.line={color:VizUtil.hexToRgba(datum.marker.color||"#0000FF",.2),width:1}}layout.shapes.push(shape)}})}if(marker==="scatter"){gRefLineUpperRangeLayerData=consolidateRefLines(gRefLineUpperRangeLayerData);gRefLineLowerRangeLayerData=consolidateRefLines(gRefLineLowerRangeLayerData);gRefLineLayerData=consolidateRefLines(gRefLineLayerData);gVRefLineLayerData=consolidateRefLines(gVRefLineLayerData)}gRefLineUpperRangeLayerData=gRefLineUpperRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gRefLineLowerRangeLayerData=gRefLineLowerRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gRefLineLayerData=gRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false});gVRefLineConfIntLayerData=gVRefLineConfIntLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gVRefLineLayerData=gVRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false});recalculateRefLineData(viz,gRefLineLayerData,layout);recalculateRefLineData(viz,gRefLineUpperRangeLayerData,layout);recalculateRefLineData(viz,gRefLineLowerRangeLayerData,layout);recalculateVRefLineData(viz,gVRefLineLayerData,layout);layout.showlegend=!(!viz.color&&numY<2&&gRefLineLayerData.length===0&&gVRefLineLayerData.length===0);if(viz.legendLocation==="none"){layout.showlegend=false}if(label&&viz.xAxisDataTypeDetection!=="on"){PlotlyGraphGenerator._convertGraphDataForScatterLineGroupedByLabel(gData)}else{gData.forEach(function(g){if(g.mode==="lines"){var cx=[],cy=[],ctxt=[];if(g&&g.y){g.y.forEach(function(yval,index){if(!VizUtil.isEmpty(yval)&&!VizUtil.isEmpty(g.x[index])){cy.push(yval);cx.push(g.x[index]);if(g.text){ctxt.push(g.text[index])}}})}g.x=cx;g.y=cy;if(ctxt.length>0){g.text=ctxt}}})}if(viz.reverseGraphLayerOrder){gData.reverse()}if(VizUtil.returnsCharacterValue(viz.x)&&VizUtil.returnsCharacterValue(viz.y)){var xarr=[],yarr=[];data.forEach(function(d){xarr.push(d[viz.x.validLabel]);yarr.push(d[viz.y.validLabel])});xarr=makeArrayUnique(xarr);yarr=makeArrayUnique(yarr);var xext=[],yext=[];xarr.forEach(function(xval){yarr.forEach(function(yval){xext.push(xval);yext.push(yval)})});var zeroext=xext.map(function(){return 0});var nullext=xext.map(function(){return null});var layer={mode:"markers",name:"",showlegend:false,x:xext,y:yext,marker:{size:zeroext},hoverinfo:"skip"};gData.unshift(layer)}gDataFiltered=[].concat(gData).concat(gTrendLineRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gVRefLineConfIntLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRefLineUpperRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRefLineLowerRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false})).concat(gVRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false})).concat(gTrendLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0}));Plotly.newPlot(divElem,gDataFiltered,layout,config);PlotlyGraphGenerator._addCustomBalloon(divElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback);break;case"hist":case"bar":case"errbar":if(!viz.x){layout.xaxis.showticklabels=false}else{if(viz.x.func==="aschar"||!viz.x.isNumeric&&!viz.x.isDate){layout.xaxis.type="category"}}if(barPadding){layout.bargap=barPadding}if(marker==="hist"){barstyle="overlay"}if(marker==="errbar"){layout.barmode="group";gData=gData.map(function(datum){datum.type=errbarGraph==="bar"?"bar":"scatter";datum.mode=errbarGraph==="bar"?null:"markers";datum.hoverinfo="text";return datum})}else{layout.barmode=barstyle;gData=gData.map(function(datum){if(!datum.type){datum.type="bar"}datum.hoverinfo="text";return datum})}if(facet){constructFacetData(viz,gData,layout,colorarr&&colorarr.length>0?colorarr[0]:null,null,null,null,colsOn2ndAxis,gRefLineLayerData,gRefLineUpperRangeLayerData,gRefLineLowerRangeLayerData,gVRefLineLayerData,gVRefLineConfIntLayerData);if(!x){gData.forEach(function(g){if(!g.x){g.x=g.y.map(function(){return"x"})}})}var syncYAxis=viz.facetSyncYAxis!=="off";if(!viz.facetSyncYAxis&&viz.facetEnableDataCompletion==="off"){syncYAxis=false}if(marker==="bar"&&barstyle==="stack"&&color&&syncYAxis){var _arr=[];nestData.forEach(function(d){var gbysums=d.values.map(function(v){return v[y+".gbysum"]!==undefined?v[y+".gbysum"]:v[y]});_arr=_arr.concat(gbysums)});_arr.push(0);var _facetColorStackYRange=d3.extent(_arr);Object.keys(layout).forEach(function(key){if(/^yaxis/.test(key)){layout[key].range=_facetColorStackYRange}})}}else{if(yValueOnPlot!=="none"&&/^(bar|hist)$/.test(marker)){if(barstyle==="stack"){gData=calculateStackedYValue(gData)}annotationContext=[];var numOfTraces=gData.length;var pivot=Math.floor(numOfTraces/2);var delta=.8/numOfTraces;var dateX,offset;gData.forEach(function(group,gidx){if(marker==="bar"&&barstyle==="group"&&viz.color&&(!viz.x||viz.x&&viz.x.name!==viz.color.name)||marker==="bar"&&barstyle==="group"&&numY>1){if(x){var allUnique=isAllUnique(group.x);annotationContext=annotationContext.concat(group.x.map(function(xval,idx){offset=gidx-pivot;if(numOfTraces%2===0){offset+=.5}var xValue=idx+offset*delta;if(typeof xval==="number"){xValue=xval+offset*delta}else if(viz.x.isDate){dateX=Date.parse(xval.indexOf(" ")===-1?xval+" 00:00:00":xval);var datefunc=allUnique?"":viz.x.func;switch(datefunc){case"rtoyear":xValue=dateX+offset*delta*31536e6;break;case"rtoq":xValue=dateX+offset*delta*7776e6;break;case"rtomon":xValue=dateX+offset*delta*2592e6;break;case"rtoweek":xValue=dateX+offset*delta*6048e5;break;case"rtoday":xValue=dateX+offset*delta*864e5;break;case"rtohour":xValue=dateX+offset*delta*36e5;break;case"rtomin":xValue=dateX+offset*delta*6e5;break;case"rtosec":xValue=dateX+offset*delta*1e3;break;default:xValue=dateX+offset*delta;break}}var yValue=group.stacky?group.stacky[idx]:group.y[idx];return{x:xValue,y:yValue,text:formatValue(group.y[idx])+y1ValueSuffix,xanchor:"center",yanchor:yValueOnPlot,showarrow:false}}))}else{offset=gidx-pivot;if(numOfTraces%2===0){offset+=.5}var xValue=0+offset*delta;annotationContext=annotationContext.concat([{x:xValue,y:group.stacky?group.stacky[0]:group.y[0],text:group.y[0]===0?"":formatValue(group.y[0])+y1ValueSuffix,xanchor:"center",yanchor:yValueOnPlot,showarrow:false}])}}else{if(viz.x){annotationContext=annotationContext.concat(group.x.map(function(xval,idx){return{x:xval,y:group.stacky?group.stacky[idx]:group.y[idx],text:group.y[idx]===0?"":formatValue(group.y[idx])+y1ValueSuffix,xanchor:"center",yanchor:yValueOnPlot,showarrow:false}}))}else{annotationContext=annotationContext.concat([{x:0,y:group.stacky?group.stacky[0]:group.y[0],text:group.y[0]===0?"":formatValue(group.y[0])+y1ValueSuffix,xanchor:"center",yanchor:yValueOnPlot,showarrow:false}])}}});layout.annotations=annotationContext}}if(marker==="bar"&&barstyle==="stack"&&color){layout.legend.traceorder="reversed";PlotlyGraphGenerator.reverseColorOrder(gData)}if(barstyle==="group"&&gData.filter(function(g){return g.use2ndAxis}).length>0){var gDualYedData=[];gData.forEach(function(g){if(g.use2ndAxis){gDualYedData.push({x:[g.x[0]],y:[0],type:"bar",hoverinfo:"none",showlegend:false,yaxis:"y"});gDualYedData.push(g)}else{gDualYedData.push(g);gDualYedData.push({x:[g.x[0]],y:[0],type:"bar",hoverinfo:"none",showlegend:false,yaxis:"y2"})}});gData=gDualYedData}if(orientation==="horizontal"){PlotlyGraphGenerator._switchOrientation(gData,layout)}if(marker==="hist"){viz.y=VizUtil.NUMROWS_COL_TEMPLATE;gVRefLineLayerData=consolidateRefLines(gVRefLineLayerData)}gRefLineUpperRangeLayerData=gRefLineUpperRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gRefLineLowerRangeLayerData=gRefLineLowerRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gRefLineLayerData=gRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false});gVRefLineConfIntLayerData=gVRefLineConfIntLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gVRefLineLayerData=gVRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false});recalculateRefLineData(viz,gRefLineLayerData,layout);recalculateRefLineData(viz,gRefLineUpperRangeLayerData,layout);recalculateRefLineData(viz,gRefLineLowerRangeLayerData,layout);recalculateVRefLineData(viz,gVRefLineLayerData,layout);layout.showlegend=!(!viz.color&&numY<2&&gRefLineLayerData.length===0&&gVRefLineLayerData.length===0);if(viz.legendLocation==="none"){layout.showlegend=false}gDataFiltered=[].concat(gData).concat(gRefLineUpperRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRefLineLowerRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false})).concat(gVRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false}));if(marker==="bar"){if(viz.yAxisIncludeZero!=="off"&&/^(circle|line)$/.test(viz.yMarkerShape)){if(layout.yaxis.range){layout.yaxis.range=d3.extent(layout.yaxis.range.concat([0]))}else{layout.yaxis.range=calculateRange(gData,"y",true,false,marker,null,null,null,null,null,"y1",.04,.04)}if(userYAxisRange&&viz.y&&viz.y.isNumeric){layout.yaxis.range=userYAxisRange}}if(colsOn2ndAxis&&colsOn2ndAxis.length>0&&viz.y2AxisIncludeZero!=="off"&&/^(circle|line)$/.test(viz.y1MarkerShape)){if(layout.yaxis2.range){layout.yaxis2.range=d3.extent(layout.yaxis2.range.concat([0]))}else{layout.yaxis2.range=calculateRange(gData,"y",true,false,marker,null,null,null,null,null,"y2",.04,.04)}if(userY2AxisRange&&viz.y&&viz.y.isNumeric){layout.yaxis2.range=userY2AxisRange}}}Plotly.newPlot(divElem,gDataFiltered,layout,config);PlotlyGraphGenerator._addCustomBalloon(divElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback);break;case"line":case"bubble":if(marker==="line"&&viz.x&&(viz.x.func==="aschar"||!viz.x.isNumeric&&!viz.x.isDate)){layout.xaxis.type="category"}gData=gData.map(function(datum){datum.type=datum.type||"scatter";datum.mode=datum.mode||"lines";datum.hoverinfo="text";if(marker==="bubble"&&labelOnPlot==="on"&&label){datum.mode+="+text";datum.textposition=labelOnPlotVAlign+" "+labelOnPlotHAlign;datum.hoverinfo="x+y+z"}if(marker==="bubble"){datum.marker.sizemode="diameter";datum.marker.sizemin=circleMinSize/2;if(!datum.marker.size){datum.marker.size=circleMinSize}}return datum});if(facet){constructFacetData(viz,gData,layout,colorarr&&colorarr.length>0?colorarr[0]:null,gRangeLayerData,gTrendLineLayerData,gTrendLineRangeLayerData,colsOn2ndAxis,gRefLineLayerData,gRefLineUpperRangeLayerData,gRefLineLowerRangeLayerData,gVRefLineLayerData,gVRefLineConfIntLayerData)}else{if(/^(bubble)$/.test(marker)&&viz.xAxisIncludeZero==="on"){layout.xaxis.range=calculateRange(gData.concat(gRangeLayerData).concat(gTrendLineLayerData).concat(gTrendLineRangeLayerData).concat(gRefLineLayerData).concat(gRefLineUpperRangeLayerData).concat(gRefLineLowerRangeLayerData),"x",true,false,marker,yValueOnPlot,false,barstyle,color,isMultiY,"x")}var _includeZeroOnYAxis=/^(bubble)$/.test(marker)&&viz.yAxisIncludeZero==="on"||marker==="line"&&viz.yAxisIncludeZero!=="off";layout.yaxis.range=calculateRange(gData.concat(gRangeLayerData).concat(gTrendLineLayerData).concat(gTrendLineRangeLayerData).concat(gRefLineLayerData).concat(gRefLineUpperRangeLayerData).concat(gRefLineLowerRangeLayerData),"y",_includeZeroOnYAxis,false,marker,null,null,null,null,null,"y1");if(userYAxisRange&&viz.y&&viz.y.isNumeric){layout.yaxis.range=userYAxisRange}if(colsOn2ndAxis&&colsOn2ndAxis.length>0){var _includeZeroOnY2Axis=/^(bubble)$/.test(marker)&&viz.y2AxisIncludeZero==="on"||marker==="line"&&viz.y2AxisIncludeZero!=="off";layout.yaxis2.range=calculateRange(gData.concat(gRangeLayerData).concat(gTrendLineLayerData).concat(gTrendLineRangeLayerData).concat(gRefLineLayerData).concat(gRefLineUpperRangeLayerData).concat(gRefLineLowerRangeLayerData),"y",_includeZeroOnY2Axis,false,marker,null,null,null,null,null,"y2");if(userY2AxisRange&&viz.y&&viz.y.isNumeric){layout.yaxis2.range=userY2AxisRange}}if(yValueOnPlot!=="none"){annotationContext=[];gData.forEach(function(group){if(group.x){annotationContext=annotationContext.concat(group.x.map(function(x,idx){return{x:x,y:group.y[idx],xref:group.xaxis?group.xaxis:"x",yref:group.yaxis?group.yaxis:"x",text:group.y[idx]===0?"":formatValue(group.y[idx])+y1ValueSuffix,xanchor:"center",yanchor:yValueOnPlot,showarrow:false}}))}else if(group.y&&group.y.length>0){annotationContext=annotationContext.concat({x:0,y:group.y[0],xref:group.xaxis?group.xaxis:"x",yref:group.yaxis?group.yaxis:"x",text:group.y[0]===0?"":formatValue(group.y[0])+y1ValueSuffix,xanchor:"center",yanchor:yValueOnPlot,showarrow:false})}});layout.annotations=annotationContext}}if(marker==="bubble"){gRefLineUpperRangeLayerData=consolidateRefLines(gRefLineUpperRangeLayerData);gRefLineLowerRangeLayerData=consolidateRefLines(gRefLineLowerRangeLayerData);gRefLineLayerData=consolidateRefLines(gRefLineLayerData);gVRefLineLayerData=consolidateRefLines(gVRefLineLayerData)}gRefLineUpperRangeLayerData=gRefLineUpperRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gRefLineLowerRangeLayerData=gRefLineLowerRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gRefLineLayerData=gRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false});gVRefLineConfIntLayerData=gVRefLineConfIntLayerData.filter(function(d){return d.x.length>0&&d.y.length>0});gVRefLineLayerData=gVRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false});recalculateRefLineData(viz,gRefLineLayerData,layout);recalculateRefLineData(viz,gRefLineUpperRangeLayerData,layout);recalculateRefLineData(viz,gRefLineLowerRangeLayerData,layout);recalculateVRefLineData(viz,gVRefLineLayerData,layout);layout.showlegend=!(!viz.color&&numY<2&&gRefLineLayerData.length===0&&gVRefLineLayerData.length===0);if(viz.legendLocation==="none"){layout.showlegend=false}gDataFiltered=[].concat(gData).concat(gTrendLineRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gVRefLineConfIntLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRefLineUpperRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRefLineLowerRangeLayerData.filter(function(d){return d.x.length>0&&d.y.length>0})).concat(gRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false})).concat(gVRefLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0&&d.visible!==false})).concat(gTrendLineLayerData.filter(function(d){return d.x.length>0&&d.y.length>0}));Plotly.newPlot(divElem,gDataFiltered,layout,config);PlotlyGraphGenerator._addCustomBalloon(divElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback);break;case"area":layout.hovermode="x";if(viz.x&&(viz.x.func==="aschar"||!viz.x.isNumeric&&!viz.x.isDate)){layout.xaxis.type="category"}gData=gData.map(function(datum,idx){datum.fill=idx===0?"tozeroy":"tonexty";datum.type="scatter";datum.mode="none";datum.hoverinfo="text";datum.fillcolor=VizUtil.hexToRgba(datum.marker.color||"#1f77b4",opacity||.68);if(datum.y&&isArray(datum.y)&&datum.text&&isArray(datum.text)){datum.y.forEach(function(yvalue,idx){if(yvalue===0){datum.text[idx]=null}})}return datum});if(facet){constructFacetData(viz,gData,layout,colorarr&&colorarr.length>0?colorarr[0]:null)}else{gData=convertToStackedYValue(gData);layout.yaxis.range=calculateRange(gData,"y",true,false,marker,null,null,null,null,null,"y1");if(userYAxisRange&&viz.y&&viz.y.isNumeric){layout.yaxis.range=userYAxisRange}if(yValueOnPlot!=="none"){annotationContext=[];gData.forEach(function(group){annotationContext=annotationContext.concat(group.x.map(function(x,idx){return{x:x,y:group.y[idx],xref:group.xaxis?group.xaxis:"x",yref:group.yaxis?group.yaxis:"x",text:group.origy[idx]===0?"":formatValue(group.origy[idx])+y1ValueSuffix,xanchor:"center",yanchor:yValueOnPlot,showarrow:false}}))});layout.annotations=annotationContext}}if(color){layout.legend.traceorder="reversed";PlotlyGraphGenerator.reverseColorOrder(gData)}Plotly.newPlot(divElem,gData,layout,config);PlotlyGraphGenerator._addCustomBalloon(divElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback);break;case"pie":var _pieDataHash={},_pieDataList=[],_xaxis,_yaxis;if(facet){constructFacetData(viz,gData,layout,colorarr&&colorarr.length>0?colorarr[0]:null)}gData.forEach(function(d){var hashkey=(d.xaxis||"")+(d.yaxis||"");var pieData=_pieDataHash[hashkey];if(!pieData){pieData={values:[],_realvalues:[],labels:[],text:[],hovertext:[],customdata:[],type:"pie",textinfo:"text",textposition:[],hoverinfo:"text",marker:{colors:[]},sort:false,textfont:{},hole:pieHole,direction:"clockwise"};if(viz.plotAreaFontSize){pieData.textfont.size=viz.plotAreaFontSize}_pieDataHash[hashkey]=pieData;_pieDataList.push(pieData)}if(d.xaxis&&d.yaxis){_xaxis=layout[d.xaxis.replace(/^x/,"xaxis")];_yaxis=layout[d.yaxis.replace(/^y/,"yaxis")];pieData.domain={x:_xaxis.domain,y:_yaxis.domain};pieData._xref=d.xaxis;pieData._yref=d.yaxis;pieData._titleText=_xaxis.title;pieData._titleFontSize=_xaxis.titlefont?_xaxis.titlefont.size:null}i=d.y[d.y.length-1]||0;pieData._realvalues.push(i);if(i<0){i=Math.abs(i)}pieData.values.push(i);pieData.hovertext.push(d.text[d.text.length-1]);pieData.customdata.push(d.customdata[d.customdata.length-1]);pieData.labels.push(d.name);pieData.marker.colors.push(VizUtil.hexToRgba(d.marker.color,opacity||.8))});_pieDataList.forEach(function(d){d._summary=d._realvalues.reduce(function(acc,cur){return acc+cur});var sum=d.values.reduce(function(acc,cur){return acc+cur});d.pcts=d.values.map(function(v){return v/sum*100});d.text=d._realvalues.map(function(v,idx){var textinfo=[];if(viz.pieShowPercentages!=="off"){textinfo.push(formatValue(d.pcts[idx])+"%")}if(viz.pieShowValues==="on"){textinfo.push(formatValue(v))}if(viz.pieShowLabels==="on"){textinfo.push(d.labels[idx])}return textinfo.join("<br>")});d.hovertext=d.hovertext.map(function(v,idx){var arr=v.split("<br>");arr[0]+=" ("+formatValue(d.pcts[idx])+"%)";return arr.join("<br>")});d.textposition=d.pcts.map(function(v){return v<5?"none":"auto"})});if(!color){layout.showlegend=false;_pieDataList.forEach(function(d){d.labels[0]=viz.y.name})}Object.keys(layout).forEach(function(key){if(/^(xaxis|yaxis)/.test(key)){layout[key].showticklabels=false;layout[key].showline=false;layout[key].showgrid=false;layout[key].zeroline=false;layout[key].showspikes=false;layout[key].fixedrange=true;layout[key].nticks=0;if(/^yaxis/.test(key)||/^xaxis/.test(key)&&pieHole!==0){layout[key].visible=false;layout[key].title=""}}});delete layout.scene;if(pieHole!==0){layout.annotations=_pieDataList.map(function(d){var _title=xAxisShowTitle?d._titleText||(viz.y.name===VizUtil.NUMROWS_COL_NAME?VizUtil.NUMROWS_COL_LABEL:viz.y.name):"";return{font:{size:d._titleFontSize||(d.domain?12:14)},showarrow:false,text:_title+"<br>"+formatValue(d._summary),x:d.domain?d3.mean(d.domain.x):.5,y:d.domain?d3.mean(d.domain.y):.5,xref:"paper",yref:"paper",xanchor:"center",yanchor:"middle",align:"center"}})}gDataFiltered=_pieDataList.filter(function(d){var res=false;for(i=0,l=d.values.length;i<l;i++){if(typeof d.values[i]!=="undefined"&&d.values[i]!==null&&d.values[i]!==0){res=true;break}}return res});if(gDataFiltered.length===0){VizUtil.renderNoData(targetElem)}else{Plotly.newPlot(divElem,_pieDataList,layout,config);PlotlyGraphGenerator._addCustomBalloon(divElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback)}break;case"boxplot":if(!layout.xaxis){layout.xaxis={}}if(!viz.x){layout.yaxis.title=""}else{if(viz.x.func==="aschar"||!viz.x.isNumeric&&!viz.x.isDate){layout.xaxis.type="category"}}gData=gData.map(function(datum,idx){datum.type="box";if(!viz.x){datum.x=datum.x.map(function(){return viz.y.name})}datum.boxpoints=false;return datum});layout.boxmode="group";if(facet){constructFacetData(viz,gData,layout)}Plotly.newPlot(divElem,gData,layout,config);PlotlyGraphGenerator._addCustomBalloon(divElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback);break;case"heatmap":case"contour":gData=gData.map(function(datum){datum.type=marker;datum.hoverinfo="text";return datum});if(gData[0].y.length===1&&gData[0].y[0]===" "){layout.yaxis.ticklen=0}layout.xaxis.zeroline=false;layout.xaxis.showgrid=false;layout.yaxis.zeroline=false;layout.yaxis.showgrid=false;if(marker==="heatmap"){layout.xaxis.type="category";layout.yaxis.type="category"}Plotly.newPlot(divElem,gData,layout,config);PlotlyGraphGenerator._addCustomBalloon(divElem,onShowDetailCallback,onKeepThisCallback,onExcludeCallback);break;case"choropleth":gData=gData.map(function(datum){datum.type=marker;datum.hoverinfo="text";datum.z=datum.marker.color;datum.locations=datum.x;datum.locationmode=mapmode;datum.colorscale=datum.marker.colorscale;datum.showscale=false;datum.marker.line={color:"#ddd",width:.5};layout.margin={b:0,l:0,r:0,t:title?40:10,autoexpand:false,pad:0};switch(mapmode){case"USA-states":layout.geo={scope:"usa",showcoastlines:true,coastlinecolor:"#ccc",showcountries:true,countrycolor:"#ccc",showsubunits:true,subunitcolor:"#ccc",projection:{type:"albers usa"}};break;case"ISO-3":case"country names":layout.geo={showframe:false,showcoastlines:true,coastlinecolor:"#ccc",showcountries:true,countrycolor:"#ccc",projection:{type:"equirectangular"}};break}return datum});Plotly.newPlot(divElem,gData,layout,config);break;default:console.error("No such graph type supported: "+marker);break}};PlotlyGraphGenerator.getRenderSvgFunction=function(viz,data,onLoadCallback){var func=function(props){viz.width=props.width;viz.height=props.height;var targetElem=props.elem;PlotlyGraphGenerator.render(viz,data,targetElem,"svg",onLoadCallback)};return func};if(typeof module==="object"&&module.exports)module.exports=PlotlyGraphGenerator;var MapGenerator=function(){};var mapBoxConfig={id:"mapbox.light",accessToken:"pk.eyJ1Ijoia3NvYnVlIiwiYSI6ImNpZjhra2MyaDIweWVyeWx6aTI4cnU1eHoifQ.tFW7BQvQXKjdhfWDA66IgQ"};var mapConfig={minCircleSize:5,maxCircleSize:15,lineWidth:3,selectedLineWidth:5,borderWidth:1,selectedBorderWidth:3,pointRadius:5,pointBorderWidth:0,selectedPointBorderWidth:3};var formatValue=VizUtil.valueFormatterGenerator(2,true);MapGenerator.createInfoBox=function(){var info=L.control();info.onAdd=function(){this._div=L.DomUtil.create("div","info info-box");this.update();return this._div};info.update=function(values){var html="";if(values){var boxstyle="";var title=null,labels=[],long,lat;values.forEach(function(v){switch(v.type){case"title":title=v;break;case"label":labels.push(v);break;case"long":long=v;break;case"lat":lat=v;break}});if(title){html+='<div class="info-box-title">'+title.value+"</div>"}html+='<div class="info-box-table">';var labelHash={};var filteredLabels=[];labels.forEach(function(label){if(!labelHash[label.column.name+label.column.func]){filteredLabels.push(label);labelHash[label.column.name+label.column.func]=true}});var labelCols=filteredLabels.map(function(label){return label.column.name});filteredLabels=filteredLabels.map(function(label){label.suffix="";if(labelCols.indexOf(label.column.name)!==labelCols.lastIndexOf(label.column.name)&&label.column.func!=="none"){label.suffix=" ("+VizUtil.AGGREGATION_FUNCTION_OPTIONS_HASH[label.column.func]+")"}return label});filteredLabels.forEach(function(label){html+='<div class="info-box-value '+boxstyle+'">'+'  <div class="label-col">'+(label.column.name===VizUtil.NUMROWS_COL_NAME?VizUtil.NUMROWS_COL_LABEL:label.column.name)+label.suffix+":</div>"+'  <div class="value-col">'+label.value+"</div>"+"</div>"});if(long){html+='<div class="info-box-value '+boxstyle+'">'+'  <div class="label-col">Longitude:</div>'+'  <div class="value-col">'+long.value+"</div>"+"</div>"}if(lat){html+='<div class="info-box-value '+boxstyle+'">'+'  <div class="label-col">Latitude:</div>'+'  <div class="value-col">'+lat.value+"</div>"+"</div>"}html+="</div>"}else{html="Hover over or click an area."}this._div.innerHTML=html};return info};MapGenerator.createQuantLegend=function(bucketInfo,colorScale,colorOpacity,legendType){if(!bucketInfo.legend){return null}var legend=L.control({position:"bottomright"});legend.onAdd=function(){var div=L.DomUtil.create("div","info legend "+legendType);var buckets=bucketInfo.legend,ext,label;for(var i=0;i<buckets.length;i++){ext=buckets[i].extent;if(ext[0]===ext[1]){label=formatValue(buckets[i].extent[0])}else{label=formatValue(buckets[i].extent[0])+" &ndash; "+formatValue(buckets[i].extent[1])}
div.innerHTML+='<div class="legend-row"><i class="square" style="background-color:'+colorScale[buckets[i].id]+";opacity:"+colorOpacity+'"></i> '+label+"</div>"}return div};return legend};MapGenerator.createCatLegend=function(colorData,catColorScale,colorOpacity,legendType){var uniqs=VizUtil.distinct(colorData);var legend=L.control({position:"bottomright"});legend.onAdd=function(){var div=L.DomUtil.create("div","info legend "+legendType);for(var i=0;i<uniqs.length;i++){div.innerHTML+='<div class="legend-row"><i style="background:'+catColorScale(uniqs[i])+"; opacity:"+colorOpacity+' "></i> '+uniqs[i]+"</div>"}return div};return legend};MapGenerator.createCatColorScale=function(viz,numUniqsOnColor){var colorScale=numUniqsOnColor&&numUniqsOnColor>10?d3.scale.category20():d3.scale.category10(),colorarr;if(viz.customCategColorPalette&&viz.customCategColorPalette.length>0&&viz.categColorPalette==="custom"){colorarr=viz.customCategColorPalette.match(VizUtil.COLOR_PALETTE_REGEX);for(var i=0;i<colorarr.length;i++){if(VizUtil.hexToRgb(colorarr[i])===null){colorarr[i]="#CCCCCC"}}colorScale=d3.scale.ordinal().range(colorarr)}else if(viz.categColorPalette&&viz.categColorPalette!=="default"&&VizUtil.CATEG_COLOR_PALETTES_HASH[viz.categColorPalette]){colorarr=VizUtil.CATEG_COLOR_PALETTES_HASH[viz.categColorPalette].color;colorScale=d3.scale.ordinal().range(colorarr)}return colorScale};MapGenerator.createQuantColorPalette=function(viz){var quantColorPaletteOp=viz.quantColorPalette||"Blues";if(!VizUtil.QUANT_COLOR_PALETTES_HASH[quantColorPaletteOp]){quantColorPaletteOp="Blues"}var reverseColorPaletteOrderOp=viz.reverseColorPaletteOrder||"off";var quantColorPalette=VizUtil.QUANT_COLOR_PALETTES_HASH[quantColorPaletteOp].color.slice();if(reverseColorPaletteOrderOp==="on"){quantColorPalette.reverse()}quantColorPalette.unshift("#ffffff");return quantColorPalette};MapGenerator.noKeyMatch=function(data,keyCol,geojson,keyProp){var keycols=data.map(function(d){return d[keyCol]});var keyprops=geojson.features.map(function(feature){return feature.properties[keyProp]});var i,l;for(i=0,l=keycols.length;i<l;i++){if(keyprops.indexOf(keycols[i])!==-1){return false}}return true};MapGenerator.render=function(viz,data,elTarget,geoJSON,onLoadCallback,onErrorCallback,onZoomEndCallback,onMoveEndCallback,noThumbnail){try{MapGenerator._render(viz,data,elTarget,geoJSON,onLoadCallback,onZoomEndCallback,onMoveEndCallback,noThumbnail)}catch(e){if(onErrorCallback&&typeof onErrorCallback==="function"){onErrorCallback(e)}VizUtil.renderNoData(elTarget,"Graph rendering failed.");console.error(e)}};MapGenerator._render=function(viz,data,elTarget,geoJSON,onLoadCallback,onZoomEndCallback,onMoveEndCallback,noThumbnail){data=VizUtil.convertColumnarData(data);while(elTarget.childNodes.length>0){elTarget.removeChild(elTarget.firstChild)}if(!data&&!geoJSON||data&&data.length===0){VizUtil.renderNoData(elTarget);if(onLoadCallback&&typeof onLoadCallback==="function"){onLoadCallback()}return}var labelNameMap={};if(viz.x){labelNameMap[viz.x.label]=viz.x.name}if(viz.y){labelNameMap[viz.y.label]=viz.y.name}if(viz.size){labelNameMap[viz.size.label]=viz.size.name}if(viz.color){labelNameMap[viz.color.label]=viz.color.name}if(viz.label){labelNameMap[viz.label.label]=viz.label.name}if(viz.label2){labelNameMap[viz.label2.label]=viz.label2.name}var numDecimalDigits=viz.numDecimalDigits||2;var useThousandSeparator=viz.useThousandSeparator!=="off";formatValue=VizUtil.valueFormatterGenerator(numDecimalDigits,useThousandSeparator);var divElem=document.createElement("div");divElem.style.width="100%";divElem.style.height="100%";elTarget.appendChild(divElem);var map=L.map(divElem,{zoomControl:true,preferCanvas:true});if(onLoadCallback&&typeof onLoadCallback==="function"){map.on("load",onLoadCallback)}if(onZoomEndCallback&&typeof onZoomEndCallback==="function"){map.on("zoomend",onZoomEndCallback)}if(onMoveEndCallback&&typeof onMoveEndCallback==="function"){map.on("moveend",onMoveEndCallback)}var geoJSONLayer=null;L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{maxZoom:18,id:viz.mapType||mapBoxConfig.id,accessToken:mapBoxConfig.accessToken,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, '+'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, '+'Imagery &copy; <a href="http://mapbox.com">Mapbox</a>'}).addTo(map);var colorOpacity=viz.colorOpacity||.65;var quantColorPalette=MapGenerator.createQuantColorPalette(viz);var catColorScale=MapGenerator.createCatColorScale(viz);var bucketInfo=null,legend=null,colorData=null,colorHash=null,infobox=null;var zoomLevel=null,bounds=null;if(viz.mapZoomStatus){var arr=viz.mapZoomStatus.split(",");zoomLevel=parseInt(arr[0]);bounds=L.latLngBounds(L.latLng(parseFloat(arr[2]),parseFloat(arr[1])),L.latLng(parseFloat(arr[4]),parseFloat(arr[3])));if(!bounds.isValid()){bounds=null;zoomLevel=null}}switch(viz.marker){case"geojson":infobox=MapGenerator.createInfoBox();infobox.addTo(map);if(!geoJSON){map.setView([0,0],1);return}var nameHash=null;if(data){nameHash={};data.forEach(function(d){nameHash[d[viz.x.label]]=d})}var keyprop=viz.geojsonKeyProp;var featureFilter=function(feature){if(nameHash){return nameHash[feature.properties[keyprop]]}else{return true}};var options={};options.filter=featureFilter;var highlightFeature=function(e){var layer=e.target;layer.setStyle({weight:/^(LineString|MultiLineString)$/.test(layer.feature.geometry.type)?mapConfig.selectedLineWidth:layer.feature.geometry.type==="Point"?mapConfig.selectedPointBorderWidth:mapConfig.selectedBorderWidth});if(!L.Browser.ie&&!L.Browser.opera&&!L.Browser.edge){layer.bringToFront()}var infoboxValues=[];if(viz.x){infoboxValues.push({type:"title",column:viz.x,value:layer.feature.properties[keyprop]})}if(nameHash){if(viz.color){infoboxValues.push({type:"label",column:viz.color,value:formatValue(nameHash[layer.feature.properties[keyprop]][viz.color.label])})}if(viz.label){infoboxValues.push({type:"label",column:viz.label,value:formatValue(nameHash[layer.feature.properties[keyprop]][viz.label.label])})}if(viz.label2){infoboxValues.push({type:"label",column:viz.label2,value:formatValue(nameHash[layer.feature.properties[keyprop]][viz.label2.label])})}}infobox.update(infoboxValues)};var resetHighlight=function(e){var layer=e.target;e.target.setStyle({weight:/^(LineString|MultiLineString)$/.test(layer.feature.geometry.type)?mapConfig.lineWidth:layer.feature.geometry.type==="Point"?mapConfig.pointBorderWidth:mapConfig.borderWidth});infobox.update()};var onEachFeature=function(feature,layer){layer.on({mouseover:highlightFeature,mouseout:resetHighlight,click:highlightFeature})};options.onEachFeature=onEachFeature;var pointStyles={radius:mapConfig.pointRadius,weight:0,opacity:1,fillOpacity:colorOpacity};options.pointToLayer=function(feature,latlng){return L.circleMarker(latlng,pointStyles)};geoJSONLayer=L.geoJSON(geoJSON,options);if(zoomLevel&&bounds){try{map.setZoom(zoomLevel)}catch(e){console.log(e)}map.fitBounds(bounds)}else{var geoLayerBounds=geoJSONLayer.getBounds();if(L.latLngBounds(geoLayerBounds).isValid()){map.fitBounds(geoLayerBounds)}else{map.setView([0,0],1)}}if(data){var styleFunc;if(viz.colorbucket){bucketInfo=VizUtil.getBucketInfo(data,viz.colorbucket.label);styleFunc=function(feature){var styles={weight:/^(LineString|MultiLineString)$/.test(feature.geometry.type)?mapConfig.lineWidth:feature.geometry.type==="Point"?mapConfig.pointBorderWidth:mapConfig.borderWidth};var v=nameHash[feature.properties[keyprop]];if(v){if(/^(LineString|MultiLineString)$/.test(feature.geometry.type)){styles.color=quantColorPalette[bucketInfo.map[v[viz.colorbucket.label]]]}else{styles.color=viz.polygonBorderColor||"#FFFFFF";styles.fillColor=quantColorPalette[bucketInfo.map[v[viz.colorbucket.label]]];styles.fillOpacity=colorOpacity}}else{styles.color="transparent"}return styles};legend=MapGenerator.createQuantLegend(bucketInfo,quantColorPalette,colorOpacity,"square")}else{styleFunc=function(feature){var styles={weight:/^(LineString|MultiLineString)$/.test(feature.geometry.type)?mapConfig.lineWidth:feature.geometry.type==="Point"?mapConfig.pointBorderWidth:mapConfig.borderWidth};var v=nameHash[feature.properties[keyprop]];if(v){if(/^(LineString|MultiLineString)$/.test(feature.geometry.type)){styles.color=catColorScale(v[viz.color.label])}else{styles.color=viz.polygonBorderColor||"#FFFFFF";styles.fillColor=catColorScale(v[viz.color.label]);styles.fillOpacity=colorOpacity}}else{styles.color="transparent"}return styles};colorHash={};colorData=data.map(function(datum){colorHash[datum[viz.color.label]]=1;return datum[viz.color.label]});catColorScale=MapGenerator.createCatColorScale(viz,Object.keys(colorHash).length);catColorScale.domain(colorData);legend=MapGenerator.createCatLegend(colorData,catColorScale,colorOpacity,"square")}geoJSONLayer.setStyle(styleFunc);if(legend){legend.addTo(map)}}else{geoJSONLayer.setStyle(function(feature){return{weight:/^(LineString|MultiLineString)$/.test(feature.geometry.type)?mapConfig.lineWidth:feature.geometry.type==="Point"?mapConfig.pointBorderWidth:mapConfig.borderWidth}})}geoJSONLayer.addTo(map);break;case"map":if(viz.x&&viz.y){var showLines=viz.mapShowLines==="on";var normalizeSize=viz.size&&viz.mapNormalizeSizeByGroup==="on"&&showLines;var DEFAULT_GROUP_NAME="default";var CALCULATED_LONG="..lng";var CALCULATED_SIZE="..sz";infobox=MapGenerator.createInfoBox();infobox.addTo(map);if(viz.color){colorHash={};colorData=data.map(function(datum){colorHash[datum[viz.color.label]]=1;return datum[viz.color.label]});catColorScale=MapGenerator.createCatColorScale(viz,Object.keys(colorHash).length);catColorScale.domain(colorData);if(viz.colorbucket){bucketInfo=VizUtil.getBucketInfo(data,viz.colorbucket.label);legend=MapGenerator.createQuantLegend(bucketInfo,quantColorPalette,colorOpacity,"circle")}else{legend=MapGenerator.createCatLegend(colorData,catColorScale,colorOpacity,"circle")}if(legend){legend.addTo(map)}}var minSize=parseFloat(viz.circleMinSize)||mapConfig.minCircleSize;var maxSize=parseFloat(viz.circleMaxSize)||mapConfig.maxCircleSize;var sizeScale=d3.scale.linear().domain([0,0]).rangeRound([minSize,maxSize]);if(viz.size){if(normalizeSize){sizeScale.domain([0,1])}else{var sizeData=data.map(function(datum){return datum[viz.size.label]});sizeScale.domain([d3.min(sizeData),d3.max(sizeData)])}}var polylines=[];if(showLines){var lineData=data.filter(function(d){return!VizUtil.isEmpty(d[viz.y.label])&&!VizUtil.isEmpty(d[viz.x.label])});var groupbyCol=!!viz.label?viz.label.label:!!viz.color?viz.color.label:null;var colorCol=!!viz.color?viz.color.label:null;lineData=groupbyCol?d3.nest().key(function(d){return d[groupbyCol]}).entries(lineData):[{key:DEFAULT_GROUP_NAME,values:data}];lineData.forEach(function(datum,idx){if(datum.values&&datum.values.length>1){if(!VizUtil.isEmpty(datum.values[0][VizUtil.ORIGINAL_ORDER_COL_NAME])){datum.values.sort(function(a,b){return b[VizUtil.ORIGINAL_ORDER_COL_NAME]-a[VizUtil.ORIGINAL_ORDER_COL_NAME]})}var colorValue=groupbyCol===colorCol?catColorScale(datum.key):colorCol&&datum.values[0][colorCol]?catColorScale(datum.values[0][colorCol]):catColorScale(DEFAULT_GROUP_NAME);if(viz.colorbucket&&bucketInfo){colorValue=quantColorPalette[bucketInfo.map[datum.values[0][viz.colorbucket.label]]]}var msg="";for(var key in datum.values[0]){if(labelNameMap[key]){var value=datum.values[0][key];msg+='<div class="popup-content-row"><div class="popup-content-cell">'+labelNameMap[key]+':</div><div class="popup-content-cell">'+formatValue(value)+"</div></div>"}}if(normalizeSize){var sizes=datum.values.map(function(v){return v[viz.size.label]});var sscale=d3.scale.linear().domain(d3.extent(sizes)).range([0,1]);datum.values.forEach(function(v){v[CALCULATED_SIZE]=sscale(v[viz.size.label])})}var lng=null,lat=null,prevlng=null;var latlngs=datum.values.map(function(v){lng=v[viz.x.label];lat=v[viz.y.label];if(prevlng!==null&&Math.abs(lng-prevlng)>180&&lng*prevlng<0){if(prevlng<0){lng=lng-360}else{lng=lng+360}}prevlng=lng;v[CALCULATED_LONG]=lng;return L.latLng(lat,lng)});var polyline=L.polyline(latlngs,{color:colorValue,opacity:colorOpacity,dashArray:viz.mapDashedLines==="on"?"5, 5":null,"data-line-id":idx});polyline.on("mouseover",function(evt){var dataidx=evt.target.options["data-line-id"];var dt=lineData[dataidx].values[0];var infoboxValues=[];if(viz.label){infoboxValues.push({type:"title",column:viz.label,value:formatValue(dt[viz.label.label])});if(viz.color){infoboxValues.push({type:"label",column:viz.color,value:formatValue(dt[viz.color.label])})}}else if(viz.color){infoboxValues.push({type:"title",column:viz.color,value:formatValue(dt[viz.color.label])})}infobox.update(infoboxValues);polyline.setStyle({weight:5})});polyline.on("mouseout",function(){infobox.update();polyline.setStyle({weight:3})});polylines.push(polyline)}})}var circles=[];data.forEach(function(datum,idx){if(VizUtil.isEmpty(datum[viz.y.label])||VizUtil.isEmpty(datum[viz.x.label])){return}var colorValue=catColorScale(viz.color?datum[viz.color.label]:DEFAULT_GROUP_NAME);if(viz.colorbucket&&bucketInfo){colorValue=quantColorPalette[bucketInfo.map[datum[viz.colorbucket.label]]]}var sizeValue=sizeScale(viz.size?normalizeSize?datum[CALCULATED_SIZE]||0:datum[viz.size.label]:null);var msg="";for(var key in datum){if(labelNameMap[key]){var value=datum[key];msg+='<div class="popup-content-row"><div class="popup-content-cell">'+labelNameMap[key]+':</div><div class="popup-content-cell">'+formatValue(value)+"</div></div>"}}var circleMarker=L.circleMarker(L.latLng(datum[viz.y.label],datum[CALCULATED_LONG]||datum[viz.x.label]),{stroke:false,color:"#ffffff",fillColor:colorValue,fillOpacity:colorOpacity,radius:sizeValue,"data-id":idx});circleMarker.on("mouseover",function(evt){var dataidx=evt.target.options["data-id"];var dt=data[dataidx];var infoboxValues=[];infoboxValues.push({type:"long",column:viz.x,value:formatValue(dt[viz.x.label])});infoboxValues.push({type:"lat",column:viz.y,value:formatValue(dt[viz.y.label])});if(viz.groupby){infoboxValues.push({type:"title",column:viz.x,value:formatValue(dt[viz.groupby.label])})}if(viz.size){infoboxValues.push({type:"label",column:viz.size,value:formatValue(dt[viz.size.label])})}if(viz.color){infoboxValues.push({type:"label",column:viz.color,value:formatValue(dt[viz.color.label])})}if(viz.label){infoboxValues.push({type:"title",column:viz.label,value:formatValue(dt[viz.label.label])})}if(viz.label2){infoboxValues.push({type:"label",column:viz.label2,value:formatValue(dt[viz.label2.label])})}infobox.update(infoboxValues);circleMarker.setStyle({stroke:true})});circleMarker.on("mouseout",function(){infobox.update();circleMarker.setStyle({stroke:false})});circles.push(circleMarker)});var circleGroup=L.featureGroup(polylines.concat(circles));circleGroup.addTo(map);if(zoomLevel&&bounds){try{map.setZoom(zoomLevel)}catch(e){console.log(e)}map.fitBounds(bounds)}else{var _bounds=circleGroup.getBounds();if(L.latLngBounds(_bounds).isValid()){map.fitBounds(_bounds)}else{map.setView([0,0],1)}}}else{map.setView([0,0],1)}break;case"maphmap":if(viz.x&&viz.y){var heatData=[],circleData=[];var mag=viz.maphmapMagnification?parseFloat(viz.maphmapMagnification):1;var rad=viz.maphmapRadius?parseInt(viz.maphmapRadius):25;if(data.length>1&&Array.isArray(data[0])&&Array.isArray(data[1])){data=data[1]}data.forEach(function(datum){if(VizUtil.isEmpty(datum[viz.y.label])||VizUtil.isEmpty(datum[viz.x.label])){return}heatData.push([datum[viz.y.label],datum[viz.x.label],viz.color?datum[viz.color.label]*mag:mag]);circleData.push(L.circleMarker(L.latLng(datum[viz.y.label],datum[viz.x.label])))});var heatLayer=L.heatLayer(heatData,{radius:rad});heatLayer.addTo(map);if(zoomLevel&&bounds){try{map.setZoom(zoomLevel)}catch(e){console.log(e)}map.fitBounds(bounds)}else{var _feat=L.featureGroup(circleData);var _bounds=_feat.getBounds();if(L.latLngBounds(_bounds).isValid()){map.fitBounds(_bounds)}else{map.setView([0,0],1)}}}else{map.setView([0,0],1)}break;default:break}if(typeof module==="object"&&module.exports&&map&&!noThumbnail){global._leaflet_map_obj=map}if(elTarget.classList.contains("markdown-viz-container")){if(!window._leaflet_map_objs)window._leaflet_map_objs={};window._leaflet_map_objs[elTarget.id.replace(/^div-/,"")]=map}};MapGenerator.getRenderFunction=function(viz,data,geojson,onLoadCallback,onErrorCallback,noThumbnail){var func=function(props){viz.width=props.width;viz.height=props.height;var elTarget=props.elem;MapGenerator.render(viz,data,elTarget,geojson,onLoadCallback,onErrorCallback,noThumbnail)};return func};if(typeof module==="object"&&module.exports)module.exports=MapGenerator;