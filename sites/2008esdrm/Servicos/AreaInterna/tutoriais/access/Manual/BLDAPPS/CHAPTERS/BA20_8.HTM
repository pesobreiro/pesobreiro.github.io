<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html><head><title>Handling Conflicts and Errors</title>
<link REL="STYLESHEET" HREF="naetugp.css" TYPE="text/css">
<script Language="VBScript">
Dim look
Sub SyncURL(look)
if right(top.frames(0).frames(1).location.href, 10)="toc_tc.htm" then
top.frames(0).frames(1).TreeCtl1.SyncToURL(look)
end if
End Sub
</script>
<meta name="Microsoft Theme" content="expeditn 011, default"></head>
<!--DocHeaderStart-->
<body background="../../../../_themes/expeditn/exptextb.jpg" bgcolor="#FFFFFF" text="#000000" link="#993300" vlink="#666600" alink="#CC3300"><!--mstheme--><font face="book antiqua, times new roman, times"><a HREF="ba20_7.htm" OnClick="SyncURL(&quot;chapters/ba20_7.htm&quot;)"><img SRC="..\images\prevpage.gif" ALT="Previous Page" ALIGN="RIGHT" BORDER="0"></a>
<!--DocHeaderEnd-->
<!-- This is a PANDA Generated HTML file. The source is a WinWord Document. -->
<a NAME="3HandlingConflictsandErrors"></a>
<p CLASS="heading3OrgHeading1h1">Handling Conflicts and Errors</p>
<p CLASS="Textttext">When using database replication, you may occasionally encounter design errors, synchronization conflicts, or synchronization errors. <span CLASS="NewTermntrm">Design errors</span> occur when a design change in the Design Master conflicts with a design change in a replica. The synchronization fails and the content of different replicas starts to diverge. <span CLASS="NewTermntrm">Synchronization conflicts</span> occur when users update the same record at two replicas in the replica set and Microsoft Jet attempts to synchronize the two versions. The synchronization succeeds, but the changes from only one of the replicas are applied to the other. <span CLASS="NewTermntrm">Synchronization errors</span> occur when a change to data in one replica cannot be applied to another replica because it would violate a constraint, such as a referential integrity rule. The synchronization succeeds, but the content of replicas is different.
<p CLASS="Textttext">Synchronization errors and design errors are more significant problems than synchronization conflicts because the replicas no longer share a common design or identical data. This section describes the factors that contribute to conflicts and errors, and suggests ways to prevent or resolve them.</p>
<a NAME="4DesignErrors"></a>
<p CLASS="heading4OrgHeading2h2">Design Errors</p>
<p CLASS="Textttext">When you make changes to the design of your database, Microsoft Jet records each change in the MSysSchChange system table. When Microsoft Jet applies all the design changes from one replica to another, it applies the changes in the exact order that the changes occurred in the Design Master. This ensures that all replicas become identical to the Design Master.
<p CLASS="Textttext">A design error most often occurs when you attempt to synchronize design changes with a replica that is opened exclusively. A locking error occurs, and the design changes are not transferred to the replica.
<p CLASS="Textttext">A design error can also occur if you set a primary key on a field in your replica and, before you synchronize this change, a user enters a duplicate value in that field in another replica. When you synchronize with the other replica, Microsoft Jet determines that the records do not have unique identifiers and, therefore, the field cannot be used as a primary key.
<p CLASS="Textttext">The MSysSchemaProb table is present only when an error has occurred in updating the design of a replica. The table provides details about the cause of the error, including:</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspThe action that failed (Create Index, Create Table, and so on).</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspThe text of the error message.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspThe version number of the replica that encountered the problem.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspContext information such as table names and field names.</p>
<p CLASS="Textttext">The MSysSchemaProb table is a local table and is not replicated. The records in the MSysSchemaProb table are automatically deleted when the corresponding design change is successfully applied during synchronization.</p>
<a NAME="5CorrectingDesignErrors"></a>
<p CLASS="heading5OrgHeading3h3">Correcting Design Errors</p>
<p CLASS="Textttext">To correct design errors, use the MSysSchemaProb table to identify the action that failed and then manually correct the corresponding object in the replica. You always fix the problem at the replica even if a design change in the Design Master caused the error.
<p CLASS="Textttext">For example, to correct a locking error that is caused by trying to synchronize with a replica that is open exclusively, close the replica and try the synchronization again.</p>
<a NAME="4SynchronizationConflicts"></a>
<p CLASS="heading4OrgHeading2h2">Synchronization Conflicts</p>
<p CLASS="Textttext">When you synchronize replicas, conflict between versions is always possible because the same record may be updated at two different locations. If this happens, Microsoft Jet can't determine which of the two changes should take precedence.
<p CLASS="Textttext">Microsoft Jet accepts the changes from one replica and records the rejected changes in a conflict table in the replica whose changes were not accepted. By default, the record with the most changes since the last synchronization has priority. Microsoft Jet doesn't look at the content of the data that has changed; instead, it examines the version number of the record. Each time a change is made to the data in a record, the version number increases by one. For example, a record with no changes has a version number of 0. A change to data changes the version number to 1. A second change to the same data, or a change to different data in the record, changes the version number to 2, and so on. The update with the higher version number wins because the Synchronizer assumes that the replica that changed the most frequently is the correct version. When two replicas give an updated record the same version number, Microsoft Jet chooses which update to accept based upon the value of the <span CLASS="ElementNameeln">ReplicaID</span> property. Because you cannot change the algorithm used to decide which changes are accepted and which are rejected, be prepared to manually resolve the errors in any replica.
<p CLASS="Textttext">Conflict tables derive both their names and fields from the underlying tables. Conflict table names are in the form <span CLASS="NewTermntrm">table</span>_conflict, where <span CLASS="NewTermntrm">table</span> is the original table name. For example, if the original table name is Customers, the conflict table name is Customers_conflict. Because conflicts are reported only to the replica that originated the losing update, conflict tables are not replicated.</p>
<a NAME="5ResolvingSynchronizationConflicts"></a>
<p CLASS="heading5OrgHeading3h3">Resolving Synchronization Conflicts</p>
<p CLASS="Textttext">After synchronizing two replicas, review the database for conflicts and determine whether you need to take any further action. You can determine if a conflict has occurred for a specific table by using the <span CLASS="ElementNameeln">ConflictTable</span> property. This property returns the name of the conflict table that contains the database records that conflicted during synchronization. If there is no conflict table, or if the database is read-only or is a replica, the<span CLASS="ElementNameeln"> ConflictTable</span> property returns a zero-length string (&quot;&quot;).
<p CLASS="Textttext">You can then examine the conflicts and work through them record by record, fixing whatever is appropriate. For example, you can:</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspManually update the database table with the data from its conflict table.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspLeave the database unchanged and delete the record from the conflict table.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspDevelop a custom conflict resolution routine that always assigns a higher priority to changes in one specific replica over another replica.</p>
<p CLASS="Textttext">Microsoft Access automatically notifies you of a synchronization conflict and provides the <span CLASS="ElementNameeln">Resolve Conflicts</span> command (<span CLASS="ElementNameeln">Tools</span> menu, <span CLASS="ElementNameeln">Replication</span> submenu) that you can use to view conflict tables and manually resolve each conflict.
<p CLASS="Textttext">You can substitute a custom conflict resolution routine for the <span CLASS="ElementNameeln">Resolve Conflicts </span>command. For example, to find the name of the conflict table associated with a table in your database, examine each record conflict, and take action to resolve each conflict, you can use the following code:</p>
<p CLASS="CodeTextct">Function ConflictResolver()<br>&nbsp;&nbsp;&amp;nbspDim dbs As Database<br>&nbsp;&nbsp;&amp;nbspDim tdf As TableDef<br>&nbsp;&nbsp;&amp;nbspDim fld As Field<br>&nbsp;&nbsp;&amp;nbspDim rstConflict As Recordset<br>&nbsp;&nbsp;&amp;nbspDim rstSource As Recordset<br>&nbsp;&nbsp;&amp;nbspSet dbs = CurrentDb<br>&nbsp;&nbsp;&amp;nbspFor Each tdf In dbs.TableDefs<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' Check to see if the table has a conflict table.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspIf (tdf.ConflictTable &lt;&gt; &quot;&quot;) Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspSet rstConflict = dbs.OpenRecordset(tdf.ConflictTable, dbsOpenTable)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspSet rstSource = dbs.OpenRecordset(tdf.Name, dbOpenTable)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstSource.Index = &quot;s_GUID&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstConflict.MoveFirst<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' Process the conflict table's records.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspDo While Not rstConflict.EOF<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstSource.Seek &quot;=&quot;, rstConflict![s_GUID]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspIf Not rstSource.NoMatch Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' Check to see if the losing record was more recent.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspIf rstSource.LastUpdated &lt; rstConflict.LastUpdated Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspOn Error Resume Next<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstSource.Edit<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' Update fields.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspFor each fld in rstSource.Fields<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstSource(fld.Name) = rstConflict(fld.Name)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspNext fld<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstSource.Update<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspOn Error GoTo 0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspEnd If<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspEnd If<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' Delete conflict record.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstConflict.Delete<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstConflict.MoveNext<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspLoop<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstConflict.Close<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsprstSource.Close<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspEnd If<br>&nbsp;&nbsp;&amp;nbspNext tdf<br>End Function</p>
<p CLASS="CrossRefTextcrt"><span CLASS="CrossRefHeadingcrh">See Also&nbsp;&nbsp;&nbsp;</span>For more information on custom conflict resolution code, search the Help index for &quot;ReplicationConflictFunction property.&quot;</p>
<a NAME="4SynchronizationErrors"></a>
<p CLASS="heading4OrgHeading2h2">Synchronization Errors</p>
<p CLASS="Textttext">There are four sources of potential synchronization errors to consider when building your application:</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&nbsp;<span CLASS="ElementNameeln">Table-level validation rules&nbsp;&nbsp;&nbsp;</span>With Microsoft Jet, you can establish table-level validation rules to restrict the value or type of data entered into a table. However, if you implement a rule without determining that any existing data doesn't violate the validation rule, you may encounter a synchronization error in the future. To correct the error, you correct the invalid values in the sending replica. You can avoid the error by synchronizing all replicas in the replica set before you apply a table-level validation rule.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&nbsp;<span CLASS="ElementNameeln">Duplicate keys&nbsp;&nbsp;&nbsp;</span>Duplicate keys can occur when two users at different replicas either simultaneously insert a new record and use the same primary key for their respective records or change the key on two different records when both happen to use the same value. When the replicas are synchronized, the synchronization succeeds, but Microsoft Jet records a duplicate key error in the MSysErrors table for each of the records that couldn't be inserted or updated. To correct a duplicate key error, change the value of one of the keys or delete the duplicate record.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&nbsp;<span CLASS="ElementNameeln">Referential integrity&nbsp;&nbsp;&nbsp;</span>Referential integrity preserves the relationship between tables when you're adding or deleting records. Enforced referential integrity prevents you from adding a record to or deleting a record from a related table if there is no corresponding record in the primary table. In some situations, enforced referential integrity can result in synchronization errors. To reduce referential integrity errors during synchronization, you may want to use the s_GUID field as the primary key in some or all of your replicated tables.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&nbsp;<span CLASS="ElementNameeln">Record locks&nbsp;&nbsp;&nbsp;</span>If a record is locked when Microsoft Jet attempts to update it during a synchronization, Microsoft Jet retries the update several times. If the record remains locked after repeated attempts, the synchronization fails, and Microsoft Jet records an error in the MSysErrors system table. Although this type of error is exceedingly rare, it may occur in certain multiuser applications. You can ignore errors caused by locked records because Microsoft Jet retries updating the records during the next synchronization. Because it's unlikely that the same record will be locked during the next synchronization, Microsoft Jet updates the record and removes the error from the MSysErrors table.</p>
<a NAME="5CorrectingSynchronizationErrors"></a>
<p CLASS="heading5OrgHeading3h3">Correcting Synchronization Errors</p>
<p CLASS="Textttext">Synchronization errors are recorded in the MSysErrors table and replicated to all replicas in the replica set. This table includes information about the:</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspTable involved.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspRecord that encountered the errors.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspReplica or replicas where the error was detected.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspReplica that last changed the record.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspType of operation that failed.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspReason it failed.</p>
<p CLASS="Textttext">Correct errors as soon as possible, because they indicate that the data in different replicas may be diverging. Be especially careful to correct synchronization errors before you move your database, because the error is recorded against the value of the <span CLASS="ElementNameeln">ReplicaID</span> property at the time the error occurred. If the value of the <span CLASS="ElementNameeln">ReplicaID</span> property changes, Microsoft Jet can't automatically remove the error records during a subsequent synchronization. If you don't remove the error record, you get an error each time you open the database even if you have corrected the problem.
<p CLASS="Textttext">In many circumstances, errors are self-correcting during the next synchronization. For example, if you attempt to synchronize a record that another user locked, the update fails. Microsoft Jet records an error and attempts to reapply the update at a later time. If the subsequent update succeeds, the error record is removed. As a general rule, always synchronize all replicas in the replica set before manually correcting synchronization errors. Due to the nature of bidirectional synchronizations, it may take more than one synchronization to clear the error record from the MSysErrors table after the error is corrected. However, Microsoft Jet should clear all corrected errors from the MSysErrors table after two bidirectional synchronizations.</p>
<p><!--DocFooterStart-->
<p><span CLASS="copyright"><a HREF="cpyright.htm">© 1996 Microsoft Corporation. All rights reserved.</a></span>
<p><!--DocFooterEnd-->
<a HREF="ba20_9.htm" OnClick="SyncURL(&quot;chapters/ba20_9.htm&quot;)"><img SRC="..\images\nextpage.gif" ALT="Next Page" ALIGN="RIGHT" BORDER="0"></a><!--mstheme--></font></body></html>
