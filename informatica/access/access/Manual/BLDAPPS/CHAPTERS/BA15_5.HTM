<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html><head><title>Database Maintenance</title>
<link REL="STYLESHEET" HREF="naetugp.css" TYPE="text/css">
<script Language="VBScript">
Dim look
Sub SyncURL(look)
if right(top.frames(0).frames(1).location.href, 10)="toc_tc.htm" then
top.frames(0).frames(1).TreeCtl1.SyncToURL(look)
end if
End Sub
</script>
<meta name="Microsoft Theme" content="expeditn 011, default"></head>
<!--DocHeaderStart-->
<body background="../../../../_themes/expeditn/exptextb.jpg" bgcolor="#FFFFFF" text="#000000" link="#993300" vlink="#666600" alink="#CC3300"><!--mstheme--><font face="book antiqua, times new roman, times"><a HREF="ba15_4.htm" OnClick="SyncURL(&quot;chapters/ba15_4.htm&quot;)"><img SRC="..\images\prevpage.gif" ALT="Previous Page" ALIGN="RIGHT" BORDER="0"></a>
<!--DocHeaderEnd-->
<!-- This is a PANDA Generated HTML file. The source is a WinWord Document. -->
<a NAME="3DatabaseMaintenance"></a>
<p CLASS="heading3OrgHeading1h1">Database Maintenance</p>
<p CLASS="Textttext">As your application is used, the database file can grow in size. If you are responsible for the maintenance of your database, you'll need to perform a number of system-oriented tasks from time to time, such as compacting the database and repairing it if it becomes corrupted. This section discusses these maintenance tasks.
<p CLASS="Textttext">If you are performing compact and repair operations, you will often use the menu commands provided in the user interface. The <span CLASS="ElementNameeln">Compact Database</span> and <span CLASS="ElementNameeln">Repair Database</span> commands are both available on the <span CLASS="ElementNameeln">Database Utilities</span> submenu (<span CLASS="ElementNameeln">Tools</span> menu) in the Microsoft Access startup window.
<p CLASS="Textttext">However, if you want to provide a way for your users to compact and repair their copies of your application, you can provide them with either an icon that performs the compact and repair operations or code that compacts and repairs the database automatically.
<p CLASS="Textttext">You can create a shortcut that uses the <span CLASS="ElementNameeln">/compact</span> or <span CLASS="ElementNameeln">/repair</span> command-line options. You can specify either option, or both. If you specify both the <span CLASS="ElementNameeln">/compact</span> and <span CLASS="ElementNameeln">/repair</span> options, the repair always happens before the compact. These command-line options compact and repair your application without opening it. When you create the shortcut, type a command line that consists of:</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspThe Microsoft Access application file name, MSAccess.exe. If you are using Microsoft Windows NT Workstation, you must specify a full path to the Microsoft Access application file.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspThe file name of the front-end database.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspEither the <span CLASS="ElementNameeln">/compact</span> option, the <span CLASS="ElementNameeln">/repair</span> option, or both.</p>
<p CLASS="ImportantTextit"><span CLASS="ImportantHeadingih">Important&nbsp;&nbsp;&nbsp;</span>To compact or repair a database, the database and any connections to it must be closed. Also, if you have established user-level security for your application, the user running the repair or compact operation must have Open Exclusive permission for the database, and have Modify Design or Administer permission for all tables in the database. For more information on permissions, search the Help index for &quot;setting permissions.&quot; Additionally, when compacting, there must be sufficient disk space for both the original and compacted versions of the database, even if the database is being compacted to the same file name. This is because the compacted database is renamed as the original database only after compacting to a temporary file is successful.</p>
<a NAME="4CompactingaDatabase"></a>
<p CLASS="heading4OrgHeading2h2">Compacting a Database</p>
<p CLASS="Textttext">To maintain a high state of performance, Microsoft Access defers the removal of discarded pages until you shut down the database and compact the discarded pages. This design keeps the interactive performance of your database high at the expense of recoverable disk space.
<p CLASS="Textttext">Compacting a database:</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspReorganizes a table's pages so they reside in adjacent database pages. This improves performance because the table is no longer fragmented across the database. If a table has a primary key defined, Microsoft Access copies the records in primary key order, which makes reading ahead more efficient. This produces an effect similar to clustered indexes in Microsoft SQL Server; however, unlike true clustered indexes, Microsoft Access doesn't maintain primary key order when users add, delete, or modify records after the database is compacted. If a table doesn't have a primary key, Microsoft Access copies records in the order that the records are stored on disk.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspReclaims unused space created by object and record deletions. When objects or rows are deleted from the database, the space they occupied is marked as available. However, the size of the database doesn't shrink unless the database is compacted.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspResets incrementing AutoNumber fields (called Counter fields in Microsoft Access versions 2.0 and earlier) so the next value allocated will be one more than the last undeleted record.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspRegenerates the table statistics used in the query optimization process. These statistics can become out-of-date over time, typically due to transactions that were rolled back or to the database not being closed properly.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspFlags all queries so that they will be recompiled the next time the query is run. This is important because database statistics can change, which could cause a previously compiled query to contain inaccurate optimization information.</p>
<p CLASS="Textttext">To compact your database, point to <span CLASS="ElementNameeln">Database Utilities</span> on the <span CLASS="ElementNameeln">Tools</span> menu and click <span CLASS="ElementNameeln">Compact Database</span>. If the database you want to compact is currently open, it will be closed, compacted into a temporary file, and then reopened. If no database is open, you must specify the database to compact and the database to compact into. If you specify the same file name to compact into, Microsoft Access compacts into a temporary file. When Microsoft Access compacts to a temporary file, it renames the temporary file back to the original file name once the compacting process is completed.
<p CLASS="Textttext">You can also use the <span CLASS="ElementNameeln">CompactDatabase</span> method of the <span CLASS="ElementNameeln">DBEngine</span> object to compact a database. When you use the <span CLASS="ElementNameeln">CompactDatabase</span> method, you must compact to a file with a different name. The following code example uses the<span CLASS="ElementNameeln"> CompactDatabase</span> method to compact a database to a temporary file and then renames that temporary file to the original name if the compacting process is successful.</p>
<p CLASS="CodeTextct">Sub CompactDB()<br>&nbsp;&nbsp;&amp;nbspOn Error GoTo CompactDB_Err<br>&nbsp;&nbsp;&amp;nbspConst conFilePath = &quot;C:\Program Files\Microsoft Office\Office\Samples\&quot;<br>&nbsp;&nbsp;&nbsp;' Compact the database to a temp file.<br>&nbsp;&nbsp;&amp;nbspDBEngine.CompactDatabase conFilePath &amp; &quot;Northwind.mdb&quot;, _<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspconFilePath &amp; &quot;NorthTemp.mdb&quot;<br>&nbsp;&nbsp;&nbsp;' Delete the previous backup file if it exists.<br>&nbsp;&nbsp;&amp;nbspIf Dir (conFilePath &amp; &quot;Northwind.bak&quot;) &lt;&gt; &quot;&quot; Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbspKill conFilePath &amp; &quot;Northwind.bak&quot;<br>&nbsp;&nbsp;&amp;nbspEnd If<br>&nbsp;&nbsp;&nbsp;' Rename the current database as backup and rename the temp file to<br>&nbsp;&nbsp;&nbsp;' the original file name.<br>&nbsp;&nbsp;&amp;nbspName conFilePath &amp; &quot;Northwind.mdb&quot; As conFilePath &amp; &quot;Northwind.bak&quot;<br>&nbsp;&nbsp;&amp;nbspName conFilePath &amp; &quot;NorthTemp.mdb&quot; As conFilePath &amp; &quot;Northwind.mdb&quot;<br>&nbsp;&nbsp;&amp;nbspMsgBox &quot;Compacting is complete&quot;<br>Exit_CompactDB:<br>&nbsp;&nbsp;&amp;nbspExit Sub<br>&nbsp;&nbsp;&nbsp;<br>CompactDB_Err:<br>&nbsp;&nbsp;&amp;nbspMsgBox Err.Description<br>&nbsp;&nbsp;&amp;nbspResume Exit_CompactDB<br>End Sub</p>
<p CLASS="Textttext">The <span CLASS="ElementNameeln">CompactDatabase</span> method also gives you the option of changing the encryption state, the version, and the disk or folder of a database while it's being compacted. In other words, you can choose to convert an encrypted database to a non-encrypted database, or vice versa.
<p CLASS="Textttext">For example, the following code compacts a database named Old and creates a new, encrypted database named New.</p>
<p CLASS="CodeTextct">DBEngine.CompactDatabase &quot;C:\Old.mdb&quot;, &quot;C:\New.mdb&quot;, _<br>&nbsp;&nbsp;&amp;nbspdbLangGeneral, dbEncrypt</p>
<p CLASS="CrossRefTextcrt"><span CLASS="CrossRefHeadingcrh">See Also&nbsp;&nbsp;&nbsp;</span>For more information on database encryption, see <a HREF="../chapters/ba14_3.htm" OnClick="SyncURL(&quot;chapters/ba14_3.htm&quot;)">&quot;Encrypting a Database&quot;</a> in Chapter 14, &quot;Securing Your Application.&quot;</p>
<p CLASS="NoteTextnt"><span CLASS="NoteHeadingnh">Note&nbsp;&nbsp;&nbsp;</span>Compacting cannot be done inside a transaction, or on a database that is currently open by another user.</p>
<a NAME="5ImportantConsiderationsWhenCompactingReplicatedDatabases"></a>
<p CLASS="heading5OrgHeading3h3">Important Considerations When Compacting Replicated Databases</p>
<p CLASS="Textttext">Replicated databases make extensive use of temporary space, especially when many design changes are made to an application. Just as with non-replicated databases, compacting regularly reduces file size and improves performance.
<p CLASS="Textttext">For optimal results, compact a replicated database twice. Compacting a replica the first time reclaims some space and flags other space as available for reclaiming later. Compacting a second time reclaims all available space. Compacting more than twice doesn't provide additional benefits.
<p CLASS="Textttext">Improperly compacting the Design Master of a replica set causes the replica set to lose its Design Master. When Microsoft Access opens a replica, it stores the name and location of the file in the database. The next time Microsoft Access opens the replica, it checks to see if the file has the same name and location. If so, then the file opens normally. If not, Microsoft Access gives the replica a new <span CLASS="ElementNameeln">ReplicaID</span> property value and, if the file was the Design Master, removes the Design Master flag. This prevents two replicas from having the same <span CLASS="ElementNameeln">ReplicaID</span> property value or a replica set from having two Design Masters.
<p CLASS="Textttext">To prevent a Design Master from losing its Design Master flag when you compact a replicated database, do one of the following:</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspOpen the Design Master database, and then click the <span CLASS="ElementNameeln">Compact Database</span> command on the <span CLASS="ElementNameeln">Database Utilities</span> submenu (<span CLASS="ElementNameeln">Tools</span> menu). When you do this, Microsoft Access compacts to a temporary file, and only deletes the original file and renames the temporary file to the original file name if the compact operation is successful.</p>
<p CLASS="ListBulletedItem1lb1"><img SRC="../images/bullet.jpg" WIDTH="5" HEIGHT="7">&amp;nbspIf you prefer to save the original file as a backup, close the Design Master database before you use the <span CLASS="ElementNameeln">Compact Database</span> command, specify the Design Master as the database to compact from, and then specify a temporary file name to compact into, but do not open the database with the <span CLASS="ElementNameeln">Open Database</span> command (<span CLASS="ElementNameeln">File</span> menu) until you have renamed the compacted database back to its original file name. This also applies if you are using the <span CLASS="ElementNameeln">CompactDatabase</span> method in code to compact. The <span CLASS="ElementNameeln">CompactDatabase</span> method requires you to compact to a new file name. In both cases, if you open the temporary database before you rename it back to its original file name, Microsoft Access removes the Design Master flag.</p>
<a NAME="4RepairingaDatabase"></a>
<p CLASS="heading4OrgHeading2h2">Repairing a Database</p>
<p CLASS="Textttext">If your database is damaged, close the database, then point to <span CLASS="ElementNameeln">Database Utilities</span> on the <span CLASS="ElementNameeln">Tools</span> menu and click <span CLASS="ElementNameeln">Repair Database</span>. You can also use the <span CLASS="ElementNameeln">RepairDatabase</span> method of the <span CLASS="ElementNameeln">DBEngine</span> object to repair your database. The <span CLASS="ElementNameeln">RepairDatabase</span> method checks all pages in the database for correct linkage, validates all system tables, and validates all indexes. Because the <span CLASS="ElementNameeln">RepairDatabase</span> method can't fix all possible forms of database corruption, you should back up your database files regularly to avoid unrecoverable data loss. This kind of corruption can occur when the system isn't shut down normally (such as during a power failure).
<p CLASS="Textttext">The <span CLASS="ElementNameeln">RepairDatabase</span> method takes only one argument, the name of the database file you want to repair. For example, to repair the Northwind database, use the following code:</p>
<p CLASS="CodeTextct">DBEngine.RepairDatabase &quot;C:\Program Files\Microsoft Office\Office&quot; _<br>&nbsp;&nbsp;&nbsp;&amp; &quot;\Samples\Northwind.mdb&quot;</p>
<p CLASS="Textttext">When a database is repaired, it may increase in size, because the process of creating indexes may leave some deleted pages in the database. It's always a good idea to compact the database after any repair to eliminate unnecessary pages.</p>
<p><!--DocFooterStart-->
<p><span CLASS="copyright"><a HREF="cpyright.htm">© 1996 Microsoft Corporation. All rights reserved.</a></span>
<p><!--DocFooterEnd-->
<a HREF="ba16_1.htm" OnClick="SyncURL(&quot;chapters/ba16_1.htm&quot;)"><img SRC="..\images\nextpage.gif" ALT="Next Page" ALIGN="RIGHT" BORDER="0"></a><!--mstheme--></font></body></html>
